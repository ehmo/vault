Implement the following plan:

# Fix Media Viewer Issues

## Context
After the VaultViewModel extraction, multiple media viewer bugs surfaced: filter defaulting, image/video centering, video aspect ratio corruption during conversion, and broken zoom. These are regression bugs in the media viewer stack.

## Issues & Root Causes

### 1. Filter defaults to media with documents present
**File:** `VaultViewModel.swift` lines 186-191
**Cause:** `loadFiles()` only switches `.all` -> `.media` when vault has only media. If filter was persisted as `.media` from a previous session and user later added documents, it stays `.media` on reload because check requires `fileFilter == .all`.
**Fix:** Add reverse check: if `fileFilter == .media` AND documents exist, switch to `.all`.

### 2. Image pushed up instead of centered
**File:** `FullScreenPhotoViewer.swift`
**Cause:** `GeometryReader` respects safe areas, so `geometry.size` excludes notch (~60pt) and home indicator (~34pt). Image is centered within safe area zone, not the full screen. Since notch > home indicator, the visual center is below the safe-area center, making the image appear pushed up.
**Fix:** Use `.ignoresSafeArea()` on the content or calculate centering relative to the full screen.

### 3. Video aspect ratio corrupted during conversion
**File:** `MediaOptimizer.swift` lines 192-214
**Cause:** Transform applied TWICE:
1. `targetVideoSize()` applies `preferredTransform` to `naturalSize` to compute writer dimensions (portrait 1920x1080 -> 1080x1920)
2. `videoWriterInput.transform = preferredTransform` embeds the same rotation again
Result: writer configured for 1080x1920, but raw pixel buffers are 1920x1080, PLUS rotation metadata applied again.
**Fix:** Use `naturalSize` directly for writer dimensions (don't apply transform in `targetVideoSize`), keep `videoWriterInput.transform = preferredTransform`. Pixel buffers will match writer dimensions, and transform metadata tells player how to orient.

### 4. Zoom image thrown around screen
**File:** `ZoomableImageContainer.swift` lines 100-111
**Cause:** `centerImageView` uses `contentSize * zoomScale` but UIScrollView auto-updates `contentSize` to `imageView.frame.size` (already zoomed) during zoom. This double-counts zoomScale: `fittedSize * zoom * zoom` instead of `fittedSize * zoom`.
**Fix:** Use `imageView.frame.size` directly (standard Apple approach) instead of `contentSize * zoomScale`.

## Implementation

### A. VaultViewModel.swift
In `loadFiles()` auto-detect logic, change:
```swift
if !items.isEmpty && self.fileFilter == .all {
    let hasNonMedia = items.contains { !$0.isMedia }
    if !hasNonMedia { self.setFileFilter(.media) }
}
```
To:
```swift
if !items.isEmpty {
    let hasNonMedia = items.contains { !$0.isMedia }
    if !hasNonMedia && self.fileFilter == .all {
        self.setFileFilter(.media)
    } else if hasNonMedia && self.fileFilter == .media {
        self.setFileFilter(.all)
    }
}
```

### B. ZoomableImageContainer.swift
Replace `centerImageView`:
```swift
static func centerImageView(_ imageView: UIImageView, in scrollView: UIScrollView) {
    let boundsSize = scrollView.bounds.size
    let frameSize = imageView.frame.size
    let xOffset = max(0, (boundsSize.width - frameSize.width) / 2)
    let yOffset = max(0, (boundsSize.height - frameSize.height) / 2)
    imageView.center = CGPoint(
        x: frameSize.width / 2 + xOffset,
        y: frameSize.height / 2 + yOffset
    )
}
```

### C. FullScreenPhotoViewer.swift
Add `.ignoresSafeArea()` to the photo paging content so images are centered on the full screen, not just the safe area zone. The controls overlay already handles safe areas independently with gradient backgrounds.

### D. MediaOptimizer.swift
In `targetVideoSize`, don't apply the transform to compute dimensions. Use naturalSize directly (with even-number rounding and max 1920 capping). Keep `videoWriterInput.transform = preferredTransform` for orientation metadata.

Change `targetVideoSize`:
```swift
private static func targetVideoSize(from naturalSize: CGSize, transform: CGAffineTransform) -> (width: Int, height: Int) {
    // Use naturalSize directly — the writer transform handles orientation
    let w = naturalSize.width
    let h = naturalSize.height
    let maxDim = max(w, h)
    // ... same capping/rounding logic ...
}
```

### E. Tests
1. **MediaOptimizerTests:** Add test for portrait video with rotation transform to verify output dimensions match naturalSize (not transformed)
2. **ZoomableImageContainer centering test:** Verify centering at various zoom levels
3. **VaultViewModel filter test:** Verify filter auto-detection with mixed file types

## Files to Modify
- `apps/ios/Vault/Features/VaultViewer/VaultViewModel.swift`
- `apps/ios/Vault/Features/VaultViewer/ZoomableImageContainer.swift`
- `apps/ios/Vault/Features/VaultViewer/FullScreenPhotoViewer.swift`
- `apps/ios/Vault/Core/Storage/MediaOptimizer.swift`
- `apps/ios/VaultTests/MediaOptimizerTests.swift` (add portrait video test)

## Verification
1. Build succeeds with no new warnings
2. All 394+ existing tests pass
3. New tests pass
4. Manual: open vault with mixed media/documents -> filter shows "All"
5. Manual: open image -> centered on screen, not pushed up
6. Manual: pinch-to-zoom on image -> smooth, stays centered
7. Manual: open video -> correct aspect ratio, centered
8. Push to TestFlight build 83


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/nan/.REDACTED.jsonl

---

Base directory for this skill: /Users/nan/.claude/skills/xcodebuildmcp

# XcodeBuildMCP

Prefer XcodeBuildMCP over raw `xcodebuild`, `xcrun`, or `simctl`.

If a capability is missing, assume your tool list may be hiding tools (search/progressive disclosure) or not loading tool schemas yet. Use your tool-search or “load tools” mechanism. If you still can’t find the tools, ask the user to enable them in the MCP client's configuration.

## Tools (exact names + official descriptions)

### Session defaults

Before you call any other tools, you **must** call `session_show_defaults` to show the current defaults, ensure you then fill in the appropriate missing defaults. You may need to call one or more discovery/list tools to obtain the values needed.

- `session_set_defaults`
  - Set the session defaults, should be called at least once to set tool defaults.
- `session_show_defaults`
  - Show session defaults.
- `session_clear_defaults`
  - Clear session defaults.

### Project discovery

- `discover_projs`
  - Scans a directory (defaults to workspace root) to find Xcode project (.xcodeproj) and workspace (.xcworkspace) files.
- `list_schemes`
  - List Xcode schemes.
- `show_build_settings`
  - Show build settings.
- `get_app_bundle_id`
  - Extract bundle id from .app.
- `get_mac_bundle_id`
  - Extract bundle id from macOS .app.

### Simulator

- `boot_sim`
  - Boot iOS simulator.
- `list_sims`
  - List iOS simulators.
- `open_sim`
  - Open Simulator app.
- `build_sim`
  - Build for iOS sim.
- `build_run_sim`
  - Build and run iOS sim.
- `test_sim`
  - Test on iOS sim.
- `get_sim_app_path`
  - Get sim built app path.
- `install_app_sim`
  - Install app on sim.
- `launch_app_sim`
  - Launch app on simulator.
- `launch_app_logs_sim`
  - Launch sim app with logs.
- `stop_app_sim`
  - Stop sim app.
- `record_sim_video`
  - Record sim video.

### Simulator management

- `erase_sims`
  - Erase simulator.
- `set_sim_location`
  - Set sim location.
- `reset_sim_location`
  - Reset sim location.
- `set_sim_appearance`
  - Set sim appearance.
- `sim_statusbar`
  - Set sim status bar network.

### Device

- `list_devices`
  - List connected devices.
- `build_device`
  - Build for device.
- `test_device`
  - Test on device.
- `get_device_app_path`
  - Get device built app path.
- `install_app_device`
  - Install app on device.
- `launch_app_device`
  - Launch app on device.
- `stop_app_device`
  - Stop device app.

### macOS

- `build_macos`
  - Build macOS app.
- `build_run_macos`
  - Build and run macOS app.
- `test_macos`
  - Test macOS target.
- `get_mac_app_path`
  - Get macOS built app path.
- `launch_mac_app`
  - Launch macOS app.
- `stop_mac_app`
  - Stop macOS app.

### Logging

- `start_device_log_cap`
  - Start device log capture.
- `start_sim_log_cap`
  - Start sim log capture.
- `stop_device_log_cap`
  - Stop device log capture.
- `stop_sim_log_cap`
  - Stop sim log capture.

### Debugging

- `debug_attach_sim`
  - Attach LLDB to sim app.
- `debug_breakpoint_add`
  - Add breakpoint.
- `debug_breakpoint_remove`
  - Remove breakpoint.
- `debug_continue`
  - Continue debug session.
- `debug_detach`
  - Detach debugger.
- `debug_lldb_command`
  - Run LLDB command.
- `debug_stack`
  - Get backtrace.
- `debug_variables`
  - Get frame variables.

### UI automation

- `button`
  - Press simulator hardware button.
- `gesture`
  - Simulator gesture preset.
- `key_press`
  - Press key by keycode.
- `key_sequence`
  - Press a sequence of keys by their keycodes.
- `long_press`
  - Long press at coords.
- `screenshot`
  - Capture screenshot.
- `snapshot_ui`
  - Print view hierarchy with precise view coordinates (x, y, width, height) for visible elements.
- `swipe`
  - Swipe between points.
- `tap`
  - Tap coordinate or element.
- `touch`
  - Touch down/up at coords.
- `type_text`
  - Type text.

### SwiftPM

- `swift_package_build`
  - swift package target build.
- `swift_package_clean`
  - swift package clean.
- `swift_package_list`
  - List SwiftPM processes.
- `swift_package_run`
  - swift package target run.
- `swift_package_stop`
  - Stop SwiftPM run.
- `swift_package_test`
  - Run swift package target tests.

### Scaffolding / utilities

- `scaffold_ios_project`
  - Scaffold iOS project.
- `scaffold_macos_project`
  - Scaffold macOS project.
- `clean`
  - Clean build products.

### Diagnostics

- `doctor`
  - MCP environment info.
- `manage_workflows`
  - Workflows are groups of tools exposed by XcodeBuildMCP. By default, not all workflows (and therefore tools) are enabled; only simulator tools are enabled by default. Some workflows are mandatory and can't be disabled.