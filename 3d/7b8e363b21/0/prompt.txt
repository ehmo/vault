Implement the following plan:

# Plan: File Optimization/Compression During Import

## Context

Vault files are stored at full original size, consuming significant storage. Research shows 80%+ reduction is achievable at high visual quality using modern codecs (HEIC for images, HEVC for video). This warrants a simple two-option setting: **Optimized** (default) vs **Original**.

## Design: Two Options

Research confirms ≥80% reduction at high quality:
- **Images**: HEIC at quality 0.6 via `CGImageDestination` → 75-85% smaller, visually identical
- **Videos**: HEVC 1080p via `AVAssetExportSession` → 85-90% smaller, excellent quality
- **Other files** (PDF, docs, ZIP): Pass through unchanged — no reliable compression without quality loss

Setting: `@AppStorage("fileOptimization")` with values `"optimized"` (default) / `"original"`

## Implementation

### 1. New file: `apps/ios/Vault/Core/Storage/MediaOptimizer.swift`

Actor with two public methods:

```swift
actor MediaOptimizer {
    static let shared = MediaOptimizer()

    enum Mode: String { case optimized, original }

    /// Returns (outputURL, outputMimeType, wasOptimized)
    /// If wasOptimized, caller must delete temp file after use
    func optimize(fileURL: URL, mimeType: String, mode: Mode) async throws -> (URL, String, Bool)

    /// For UIImage from camera — writes HEIC to temp file (avoids jpegData memory spike)
    func optimizeImage(_ image: UIImage, mode: Mode) async throws -> (URL, String)
}
```

**Image pipeline** (HEIC via ImageIO, file-to-file):
1. `CGImageSourceCreateWithURL` from source
2. If >4096px on long edge: `CGImageSourceCreateThumbnailAtIndex` to downsample
3. `CGImageDestinationCreateWithURL` → write HEIC at quality 0.6
4. Skip if source is already HEIC. Skip non-image types.
5. Peak memory: ~20-50MB (one image bitmap)

**Video pipeline** (HEVC via AVFoundation):
1. `AVURLAsset` from source
2. `AVAssetExportSession(asset:, presetName: AVAssetExportPresetHEVC1920x1080)`
3. Export to temp `.mp4`
4. Skip if source is already HEVC at ≤1080p
5. Peak memory: ~30-80MB (stream-based, independent of video length)

**Passthrough**: Non-media files return input URL with `wasOptimized = false`

### 2. Modify: `apps/ios/Vault/Features/Settings/SettingsView.swift`

Add "Storage" section to AppSettingsView with a Picker:
- **Optimized** (default): "Reduces file sizes by up to 85%. Uses HEIC for images and HEVC for videos."
- **Original**: "Keeps files at original size and format. Uses significantly more storage."

### 3. Modify: `apps/ios/Vault/Features/VaultViewer/VaultView+Actions.swift`

Read `@AppStorage("fileOptimization")` and pass mode to optimizer.

**`handleCapturedImage`** (camera):
- Current: `image.jpegData(compressionQuality: 0.8)` → `storeFile(data:)` (loads ~48MB bitmap into Data)
- New: `MediaOptimizer.optimizeImage(image, mode:)` → temp HEIC file → `storeFileFromURL` (streaming encryption, bounded memory)

**`performPhotoImport`** (photo picker):
- Images: Write UIImage to temp file → `MediaOptimizer.optimize(fileURL:)` → `storeFileFromURL`
- Videos: `MediaOptimizer.optimize(fileURL:)` → `storeFileFromURL` (already URL-based)

**`performFileImport`** (file picker):
- Videos: `MediaOptimizer.optimize(fileURL:)` → `storeFileFromURL`
- Other: Pass through to `storeFileFromURL` unchanged

### 4. Modify: `apps/ios/Vault/Core/Storage/ImportIngestor.swift`

In `processImport`: optimize staged file before `storeFileFromURL`. Read mode from `UserDefaults.standard.string(forKey: "fileOptimization")` (can't use @AppStorage in non-view).

### 5. Filename/mimeType updates

When optimized (e.g., `.jpg` → `.heic`, `.mov` → `.mp4`), update stored `filename` extension and `mimeType` to reflect actual format. Use the `outputMimeType` returned by optimizer.

## Files Changed

| File | Change |
|------|--------|
| `Core/Storage/MediaOptimizer.swift` | **NEW** — HEIC/HEVC optimization actor |
| `Features/Settings/SettingsView.swift` | Add Storage section with optimization picker |
| `Features/VaultViewer/VaultView+Actions.swift` | Route imports through optimizer, fix camera memory |
| `Core/Storage/ImportIngestor.swift` | Optimize staged files before encryption |

## Verification

1. Build succeeds with no warnings in project code
2. Import a 12MP JPEG → stored as HEIC, file ~75-85% smaller
3. Import a 4K MOV → stored as HEVC 1080p MP4, ~85-90% smaller
4. Import a PDF → stored unchanged
5. Toggle setting to "Original" → files stored as-is, original size
6. Camera capture → HEIC file, no 48MB jpegData memory spike
7. Memory stays bounded during batch imports (check with Instruments)
8. Existing tests pass


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/nan/.REDACTED.jsonl

---

Base directory for this skill: /Users/nan/.claude/skills/xcodebuildmcp

# XcodeBuildMCP

Prefer XcodeBuildMCP over raw `xcodebuild`, `xcrun`, or `simctl`.

If a capability is missing, assume your tool list may be hiding tools (search/progressive disclosure) or not loading tool schemas yet. Use your tool-search or “load tools” mechanism. If you still can’t find the tools, ask the user to enable them in the MCP client's configuration.

## Tools (exact names + official descriptions)

### Session defaults

Before you call any other tools, you **must** call `session_show_defaults` to show the current defaults, ensure you then fill in the appropriate missing defaults. You may need to call one or more discovery/list tools to obtain the values needed.

- `session_set_defaults`
  - Set the session defaults, should be called at least once to set tool defaults.
- `session_show_defaults`
  - Show session defaults.
- `session_clear_defaults`
  - Clear session defaults.

### Project discovery

- `discover_projs`
  - Scans a directory (defaults to workspace root) to find Xcode project (.xcodeproj) and workspace (.xcworkspace) files.
- `list_schemes`
  - List Xcode schemes.
- `show_build_settings`
  - Show build settings.
- `get_app_bundle_id`
  - Extract bundle id from .app.
- `get_mac_bundle_id`
  - Extract bundle id from macOS .app.

### Simulator

- `boot_sim`
  - Boot iOS simulator.
- `list_sims`
  - List iOS simulators.
- `open_sim`
  - Open Simulator app.
- `build_sim`
  - Build for iOS sim.
- `build_run_sim`
  - Build and run iOS sim.
- `test_sim`
  - Test on iOS sim.
- `get_sim_app_path`
  - Get sim built app path.
- `install_app_sim`
  - Install app on sim.
- `launch_app_sim`
  - Launch app on simulator.
- `launch_app_logs_sim`
  - Launch sim app with logs.
- `stop_app_sim`
  - Stop sim app.
- `record_sim_video`
  - Record sim video.

### Simulator management

- `erase_sims`
  - Erase simulator.
- `set_sim_location`
  - Set sim location.
- `reset_sim_location`
  - Reset sim location.
- `set_sim_appearance`
  - Set sim appearance.
- `sim_statusbar`
  - Set sim status bar network.

### Device

- `list_devices`
  - List connected devices.
- `build_device`
  - Build for device.
- `test_device`
  - Test on device.
- `get_device_app_path`
  - Get device built app path.
- `install_app_device`
  - Install app on device.
- `launch_app_device`
  - Launch app on device.
- `stop_app_device`
  - Stop device app.

### macOS

- `build_macos`
  - Build macOS app.
- `build_run_macos`
  - Build and run macOS app.
- `test_macos`
  - Test macOS target.
- `get_mac_app_path`
  - Get macOS built app path.
- `launch_mac_app`
  - Launch macOS app.
- `stop_mac_app`
  - Stop macOS app.

### Logging

- `start_device_log_cap`
  - Start device log capture.
- `start_sim_log_cap`
  - Start sim log capture.
- `stop_device_log_cap`
  - Stop device log capture.
- `stop_sim_log_cap`
  - Stop sim log capture.

### Debugging

- `debug_attach_sim`
  - Attach LLDB to sim app.
- `debug_breakpoint_add`
  - Add breakpoint.
- `debug_breakpoint_remove`
  - Remove breakpoint.
- `debug_continue`
  - Continue debug session.
- `debug_detach`
  - Detach debugger.
- `debug_lldb_command`
  - Run LLDB command.
- `debug_stack`
  - Get backtrace.
- `debug_variables`
  - Get frame variables.

### UI automation

- `button`
  - Press simulator hardware button.
- `gesture`
  - Simulator gesture preset.
- `key_press`
  - Press key by keycode.
- `key_sequence`
  - Press a sequence of keys by their keycodes.
- `long_press`
  - Long press at coords.
- `screenshot`
  - Capture screenshot.
- `snapshot_ui`
  - Print view hierarchy with precise view coordinates (x, y, width, height) for visible elements.
- `swipe`
  - Swipe between points.
- `tap`
  - Tap coordinate or element.
- `touch`
  - Touch down/up at coords.
- `type_text`
  - Type text.

### SwiftPM

- `swift_package_build`
  - swift package target build.
- `swift_package_clean`
  - swift package clean.
- `swift_package_list`
  - List SwiftPM processes.
- `swift_package_run`
  - swift package target run.
- `swift_package_stop`
  - Stop SwiftPM run.
- `swift_package_test`
  - Run swift package target tests.

### Scaffolding / utilities

- `scaffold_ios_project`
  - Scaffold iOS project.
- `scaffold_macos_project`
  - Scaffold macOS project.
- `clean`
  - Clean build products.

### Diagnostics

- `doctor`
  - MCP environment info.
- `manage_workflows`
  - Workflows are groups of tools exposed by XcodeBuildMCP. By default, not all workflows (and therefore tools) are enabled; only simulator tools are enabled by default. Some workflows are mandatory and can't be disabled.

---

Run all tests and write new ones based on the need to test this update. Then push to testlight