# Scratch Pad — Continual Learning Log

## Session Log

### Session 1 — UX Design Audit Implementation (Feb 8, 2026)
- **Query**: Implement 11-workstream UX design audit plan (WS1-WS11) across the Vaultaire iOS app
- **Approach**: Sequential workstream implementation with build verification and git commit after each
- **Errors**:
  - `.foregroundStyle(.accentColor)` fails — `ShapeStyle` has no member `accentColor`. Fix: use `Color.accentColor`
  - `bd update ○` failed — passed status indicator character instead of issue ID. Fix: use `bd list` to get actual ID
- **Corrections**: None from user — autonomous implementation
- **Key Learnings**:
  - Codable optionals (`Date?`) provide backward compat for existing vault indexes without migration
  - When adding files to pbxproj manually, use `UX` prefix IDs for UX-related additions (consistent with `LA`, `SE` prefixes)
  - `SubscriptionManager.maxFreeFilesPerVault` is a static constant (100) — reference directly, don't duplicate the value
  - Date grouping with photo viewer requires computing global index across all sorted images, not per-group index

### Session 2 — Share Upload Failure Fix (Feb 8, 2026)
- **Query**: Vault share fails with "shared vault couldn't be completed" after CloudKit upload starts
- **Approach**: Traced upload flow through ShareVaultView → BackgroundShareTransferManager → CloudKitSharingManager. Identified two root causes.
- **Root Causes**:
  - No `UIApplication.beginBackgroundTask()` — iOS suspends app when user dismisses share sheet, killing the in-flight CloudKit upload. Telemetry showed only 3 Live Activity ticks (~0.5s) before silence = classic iOS suspension.
  - No retry on transient CKErrors — a single network hiccup on any of 9 sequential chunk saves causes immediate failure.
- **Fix**: Added `beginBackgroundTask`/`endBackgroundTask` wrapping both upload and import `Task.detached` closures. Added `saveWithRetry()` with 3 retries + exponential backoff for transient CKErrors (networkFailure, serviceUnavailable, zoneBusy, requestRateLimited).
- **Key Learnings**:
  - `Task.detached` does NOT get background execution time — iOS can suspend it immediately when app backgrounds
  - `CKDatabase.save()` convenience API has no QoS/timeout config — for production use, consider `CKModifyRecordsOperation`
  - `CKError.retryAfterSeconds` provides server-suggested retry delay — always respect it before falling back to exponential backoff
  - The upload flow: BackgroundShareTransferManager orchestrates (re-encrypt files → plist encode → CloudKitSharingManager uploads chunks sequentially → saves manifest)

---

## Error Tracker

- **ShapeStyle vs Color**: `.foregroundStyle(.accentColor)` doesn't compile — `accentColor` is on `Color`, not `ShapeStyle`. Always use `Color.accentColor` or `.tint(.accentColor)`.
- **Beads ID parsing**: `bd` commands need the actual issue ID (e.g., `VAULT-5vs`), not display characters. Always run `bd list` first if unsure.
- **SourceKit false positives**: Cross-file SourceKit diagnostics ("Cannot find X in scope") are common in this project and don't represent real build errors. Trust `xcodebuild` results over editor diagnostics.
- **Task.detached + backgrounding = suspension**: iOS will suspend `Task.detached` closures when the app backgrounds. Any long-running work (CloudKit uploads, network calls) MUST be wrapped in `beginBackgroundTask`/`endBackgroundTask`.
- **No retry on CloudKit saves**: `CKDatabase.save()` has no built-in retry. Transient errors (network hiccups, rate limits) cause immediate failure. Always wrap in retry logic.

---

## Corrections and Preferences

- **Commit frequency**: User prefers commit + push after every successful build. Don't accumulate changes.
- **Beads tracking**: Use beads for multi-session work, TodoWrite for single-session tasks.
- **Plan mode**: Make plans extremely concise. Sacrifice grammar for brevity.
- **Subagent model**: Always use opus model for subagents.

---

## Anticipated Improvements

- Always wrap `Color.accentColor` (not bare `.accentColor`) in `.foregroundStyle()` calls
- Run `bd list` before closing issues to confirm IDs exist
- When adding optional fields to Codable structs, always provide default `nil` in init for backward compat
- When modifying grid views that feed into a full-screen viewer, verify the index mapping is global not local

---

## Cumulative Learnings

- **Session count**: 2
- **Build success rate**: 12/12 (Session 2: 1/1 first-attempt)
- **Key pattern**: Sequential workstream implementation with build gates works well for large multi-file UX changes
- **Architecture insight**: This codebase uses a 3-tier file model (VaultFileItem → LightweightFileEntry → VaultFileEntry) — changes to file metadata must propagate through all three
- **Sharing architecture**: BackgroundShareTransferManager (@MainActor, @Observable) → Task.detached for crypto work → CloudKitSharingManager for CloudKit ops. All crypto keys captured by value to survive vault lock.
