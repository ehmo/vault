# Scratch Pad — Continual Learning Log

## Session Log

### Session 1 — UX Design Audit Implementation (Feb 8, 2026)
- **Query**: Implement 11-workstream UX design audit plan (WS1-WS11) across the Vaultaire iOS app
- **Approach**: Sequential workstream implementation with build verification and git commit after each
- **Errors**:
  - `.foregroundStyle(.accentColor)` fails — `ShapeStyle` has no member `accentColor`. Fix: use `Color.accentColor`
  - `bd update ○` failed — passed status indicator character instead of issue ID. Fix: use `bd list` to get actual ID
- **Corrections**: None from user — autonomous implementation
- **Key Learnings**:
  - Codable optionals (`Date?`) provide backward compat for existing vault indexes without migration
  - When adding files to pbxproj manually, use `UX` prefix IDs for UX-related additions (consistent with `LA`, `SE` prefixes)
  - `SubscriptionManager.maxFreeFilesPerVault` is a static constant (100) — reference directly, don't duplicate the value
  - Date grouping with photo viewer requires computing global index across all sorted images, not per-group index

### Session 2 — Share Upload Failure Fix (Feb 8, 2026)
- **Query**: Vault share fails with "shared vault couldn't be completed" after CloudKit upload starts
- **Approach**: Traced upload flow through ShareVaultView → BackgroundShareTransferManager → CloudKitSharingManager. Identified two root causes.
- **Root Causes**:
  - No `UIApplication.beginBackgroundTask()` — iOS suspends app when user dismisses share sheet, killing the in-flight CloudKit upload. Telemetry showed only 3 Live Activity ticks (~0.5s) before silence = classic iOS suspension.
  - No retry on transient CKErrors — a single network hiccup on any of 9 sequential chunk saves causes immediate failure.
- **Fix**: Added `beginBackgroundTask`/`endBackgroundTask` wrapping both upload and import `Task.detached` closures. Added `saveWithRetry()` with 3 retries + exponential backoff for transient CKErrors (networkFailure, serviceUnavailable, zoneBusy, requestRateLimited).
- **Key Learnings**:
  - `Task.detached` does NOT get background execution time — iOS can suspend it immediately when app backgrounds
  - `CKDatabase.save()` convenience API has no QoS/timeout config — for production use, consider `CKModifyRecordsOperation`
  - `CKError.retryAfterSeconds` provides server-suggested retry delay — always respect it before falling back to exponential backoff
  - The upload flow: BackgroundShareTransferManager orchestrates (re-encrypt files → plist encode → CloudKitSharingManager uploads chunks sequentially → saves manifest)

### Session 3 — Incremental Sync for Shared Vaults (Feb 9, 2026)
- **Query**: Implement SVDF v4 incremental sync — adding 1 file to shared vault was re-encrypting and re-uploading ALL files
- **Approach**: 4-layer optimization: (1) append-stable binary format (SVDFSerializer), (2) per-share encrypted file cache (ShareSyncCache), (3) chunk-hash diffing in CloudKit upload, (4) recipient delta import
- **Files created**: SVDFSerializer.swift, ShareSyncCache.swift
- **Files modified**: ShareSyncManager.swift (replaced full rebuild with incremental), CloudKitSharingManager.swift (added syncSharedVaultIncremental), BackgroundShareTransferManager.swift (SVDF v4 for initial upload + cache init), VaultView.swift (delta import for SVDF, legacy fallback for v1-v3), VaultStorage.swift (syncSequence on ShareRecord)
- **Errors**: None — first-attempt build success
- **Key Learnings**:
  - Duplicate simulator names cause `xcodebuild` ambiguity — use `-destination 'platform=iOS Simulator,id=<UUID>'` instead of `name=`
  - Sharing group in pbxproj uses `014000xxx` prefix IDs
  - VaultFileEntry has optional `filename`, `mimeType`, `createdAt` — always provide fallback values when building SharedFile from entries
  - Binary format with little-endian encoding requires careful cursor tracking; `Data.readUInt32(at:)` helpers avoid raw pointer arithmetic
  - CloudKit deterministic record IDs (`{shareVaultId}_chunk_{index}`) allow update-in-place without delete+create

---

## Error Tracker

- **ShapeStyle vs Color**: `.foregroundStyle(.accentColor)` doesn't compile — `accentColor` is on `Color`, not `ShapeStyle`. Always use `Color.accentColor` or `.tint(.accentColor)`.
- **Beads ID parsing**: `bd` commands need the actual issue ID (e.g., `VAULT-5vs`), not display characters. Always run `bd list` first if unsure.
- **SourceKit false positives**: Cross-file SourceKit diagnostics ("Cannot find X in scope") are common in this project and don't represent real build errors. Trust `xcodebuild` results over editor diagnostics.
- **@MainActor singleton calls need `await`**: `ShareSyncManager`, `BackgroundShareTransferManager`, `DeepLinkHandler` are all `@MainActor`. Calling their methods from `Task { }` or `Task.detached { }` requires `await` — Swift 6 strict concurrency treats cross-actor calls as implicitly async. This has regressed multiple times. Prevention: ALWAYS add `await` when calling any `@MainActor` singleton method from inside `Task`/`Task.detached` blocks. Check ALL three `scheduleSync` call sites when modifying import handlers.
- **Task.detached + backgrounding = suspension**: iOS will suspend `Task.detached` closures when the app backgrounds. Any long-running work (CloudKit uploads, network calls) MUST be wrapped in `beginBackgroundTask`/`endBackgroundTask`.
- **Embrace setup off main queue can crash**: `Embrace.setup(...).start()` executed inside `Task.detached` triggered `dispatch_assert_queue` in `HangCaptureService.init` during onboarding analytics opt-in. Prevention: run Embrace setup/start on `@MainActor` only.
- **No retry on CloudKit saves**: `CKDatabase.save()` has no built-in retry. Transient errors (network hiccups, rate limits) cause immediate failure. Always wrap in retry logic.
- **CKRecord INSERT vs UPDATE**: `CKRecord(recordType:recordID:)` creates a NEW record object. `save()` on it attempts INSERT, failing with `serverRecordChanged` (code 14) if record exists. To UPDATE, must FETCH the existing record first via `publicDatabase.record(for:)`, modify its fields, then save. This is critical for incremental chunk updates.
- **Initial upload → sync cache gap**: `uploadSharedVault()` creates chunks in CloudKit but doesn't initialize `ShareSyncCache`. First `syncSharedVaultIncremental()` call sees empty `previousChunkHashes` → tries INSERT on all existing chunks → CKError 14. Prevention: always fetch-or-create before save.
- **deinit + [weak self] = crash**: `[weak self]` in closures dispatched from `deinit` causes "Cannot form weak reference to instance in process of deallocation". Prevention: capture specific properties by value, not `self`.
- **SwiftUI animation leak in ZStack**: `.animation(_:value:)` on one child in a ZStack can affect siblings. Prevention: isolate animated elements in separate overlays.
- **Background task async endBackgroundTask**: `Task { @MainActor in UIApplication.shared.endBackgroundTask(id) }` inside `defer` may never execute when the app is being suspended. Prevention: use `MainActor.assumeIsolated` in the expiration handler to call `endBackgroundTask` synchronously. Store `bgTaskId` as a property with an idempotent `endBackgroundExecution()` helper.
- **Orphaned background task IDs**: Calling `beginBackgroundTask` multiple times without ending old ones leaks task IDs. Prevention: always call `endBackgroundExecution()` before `beginBackgroundTask`, and store only one `currentBgTaskId`.
- **UI only showing happy-path status**: Showing UI only for `.uploading` but not `.uploadFailed`/`.uploadComplete` means the user sees nothing when things fail. Prevention: always handle ALL non-idle enum cases in status UI.
- **Stale simulator UUID**: Simulator UUIDs get invalidated when Xcode/simulators update. `xcodebuild test -destination 'id=<UUID>'` fails with "Unable to boot deleted device". Prevention: run `xcrun simctl list devices available` to find currently booted/available simulators.
- **Duplicate simulator names break destination by name**: `xcodebuild ... -destination 'name=iPhone 17 Pro'` can fail if two simulators differ only by casing (e.g. `iPhone 17 Pro` and `iphone 17 pro`). Prevention: use destination by explicit simulator UUID (`id=<UUID>`).
- **Maestro can't always target SwiftUI TextEditor by id**: `TextEditor` can fail `id` matching in sheet contexts even when `.accessibilityIdentifier` is set. Prevention: use `tapOn: point` to focus the editor before `inputText`.
- **Maestro `addMedia` no parent paths**: `addMedia` resolves paths relative to the YAML file but does NOT support `../` parent traversal. Prevention: place test media in the same directory or use symlinks.
- **Maestro `wait`/`clearInput` don't exist**: No `wait: N` command (use `waitForAnimationToEnd: timeout: N000`), no `clearInput` (use `eraseText: charactersToErase: N`).
- **Maestro `clearState` resets UserDefaults**: `clearState: true` wipes ALL UserDefaults including `hasCompletedOnboarding`. Prevention: re-set required defaults in test mode init.
- **Maestro `clearKeychain` triggers system dialog**: Apple Account Verification dialog blocks automation. Prevention: remove `clearKeychain: true`, add dismiss taps for "Not Now".
- **Empty state hides FAB**: `vault_add_button` only visible when files exist. Prevention: use `vault_first_files` (empty state) or `-MAESTRO_SEED_FILES` to pre-populate vault.
- **@MainActor static Logger in nonisolated context**: `private static let logger` on a `@MainActor` class cannot be accessed from `nonisolated static` methods — Swift 6 error, Swift 5 warning. Prevention: use file-level `private let logger` outside the class for any class that has `nonisolated` methods.
- **Bare VaultIndex init = no master key**: `VaultIndex(files:nextOffset:totalSize:)` (v1 init) creates index without `encryptedMasterKey`. Saving this then calling `storeFile` throws `corruptedData` because `getMasterKey` finds nil. Prevention: ALWAYS use `VaultStorage.shared.loadIndex(with:)` for new vault creation — it auto-creates proper v3 index with master key + blob.
- **xcodebuild archive + Automatic signing + no devices = fail**: Automatic signing tries to create Development profiles (which need devices) even for Release/distribution archive. Prevention: use Manual signing for Release configs with `CODE_SIGN_IDENTITY[sdk=iphoneos*]` = "Apple Distribution" and `PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]` = profile name.
- **Sentry build phase cycle**: Sentry dSYM upload script BEFORE Embed Foundation Extensions creates dependency cycle (dSYM input → built binary → embedded extensions → Info.plist → cycle). Prevention: always place Sentry script AFTER Embed Foundation Extensions in build phases.
- **TestFlight tester invite before group has build**: `asc testflight beta-testers invite` fails with "no installable builds" until `asc builds add-groups` assigns a build to the group. Prevention: add build to group first, then invite testers.
- **macOS keychain import with empty p12 password**: `security import` with `-P ""` fails. Prevention: use `openssl pkcs12 -legacy` with a temp password, then import with that password.
- **Incomplete screen cloning**: When replicating a flow from another screen (e.g., join vault pattern from onboarding pattern), copying only the core logic but missing validation, haptics, error handling, and feedback UI creates a degraded UX. Prevention: always mirror the FULL behavior including all user feedback paths.
- **Removing "flashing" UI removes essential feedback**: User asked to remove validation feedback that "showed for a split second" on ChangePatternView. Removed the entire `validationResult` + `validationFeedback`, which also removed error display for invalid patterns. The flash was because valid patterns immediately transition — invalid patterns need the feedback to stay visible. Prevention: when UI "flashes", the fix is usually to prevent the auto-transition (or accept the flash), NOT to remove the feature. Always check: does this UI serve a purpose when the user stays on the screen?
- **Pattern grid position jumping between steps**: Different subtitle text lengths, different button counts, and presence/absence of feedback area changed Spacer distribution, moving the grid. Prevention: ALL variable-content areas in pattern screens need fixed heights — subtitle `.frame(height: 44)`, feedback `Group.frame(height: 80)`, buttons use `.hidden()` placeholders for consistent height.
- **Missing Maestro tests for UI changes**: Visual changes without corresponding Maestro test updates means regressions go undetected. Prevention: mandatory checklist in AGENTS.md — new screens need flows, new elements need accessibility IDs + assertions.
- **TestFlight internal groups can't be manually assigned builds**: `asc builds add-groups` fails with "Cannot add internal group to a build." Internal groups with `hasAccessToAllBuilds: true` automatically receive ALL builds. Prevention: skip `add-groups` for internal groups, only use it for external beta groups.
- **ASC build indexing lag after upload**: Immediately after `xcodebuild`/ASC upload succeeds, `asc builds latest --version <N>` may return "no pre-release version found" for a short period. Prevention: poll `asc builds list --sort -uploadedDate` until the build appears, then gate release completion on `processingState = VALID`.
- **BGProcessing task completion contract**: If a `BGProcessingTask` starts but `setTaskCompleted(success:)` is not called on every path (success/failure/expiration/no-op), iOS deprioritizes future launches and background continuation becomes unreliable. Prevention: centralize completion handling and call it in `finishTransfer`, `cancel`, and expiration handlers.
- **ASC delayed build visibility**: After upload, build queries may return `not-found` for a few minutes before the row appears (sometimes already `VALID`). Prevention: poll `asc builds list --sort -uploadedDate --limit 20` with retry windows instead of treating initial misses as failures.
- **Share extension main-actor crypto kills**: Running multi-file encryption/thumbnail loops on the extension main actor can trigger abrupt extension termination (watchdog/jetsam) near the end of processing with no graceful error UI. Prevention: keep UI state updates on main actor, but execute heavy per-file sync crypto/thumbnail work off-main (detached/background executor).
- **Share extension provider-retention pressure**: Holding full-batch `NSItemProvider` references in memory during long share runs increases extension memory pressure. Prevention: two-pass strategy (count first, process sequentially) without a retained provider array.
- **Dynamic Island loader drift from dual step sources**: Combining app-side `animationStep` ticks with widget-side timeline ticks (`baseStep + timelineStep`) changes loader speed versus in-app loaders. Prevention: use a single 0.1s timeline cadence in the widget renderer.
- **Inconsistent PixelAnimation presets**: `uploading()` and `downloading()` had different patterns (column sweep vs perimeter walk) and dimmer brightness (2 vs 3) than `loading()` / Dynamic Island. `syncing()` also had dimmer brightness. Prevention: removed `uploading()`/`downloading()`, made `syncing()` delegate to `loading()`. ONLY use `PixelAnimation.loading(size:)` — never create alternate patterns.
- **RECURRING: Keyboard pushes sheet background up**: Sheets presented over PatternLockView (RecoveryPhraseInputView, JoinVaultView) lack `.ignoresSafeArea(.keyboard)`, causing SwiftUI's automatic keyboard avoidance to push the sheet content up when the text field is focused. The parent PatternLockView has it, but sheets are independent view hierarchies. This has regressed 3+ times. Prevention: ANY view presented as a `.sheet` that contains a `TextEditor` or `TextField` MUST have `.ignoresSafeArea(.keyboard)` on its root container. Checklist: RecoveryPhraseInputView, JoinVaultView, SharedVaultInviteView, CustomRecoveryPhraseInputView — all need it.
- **`.gesture()` blocks TabView paging**: Using `.gesture(dragGesture)` on a TabView prevents its internal page swipe from working. The gesture system treats it as a primary gesture. Prevention: ALWAYS use `.simultaneousGesture()` when adding custom gestures to a TabView or its children.
- **Timer.scheduledTimer stops in background**: `Timer.scheduledTimer(withTimeInterval:)` uses RunLoop `.default` mode, which stops when app backgrounds. Live Activities / Dynamic Island never update. Prevention: use `Task { while !Task.isCancelled { tick(); try? await Task.sleep(for:) } }` instead — Task.sleep works with beginBackgroundTask active.
- **Async state update race causes UI flash**: Setting a `@State` variable via `await MainActor.run { }` before an async operation creates a window where UI briefly renders the intermediate state. Prevention: only set visual state variables when staying on current screen (e.g., invalid pattern → show feedback). When transitioning (valid pattern → next step), skip the intermediate state entirely.
- **Onboarding unlock transition can be consumed off-screen**: If `isUnlocked` flips while `showOnboarding` is still true, `ContentView` fires the unlock overlay during onboarding and the user sees a hard jump later. Prevention: defer `isUnlocked` until onboarding completion and run the unlock ceremony (`isLoading` delay + unlock state flip) at that moment.
- **Pending upload check OOM**: `hasPendingUpload` must never decode/load full pending SVDF blob data (e.g., `Data(contentsOf: pending_upload/svdf_data.bin)`) just to decide if resume is possible. Prevention: check metadata/state JSON + file existence only; keep all large payload reads on explicit resume/upload paths.
- **Streaming retrieve false-positive**: A code path may appear "streaming" but still load full encrypted entries if `retrieveFileToTempURL` reads entry `Data` before header parsing. Prevention: parse headers from `FileHandle` and stream decrypt directly to file.
- **Paged viewer + drag gesture conflict**: Additional drag gestures attached to a page-style `TabView` can leave horizontal swipes visually between pages. Prevention: keep page snapping isolated from custom drag-dismiss behavior or move dismiss gestures off the pager.
- **Viewer identity churn from index-keyed cover**: Using `fullScreenCover(item:)` where item id equals current photo index can cause re-presentation while swiping. Prevention: present with boolean state and keep page index separate.

---

## Corrections and Preferences

- **Commit frequency**: User prefers commit + push after every successful build. Don't accumulate changes.
- **Beads tracking**: Use beads for multi-session work, TodoWrite for single-session tasks.
- **Plan mode**: Make plans extremely concise. Sacrifice grammar for brevity.
- **Subagent model**: Always use opus model for subagents.
- **ASC API Key**: Key ID `GGJ9L8Y97B`, Issuer ID `3c53a69e-b7d6-4d46-a26b-2f2d02c69ccb`, key file at `~/.private_keys/AuthKey_GGJ9L8Y97B.p8`. Team ID `UFV835UGV6`.
- **TestFlight upload**: Use `xcodebuild -exportArchive` with `-authenticationKeyPath ~/.private_keys/AuthKey_GGJ9L8Y97B.p8 -authenticationKeyID GGJ9L8Y97B -authenticationKeyIssuerID 3c53a69e-b7d6-4d46-a26b-2f2d02c69ccb` and ExportOptions with `destination: upload`.
- **Appearance setting expectation**: Theme control must expose exactly `System`, `Light`, and `Dark` in App Settings and apply globally.
- **Color-tuning preference**: Keep light palette intact unless explicitly requested; adjust dark-mode tokens first when readability is the concern.
- **Release preference**: For TestFlight shipping, bump build number first and confirm ASC `processingState` reaches `VALID` before reporting completion.
- **ASC visibility preference**: After upload, verify the build row exists via `asc builds list --sort -uploadedDate` before relying on `asc builds latest --version`.
- **Upload resilience preference**: Resume pending uploads automatically when the vault opens (or app becomes active with an unlocked key), not only via a manual resume button in the share screen.
- **Release verification preference**: For TestFlight pushes, keep polling until both conditions hold: build row exists and `processingState == VALID`; do not report completion at upload success alone.
- **Share extension reliability preference**: For large share batches, checkpoint staged import manifests after each completed file so partial progress survives extension termination.
- **Crash triage preference (share extension)**: When user supplies a screen recording, extract frames and map the last stable progress label to code-path checkpoints before patching.
- **Loader consistency preference**: Dynamic Island pixel loader should be treated as a visual mirror of `PixelAnimation.loading`; if users report drift, normalize cadence/trail to in-app behavior before adding new animation logic.
- **Crash triage preference**: When a user reports a specific onboarding crash path, reproduce it with a minimal clean-state Maestro flow before implementing a fix.
- **Onboarding UX preference**: Completion path (recovery phrase saved → vault open) must show the same unlock ceremony as locked-state unlock: `LoadingView("Unlocking...")` followed by the vault-door transition.

---

## Anticipated Improvements

- Always wrap `Color.accentColor` (not bare `.accentColor`) in `.foregroundStyle()` calls
- Never run Embrace SDK setup/start inside `Task.detached`; keep initialization on `@MainActor` to satisfy SDK queue assertions.
- Run `bd list` before closing issues to confirm IDs exist
- When adding optional fields to Codable structs, always provide default `nil` in init for backward compat
- When modifying grid views that feed into a full-screen viewer, verify the index mapping is global not local
- When writing CloudKit save operations with deterministic record IDs, ALWAYS use fetch-or-create pattern — never assume a record doesn't exist
- When there's an initial upload path AND a sync path for the same CloudKit records, verify the sync cache is properly seeded after initial upload
- Never use `[weak self]` in `deinit` — capture properties by value instead
- When using animated floating buttons (FAB), separate the button into its own overlay to prevent animation interference from siblings
- When using `beginBackgroundTask`, always: (1) store the ID as a property, (2) end synchronously in the expiration handler via `MainActor.assumeIsolated`, (3) end any prior task before creating a new one
- When displaying transfer/upload/sync status, always handle ALL enum cases (uploading, failed, complete, etc.) — never just the happy path
- For CloudKit chunk uploads, use `withThrowingTaskGroup` with bounded concurrency (max 4) instead of sequential loops — cuts upload time 50-70%
- When updating index/records inside a per-share loop, accumulate updates and batch-save once after the loop (avoids N+1 decrypt+encode cycles)
- Before removing a method, grep for ALL callers — if zero callers, it's dead code and can be deleted entirely
- When adding new test files to VaultTests: create PBXBuildFile + PBXFileReference with TS prefix, add to TS0000070 group children and TS00000E0 Sources phase
- Before running `xcodebuild test`, verify simulator UUID with `xcrun simctl list devices available` — prefer booted devices
- NEVER use bare `VaultIndex(files:nextOffset:totalSize:)` for new vault creation — always use `loadIndex(with:)` which handles master key + blob setup
- When cloning a screen's functionality to a new context, copy ALL behavior: validation, haptics, error messages, feedback UI — not just the data flow
- Every visual/UI change MUST include Maestro test updates — new screen = new flow, new element = accessibility ID + assertion, changed text = updated assertion
- ALL pixel loaders MUST use `PixelAnimation.loading(size:)` — never create new factory methods with different patterns or brightness. The Dynamic Island's `LivePixelGrid` is the canonical reference.
- For distribution archive: use Manual signing with `CODE_SIGN_IDENTITY[sdk=iphoneos*]` scoping so simulator builds still work
- Sentry build script phase must always be LAST (after Embed Foundation Extensions) to avoid dependency cycles
- When adding TestFlight testers: `builds add-groups` first, then `beta-testers invite`
- For certificate import on macOS: always use `-legacy` flag with openssl and a non-empty temp password
- **PHPicker pre-loading lag**: UIViewControllerRepresentable photo pickers that load all images before calling back create a visible lag. Fix: pass `PHPickerResult` array directly and process incrementally with immediate progress. Never batch-load all picker results before showing UI feedback.
- **Progress indicator timing**: Always set `importProgress` on the main actor BEFORE `Task.detached`, not inside it via `MainActor.run` — the latter introduces an async hop delay.
- **RECURRING: @MainActor `await` omission**: Every time import handlers are modified, verify ALL `ShareSyncManager.shared.scheduleSync()` calls have `await`. This has regressed 3+ times. The `handleCapturedImage` path is the one that keeps losing it.
- **RECURRING: `.ignoresSafeArea(.keyboard)` on sheets with text input**: ANY `.sheet` containing TextEditor/TextField MUST have `.ignoresSafeArea(.keyboard)` on its root view. Screens to check: RecoveryPhraseInputView, JoinVaultView, SharedVaultInviteView, CustomRecoveryPhraseInputView. Parent view's `.ignoresSafeArea(.keyboard)` does NOT propagate to sheets.
- **RECURRING: sheet detent shift when keyboard appears**: On lock-screen flows, default sheet detents may re-evaluate on text focus and create a visible background jump. Prevention: pin lock-screen input sheets to `.presentationDetents([.large])` in `PatternLockView`.
- **safeAreaInset default spacing creates visible seams**: `safeAreaInset(edge: .top)` without explicit spacing can insert platform spacing between top controls and scroll content. Prevention: use `safeAreaInset(edge: .top, spacing: 0)` for contiguous header/grid layouts.
- For pending/resumable uploads, keep UI probe paths metadata-only and stream chunk IO from file URLs; never allocate full SVDF `Data` in banner/status code paths.
- **Stale pattern feedback state blocks newer errors**: In change-pattern create step, UI renders `validationResult` before `errorMessage`. If code sets one without clearing the other, old feedback persists and new errors appear "stuck". Prevention: whenever setting `errorMessage`, clear `validationResult`; whenever setting `validationResult`, clear `errorMessage`.
- For mutually exclusive feedback UI, centralize transitions in a dedicated state model and unit test precedence/reset behavior instead of duplicating branch-level state mutation.
- Prefer Maestro id/coordinate selectors over `tapOn index` in dense screens; index selectors drift as visible elements/layout shift.
- **Maestro runs installed app, not latest build output**: `xcodebuild build` alone does not update the simulator app used by Maestro. Prevention: `simctl install` the newly built `.app` before running regression flows that depend on new UI/test IDs.
- **ALWAYS use `.simultaneousGesture()` with TabView**: Never attach `.gesture()` directly to a TabView or its content — it blocks internal page swipe. Always use `.simultaneousGesture()` for custom gestures (drag-to-dismiss, etc.) coexisting with TabView paging.
- **Never use Timer.scheduledTimer for background-critical updates**: Use `Task`-based async loops with `Task.sleep(for:)` instead. Timers stop when app backgrounds (RunLoop `.default` mode). Task.sleep continues with `beginBackgroundTask`. Keep ActivityKit update rate ≤ 2/sec.
- **Async state transitions: skip intermediate state**: When a valid result triggers a screen transition after an async gap, do NOT set intermediate visual state. Only set visual state (validationResult, etc.) when the user stays on the current screen (e.g., invalid input). This prevents brief UI flashes between steps.
- **Appearance mode architecture**: Keep a single source of truth in `AppState` (`appAppearanceMode`) and apply root-level `.preferredColorScheme(...)`; avoid per-screen theme overrides.
- **Dark theme tuning workflow**: Update dark asset variants in `Assets.xcassets` (not scattered `.foregroundStyle` overrides), then validate with build/tests + settings Maestro flows.
- **TestFlight workflow hardening**: If script export fails with account-session errors, rerun export with ASC API key flags and poll `asc builds list` until new build appears.
- For build verification polling, always request latest-first ordering (`--sort -uploadedDate`) with a bounded page (`--limit 20`) so freshly uploaded versions are visible immediately.
- Keep upload continuation hooks at three layers: `beginBackgroundTask` for immediate background time, `BGProcessingTask` for deferred wakeups, and metadata-backed resume when vault key returns.
- Keep ASC poll loops bounded but long enough (>= 10 attempts at ~20s) to absorb normal indexing delays before raising failure.
- For share extension pipelines, avoid long-lived arrays of `NSItemProvider`; scan/count first, then process providers in streaming fashion so references are released sooner.
- After share-extension pipeline changes, run full simulator tests and clear test-compiler warnings (unused vars/unused helper returns) before release.
- For widget loader animation, avoid compounding multiple step sources; keep a single deterministic tick source and tune trail opacity to match in-app fade.
- When transition effects are driven by global app state (`isUnlocked`), never mutate that state while a higher-priority root route (`showOnboarding`) still masks the target screen.

### Session 4 — Fan Menu UX + CloudKit Chunk Overlap Fix (Feb 9, 2026)
- **Query**: Fix fan menu button positioning/vanishing, fix CloudKit CKError 14 "record to insert already exists" during multi-recipient share sync
- **Approach**:
  1. Fan menu: separated + button into own overlay to isolate animation context, added `.buttonStyle(.plain)` to prevent press dimming
  2. CloudKit: always fetch existing record before save (fetch-or-create pattern), handle code 14 in saveWithRetry as defense-in-depth
  3. CameraManager: fix deinit crash from weak self in async dispatch during deallocation
- **Root Causes**:
  - **Fan menu vanish**: Default ButtonStyle opacity dimming on press + `.animation` modifier leaking across ZStack siblings
  - **CKError 14**: Initial upload (`uploadSharedVault()`) creates chunks in CloudKit but never populates `ShareSyncCache`. First incremental sync reads empty `previousChunkHashes`, treats ALL chunks as new, tries INSERT on records that already exist
  - **CameraManager crash**: `deinit` called `stopSession()` which uses `[weak self]` — can't form weak ref to deallocating object
- **Key Learnings**:
  - SwiftUI `.animation(_:value:)` can leak to sibling views in same ZStack — separate into distinct overlays for isolation
  - CKRecord.save() treats new CKRecord objects as INSERT, fetched objects as UPDATE — critical distinction
  - Initial upload → incremental sync handoff has a cache gap — always defend against missing/stale cache state
  - Never use `[weak self]` in `deinit` closures — capture specific properties instead

### Session 5 — Background Task Expiration + Upload Progress Visibility (Feb 10, 2026)
- **Query**: Fix iOS background task expiration during large vault uploads; add upload status visibility to Share Vault management screen
- **Approach**:
  1. Background task: Store `currentBgTaskId` as property, use `MainActor.assumeIsolated` in expiration handler for synchronous cleanup, add `endBackgroundExecution()` idempotent helper
  2. Upload progress: Replace narrow `.uploading`-only check with `transferStatusBanner` showing `.uploading`, `.uploadFailed`, `.uploadComplete` states
  3. Added missing `beginBackgroundTask` to `startBackgroundImport`
- **Root Causes**:
  - **Background task not ended**: Expiration handler dispatched `cancel()` via `Task { @MainActor in }` — async hop may not execute before iOS suspends. `endBackgroundTask` must be called synchronously in the handler.
  - **No upload status shown**: ShareVaultView only showed progress for `.uploading` enum case. `.uploadFailed` and `.uploadComplete` had no UI — user saw nothing when upload failed.
  - **Missing background task**: `startBackgroundImport` had no `beginBackgroundTask` at all — iOS could suspend during import.
- **Key Learnings**:
  - `UIApplication.beginBackgroundTask` expiration handler runs on main queue — use `MainActor.assumeIsolated` for synchronous @MainActor access without async hop
  - Must call `endBackgroundTask` before expiration handler returns, not via async dispatch
  - Multiple `beginBackgroundTask` calls without matching `endBackgroundTask` = orphaned task IDs
  - Always show ALL non-idle transfer states in UI, not just the "happy path" uploading state

### Session 7 — Unit Test Infrastructure (Feb 10, 2026)
- **Query**: Add VaultTests unit test target + initial test coverage for crypto/sharing layers
- **Approach**: Create VaultTests target via pbxproj edits (TS prefix IDs), 4 test suites, @testable import Vault with TEST_HOST
- **Files created**: VaultTests/CryptoEngineTests.swift, SVDFSerializerTests.swift, ShareSyncCacheTests.swift, SharedVaultDataTests.swift
- **Files modified**: project.pbxproj (TS prefix entries), Vault.xcscheme (Testables section)
- **Result**: 32 tests, 0 failures, all pass in 0.044s
- **Errors**:
  - Stale simulator UUID: `57965726-...` was deleted, test launch failed with "Unable to boot deleted device". Fix: use `xcrun simctl list devices available` to find live simulators, use booted one (`6627B57F-...`)
  - SourceKit "No such module XCTest" — false positive before test target exists, ignore per Error Tracker
- **Key Learnings**:
  - Test target needs: PBXBuildFile, PBXFileReference, PBXGroup, PBXSourcesBuildPhase, PBXFrameworksBuildPhase, PBXResourcesBuildPhase, PBXNativeTarget, PBXContainerItemProxy, PBXTargetDependency, XCBuildConfiguration (Debug+Release), XCConfigurationList, plus updates to mainGroup, Products, TargetAttributes, targets array
  - `BUNDLE_LOADER = "$(TEST_HOST)"` + `TEST_HOST = "$(BUILT_PRODUCTS_DIR)/Vault.app/$(BUNDLE_EXECUTABLE_FOLDER_PATH)/Vault"` — test bundle loads into host app, `@testable import Vault` works without sharing source files
  - Always check `xcrun simctl list devices available` for booted simulator before running tests — stale UUIDs fail silently

### Session 6 — Code Review: Quality + Performance Fixes (Feb 10, 2026)
- **Query**: Interactive 4-section code review of sharing/transfer code (Architecture → Code Quality → Tests → Performance)
- **Approach**: Systematic review with user-approved fixes per section
- **Code Quality Fixes**:
  - Removed dead `startBackgroundImport` (zero callers, 80 lines)
  - Removed unused `pattern: [Int]` param from import method
  - Added Sentry error capture to import error path
  - Extracted `saveChunkRecord` helper in CloudKitSharingManager (DRY 3x)
- **Performance Fixes**:
  - Parallel chunk uploads (max 4 concurrent) via `withThrowingTaskGroup` with bounded concurrency
  - Batched index save after sync loop (was N+1 loads)
- **Key Learnings**:
  - `withThrowingTaskGroup` concurrency limiting pattern: check `inFlight >= max` before each `addTask`, call `try await group.next()` to drain one slot
  - CloudKit public database handles 4 concurrent saves well; `saveWithRetry` handles rate limiting as fallback
  - Dead code detection: grep for method name, verify zero callers before removing
  - N+1 pattern in loops: accumulate updates, batch-write after loop

### Session 8 — Resumable Uploads (Feb 10, 2026)
- **Query**: Implement resumable upload system so large vault shares survive app backgrounding
- **Approach**: Persist SVDF data + upload metadata to disk before CloudKit upload; on resume, query CloudKit for existing chunks, upload only missing ones
- **Files modified**: CloudKitSharingManager.swift (existingChunkIndices, saveManifest extraction, uploadChunksParallel → internal), BackgroundShareTransferManager.swift (PendingUploadState, save/load/clear, resumePendingUpload), ShareVaultView.swift (Resume Upload button)
- **Result**: Build succeeded first attempt, 314 lines added, committed and pushed
- **Errors**: Duplicate simulator name (lowercase "iphone 17 pro" + uppercase "iPhone 17 Pro") — used UUID directly per Error Tracker
- **Key Learnings**:
  - `nonisolated static` methods on `@MainActor` class for file I/O called from `Task.detached` — avoids actor isolation issues
  - `CKQueryOperation.Cursor` from `publicDatabase.records(matching:)` result enables pagination — check `queryCursor` after each page
  - Extracting methods from complex functions: keep the original call site clean, move error capture/transaction logic to the caller
  - PendingUploadState uses JSON for metadata + raw binary for SVDF blob — keeps serialization simple and avoids base64 bloat

### Session 9 — Maestro E2E Test Infrastructure (Feb 10, 2026)
- **Query**: Implement Maestro E2E test coverage plan (3 phases: test mode bypass, accessibility identifiers, YAML flows)
- **Approach**: `#if DEBUG` TEST_MODE bypass with deterministic SHA-256 key, accessibilityIdentifier on all interactive elements across 15 views, 30 YAML flow files in `maestro/` directory
- **Files modified**: VaultApp.swift (AppState test mode + deterministic key), ContentView.swift (auto-unlock + lock bypass), 13 view files (accessibilityIdentifiers)
- **Files created**: maestro/ directory with config.yaml, 3 test media files, 30 YAML flow files across 10 categories
- **Result**: Build succeeded first attempt, 945 lines added across 56 files, committed and pushed
- **Errors**: Duplicate simulator name again (lowercase "iphone 17 pro") — used UUID per Error Tracker
- **Key Learnings**:
  - `ProcessInfo.processInfo.arguments.contains("-MAESTRO_TEST")` detects Maestro launch args in iOS
  - Deterministic test key via `CryptoKit.SHA256.hash(data: fixedSeed)` bypasses PBKDF2+SecureEnclave for automated testing
  - Lock trigger bypass: screenshot/screenRecording/background notifications all need early-return guards
  - Maestro `runFlow` uses relative paths from the YAML file location
  - `addMedia` pushes files to simulator photo library — works for photo import tests
  - FanItem struct needed `accessibilityId` optional field for per-item identifiers
  - Accessibility identifiers go on the interactive element itself, not a containing wrapper

### Session 10 — Maestro Flow Runtime Fixes (Feb 10, 2026)
- **Query**: Run Maestro flows on simulator, fix failures
- **Approach**: Iterative run → diagnose → fix → re-run for all 30 flows across 8 directories
- **Files modified**: VaultApp.swift (onboarding bypass, MAESTRO_SEED_FILES), launch_test_mode.yaml, navigate_to_app_settings.yaml, 22 YAML flow files
- **Files created**: launch_with_files.yaml (helper with seed files), testdata symlinks
- **Result**: 29/30 flows passing (96.7%). Only import_from_library fails (system photo picker limitation)
- **Errors**:
  - Java not linked: `JAVA_HOME="/opt/homebrew/opt/openjdk@17"` needed for Maestro CLI
  - Onboarding reappears: `clearState: true` resets UserDefaults → auto-set `hasCompletedOnboarding` in test mode
  - Apple Account Verification dialog: `clearKeychain: true` triggers persistent system dialog → removed, added "Not Now" dismiss
  - `wait: N` invalid: Maestro has no `wait` command → use `waitForAnimationToEnd: timeout: N000`
  - `addMedia` no parent paths: `../testdata/` fails → moved testdata into flows/, created per-directory symlinks
  - FAB not in empty state: `vault_add_button` hidden when files empty → use `vault_first_files` + confirmationDialog
  - `clearInput` invalid: → use `eraseText: charactersToErase: N`
  - Premium elements hidden: duress toggle/iCloud backup gated by subscription → scroll to visible text, tap either toggle or button
  - Settings below fold: `settings_app_settings` needs `scrollUntilVisible` before tap
- **Key Learnings**:
  - Maestro `addMedia` resolves paths relative to the YAML file only — no `../` parent traversal
  - Maestro has no `wait` or `clearInput` commands — use `waitForAnimationToEnd` and `eraseText`
  - Maestro doesn't recurse subdirectories — must run per-directory: `maestro test maestro/flows/core/`
  - System photo picker (PHPickerViewController) is unreliable in Maestro — make picker steps optional
  - For flows needing files in vault, use `-MAESTRO_SEED_FILES` launch arg + `UIGraphicsImageRenderer` to generate test images programmatically
  - `clearState: true` resets ALL UserDefaults — any test mode init must re-set required defaults
  - `clearKeychain: true` triggers Apple Account Verification — avoid in test mode
  - Premium-gated UI: use `scrollUntilVisible` with text match + optional taps for both premium/non-premium states

### Session 11 — Link-Based Vault Sharing (Feb 10, 2026)
- **Query**: Implement share-via-link feature — encode phrase into URL fragment, deep link handler, invite landing screen, Copy Link + Share buttons
- **Approach**: 3 new files (ShareLinkEncoder, DeepLinkHandler, SharedVaultInviteView) + modifications to 5 existing files (entitlements, VaultApp, ContentView, ShareVaultView, pbxproj)
- **Files created**: ShareLinkEncoder.swift (base58 + deflate compression), DeepLinkHandler.swift (@Observable URL handler), SharedVaultInviteView.swift (invite flow with pattern setup)
- **Files modified**: Vault.entitlements (associated domains), VaultApp.swift (DeepLinkHandler + onOpenURL), ContentView.swift (fullScreenCover for invite), ShareVaultView.swift (Copy Link + Share buttons with 60s auto-clear), project.pbxproj (SL prefix IDs)
- **Result**: Build succeeded first attempt, 543 lines added across 9 files, committed and pushed
- **Errors**: Duplicate simulator name again — used UUID per Error Tracker
- **Key Learnings**:
  - Apple's `Compression` framework provides `compression_encode_buffer`/`compression_decode_buffer` for deflate — no need for third-party zlib wrappers
  - Base58 encoding (Bitcoin alphabet) naturally excludes ambiguous characters (0, O, I, l) — ideal for URL-safe phrase encoding
  - URL fragments (#...) never reach the server — safe for client-side secrets in share links
  - `fullScreenCover` with computed `Binding` on an observable property works well for showing deep-link-triggered sheets regardless of app lock state
  - SharedVaultInviteView mirrors JoinVaultView pattern: invite → premium check → pattern setup → empty index → unlock → background download
  - `.interactiveDismissDisabled()` prevents accidental swipe-dismiss during invite flow

### Session 12 — Monorepo Restructure (Feb 10, 2026)
- **Query**: Restructure repo from single iOS project to monorepo with apps/ios/, web/, shared docs/
- **Approach**: git mv iOS files to apps/ios/, split docs (iOS-specific → apps/ios/docs/, project-wide stays at docs/), scaffold web/ with AASA + landing pages + Tailwind, create scoped AGENTS.md files
- **Files moved**: 150+ files via git mv (Vault.xcodeproj, Vault/, VaultLiveActivity/, VaultTests/, maestro/ → apps/ios/)
- **Files created**: apps/ios/AGENTS.md (iOS-scoped), web/AGENTS.md, web/index.html, web/s/index.html, web/.well-known/apple-app-site-association, web/package.json, web/styles/input.css
- **Files modified**: AGENTS.md (trimmed to monorepo-level), .gitignore (web ignores)
- **Result**: Build succeeded first attempt from apps/ios/, beads still works from root
- **Errors**:
  - `git mv VaultUITests` failed — empty dir not tracked by git. Fix: plain `mv` for untracked dirs
  - `git mv .sentryclirc` failed — gitignored file. Fix: plain `mv`
  - `&&` chain break: first failure aborts remaining commands. Partial state required checking what already moved.
- **Key Learnings**:
  - Xcode `sourceTree = "<group>"` relative refs mean moving .xcodeproj + siblings together requires NO pbxproj edits
  - `git mv` can't move empty dirs or gitignored files — use plain `mv` for those
  - sentry-cli discovers `.sentryclirc` by walking up from CWD — placing it next to .xcodeproj keeps it discoverable
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of v3's `@tailwind` directives
  - AASA file must have no extension but serve as `application/json`

### Session 13 — Join Vault Bug Fixes + Download Progress (Feb 10, 2026)
- **Query**: Fix 3 bugs in Join Shared Vault flow: invisible text area, "Setup Failed" crash, missing pattern validation. Add download progress indicator.
- **Approach**: Traced each bug to root cause, applied minimal fixes matching existing patterns in onboarding/settings screens
- **Root Causes**:
  - **Invisible text area**: TextEditor missing `.overlay(RoundedRectangle.stroke())` border that all other phrase inputs have
  - **"Setup Failed" on import**: `setupSharedVault()` manually created bare `VaultIndex` (v1 init, no `encryptedMasterKey`). Background import called `storeFile()` → `getMasterKey()` → `guard let encryptedMasterKey` → throws `corruptedData`. Fix: use `loadIndex(with:)` which auto-creates proper v3 index with master key + blob when none exists
  - **No pattern validation**: `handlePatternComplete` only checked `count >= 6`, skipping `PatternValidator` (no validation feedback, no haptics, no error on mismatch). Fix: mirror `PatternSetupView` exactly — full validation, visual feedback, haptics, "Patterns don't match" error with auto-clear
- **Download progress**: Exposed `displayProgress`/`currentMessage` from `BackgroundShareTransferManager` (changed `private` → `private(set)`). Added `importingProgressView` to VaultView empty state — shows PixelAnimation.downloading + ProgressView bar + percentage + status message when `transferManager.status == .importing`
- **Maestro tests**: Expanded `join_vault.yaml` (phrase input + pattern setup assertions), created `join_vault_pattern_validation.yaml` (mismatch error + start over flow). Added accessibility IDs: `join_pattern_grid`, `join_pattern_error`, `join_pattern_start_over`
- **Rule added**: Mandatory Maestro test section in `apps/ios/AGENTS.md` — every visual/UI change MUST include corresponding test updates
- **Key Learnings**:
  - `VaultIndex` has two inits: v1 (no master key — for legacy/bare use) and v2+ (with `encryptedMasterKey`). Using v1 init then saving creates a real index file, which prevents `loadIndex` from auto-creating a proper v3 index later. Always use `loadIndex` for new vault creation — it handles master key generation, blob setup, and versioning automatically
  - When a new screen replicates functionality from an existing screen (join vault pattern ↔ onboarding pattern), copy the FULL behavior including validation, haptics, error messages, and feedback UI — not just the happy path
  - `private(set)` on `@Observable` properties is the clean way to expose read-only progress to views without breaking encapsulation

### Session 14 — TestFlight Distribution Pipeline (Feb 10, 2026)
- **Query**: Set up full TestFlight pipeline — from zero distribution assets to first build on TestFlight
- **Approach**: Register missing bundle ID, create distribution cert + profiles, configure manual signing for Release, fix build phase cycle, archive + export + upload, create beta group + invite tester
- **Files created**: ExportOptions.plist, scripts/publish-testflight.sh
- **Files modified**: project.pbxproj (Release signing → manual, build phase reorder)
- **ASC artifacts**: Distribution cert (6DBP6XL5J5), 3 App Store profiles, "Internal Testers" group, build v1.0(1) uploaded
- **Errors**:
  - `asc bundle-ids create --platform UNIVERSAL` rejected — must use `IOS` (ASC API converts to UNIVERSAL internally)
  - `security import` with empty password fails on macOS — use `openssl pkcs12 -legacy` with temp password
  - `xcodebuild archive` with `CODE_SIGN_STYLE=Automatic` fails without registered devices — Xcode tries to create Development profiles which require devices even for distribution builds
  - Sentry script build phase before Embed Foundation Extensions causes cycle — dSYM input dependency creates circular reference with extension embedding
  - `asc testflight beta-testers invite` fails with "no installable builds" until build is added to group via `asc builds add-groups`
- **Key Learnings**:
  - **Manual signing for Release is required** when no devices are registered — automatic signing tries to create Development profiles (need devices) even for distribution archive
  - `CODE_SIGN_IDENTITY[sdk=iphoneos*]` and `PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]` scope signing to device builds only — simulator builds still work with default ad-hoc signing
  - `openssl pkcs12 -legacy` flag needed for macOS Keychain import compatibility
  - Sentry dSYM upload script must be AFTER Embed Foundation Extensions in build phases to avoid dependency cycle
  - `xcodebuild -exportArchive` with `destination: upload` in ExportOptions.plist uploads directly to ASC — no IPA file produced locally
  - `-allowProvisioningUpdates` only needed on exportArchive step, not archive step with manual signing
  - Build processing takes ~1-2 minutes in ASC before `VALID` state
  - Must `asc builds add-groups` before testers can be invited — group needs a build first
  - Internal testers (ASC team members) use `invite` not `add` command

### Session 15 — Import UX, Free Tier Enforcement, Unlock Animation, Drag-to-Select, TestFlight (Feb 11, 2026)
- **Queries**: 7 sequential requests: (1) fix import progress lag, (2) enforce free tier 100-file limit during import, (3) standardize unlock animation to 1.5s, (4) icon overlay to 0.9s, (5) drag-to-select in edit mode, (6) fix recurring Swift 6 async warning, (7) deploy to TestFlight
- **Approach**: Each change committed and pushed individually after build verification
- **Files modified**: VaultView.swift (import progress, free tier limits, async fix), PhotosGridView.swift (drag-to-select), FilesGridView.swift (drag-to-select), VaultApp.swift (unlock timing), ContentView.swift (shield overlay timing), project.pbxproj (build number bump)
- **Root Causes**:
  - **Import lag**: PHPicker Coordinator loaded ALL images via `loadObject` before calling back. Fix: pass `[PHPickerResult]` directly, set `importProgress` immediately on main actor
  - **Broken vault state**: Free tier limit only checked at + button, not during import. `storeFile` threw `expansionNotAllowed` silently. Fix: cap imports to remaining free slots, import those, show paywall if truncated
  - **Swift 6 async warning**: `handleCapturedImage` path missing `await` on `@MainActor` singleton call (3rd time this regressed)
- **Errors**:
  - `asc builds add-groups` fails for internal groups — internal groups with `hasAccessToAllBuilds: true` auto-receive all builds
- **Key Learnings**:
  - PreferenceKey + simultaneousGesture + direction detection is the pattern for drag-to-select in SwiftUI LazyVGrid
  - Replace `Button` with `.onTapGesture` when adding simultaneous drag gestures (Button consumes the gesture)
  - Internal TestFlight groups auto-receive builds — no `add-groups` needed
  - Free tier enforcement must happen at import handler level, not just UI button level

### Session 16 — Free Tier Alert, Video Import, Quick Look, Paywall Fallback, Unified Grid (Feb 11, 2026)
- **Queries**: 7 sequential requests: (1) fix 100-file limit silent truncation with alert dialog, (2) fix video import from gallery, (3) fix date header overlap, (4) add Quick Look for non-image files, (5) fix RevenueCat Error 23 with fallback paywall, (6) unified Files-app grid for mixed content, (7) deploy build 6 to TestFlight
- **Approach**: Each fix committed individually; unified grid was the most complex change
- **Files modified**: VaultView.swift (limit alert, video import, date header padding), FilesGridView.swift (thumbnailOrIcon, masterKey param), SecureImageViewer.swift (Quick Look rewrite), PaywallTrigger.swift (fallback paywall), SubscriptionManager.swift (hasOfferings check)
- **Root Causes**:
  - **94 files instead of 100**: PHPicker allows images+videos, but `handleSelectedPhotos` only processed UIImage. 6 videos silently skipped via `canLoadObject(ofClass: UIImage.self)` check
  - **Silent truncation**: No user feedback when import was capped. Fix: PendingImport enum + 3-option alert (Import N, Upgrade, Cancel)
  - **Video silent fail**: `loadObject(ofClass: UIImage.self)` fails for video items. Fix: `UTType.movie` detection + `loadFileRepresentation` + `AVAssetImageGenerator` thumbnails
  - **Date header overlap**: `LazyVStack(spacing: 0)` with pinned headers left zero gap. Fix: `.padding(.top, 8)` on section content
  - **Unsupported file type**: SecureImageViewer only handled UIImage. Fix: QLPreviewController for non-image files via UIViewControllerRepresentable
  - **RevenueCat Error 23**: Offerings not configured. Fix: `hasOfferings` check → FallbackPaywallView with premium override for sandbox
  - **Inconsistent grid**: PhotosGridView (tight) + FilesGridView (icon tiles) side by side. Fix: FilesGridView accepts optional masterKey, shows AsyncThumbnailView for files with thumbnails
- **Key Learnings**:
  - `NSItemProvider.loadFileRepresentation(forTypeIdentifier:)` provides a temp URL — must copy data before callback returns
  - `AVAssetImageGenerator.copyCGImage(at:actualTime:)` grabs frame at specific time — write video to temp file first
  - QLPreviewController via UIViewControllerRepresentable works for all file types iOS supports
  - RevenueCat `Purchases.shared.offerings()` returns nil current when no products configured — check before showing PaywallView
  - Unified grid pattern: FilesGridView with optional masterKey, `thumbnailOrIcon` method switches between AsyncThumbnailView and icon fallback
  - "Photos" filter → PhotosGridView (compact), all other filters → FilesGridView (uniform tiles with thumbnails)

### Session 17 — Scroll Fix, Security Fix, Batch Delete, Camera Preview, Media Filter, Builds 7-9 (Feb 11, 2026)
- **Queries**: 8 sequential requests: (1) verify scroll fix + push, (2) deploy build 7 to TestFlight, (3) prevent phone sleep during imports, (4) deploy build 8, (5) default to Media filter, (6) critical security fix — cross-vault import contamination, (7) batch delete optimization, (8) camera preview fix, (9) deploy build 9
- **Approach**: Each fix committed and pushed individually; 3 TestFlight deployments across session
- **Files modified**: VaultView.swift (media filter, security fix, batch delete, idle timer), FilesGridView.swift (scroll fix), PhotosGridView.swift (scroll fix), VaultStorage.swift (batch deleteFiles), SecureCameraView.swift (camera preview), ShareExtension/Info.plist (build setting vars), Supporting/Info.plist (build bumps 6→9), project.pbxproj (build bumps)
- **Root Causes**:
  - **Scroll blocked**: `DragGesture(minimumDistance: 1)` via `.simultaneousGesture()` always attached, competing with ScrollView pan. Fix: conditionally attach only when `isEditing`
  - **Phone sleep during imports**: No idle timer management. Fix: `UIApplication.shared.isIdleTimerDisabled = true/false` around import/delete operations
  - **Cross-vault contamination (CRITICAL)**: `Task.detached` captures vault key by value (Data), keeps running after lock. `lockVault()` has no task cancellation. `onChange` only clears on nil, not vault switch. Fix: store task handles, cancel on any key change, check `Task.isCancelled` throughout import loops
  - **Batch delete freeze**: Each `deleteFile` did separate `loadIndex`/`saveIndex` — 300 cycles for 300 files, ran on main thread. Fix: batch `deleteFiles` method (single load/save, blob-grouped file handles), `Task.detached`, progress bar
  - **Camera black preview**: `AVCaptureVideoPreviewLayer` added as sublayer with zero frame. Fix: `layerClass` override pattern — backing layer auto-resizes
  - **ShareExtension version drift**: Hardcoded build number "6" in Info.plist. Fix: `$(CURRENT_PROJECT_VERSION)` and `$(MARKETING_VERSION)` variables
- **Errors**:
  - `defer` can't contain `await` — moved idle timer re-enable to explicit MainActor.run blocks
  - `blobId` is `String?` — used `entry.blobId ?? "primary"` for dictionary grouping
  - ShareExtension build number mismatch broke archive — replaced with build setting variables
  - `asc builds test-notes create` duplicate locale error — used `update` instead
- **Key Learnings**:
  - Swift `defer` cannot contain `await` expressions — use explicit cleanup at return points
  - `Task.detached` captured value-type keys (`Data`) survive vault lock — MUST store task handles and check `Task.isCancelled` for security
  - `onChange(of:)` should handle ANY value change for security-critical state, not just nil transitions
  - Batch storage operations: load index once, group by blob for file handle reuse, save once = 300x fewer crypto cycles
  - `AVCaptureVideoPreviewLayer` as `layerClass` override is Apple's recommended pattern — auto-resizes with view, no manual frame management needed
  - ShareExtension Info.plist should use `$(CURRENT_PROJECT_VERSION)` / `$(MARKETING_VERSION)` to stay in sync with main app
  - `asc testflight beta-details get` shows `internalBuildState: IN_BETA_TESTING` when auto-notify is enabled — no manual group assignment needed for internal testers

### Session 19 — Replace Debug Prints with Structured os.log (Feb 11, 2026)
- **Query**: VAULT-x68 — Replace ~80 `#if DEBUG / print() / #endif` blocks with Apple's unified `os.log` Logger across the entire codebase
- **Approach**: Searched for all `#if DEBUG` blocks, identified 18 Swift files needing changes (excluded VaultStorage.swift, iCloudBackupManager.swift, VaultView.swift per instructions). Added Logger instances following subsystem/category pattern, replaced prints with appropriate log levels.
- **Files modified**: 18 files — VaultApp.swift, ContentView.swift, SubscriptionManager.swift, PatternSetupView.swift, VaultSettingsView.swift, SettingsView.swift, CloudKitSharingManager.swift, ShareVaultView.swift, DeepLinkHandler.swift, ShareSyncManager.swift, PatternGridView.swift, PatternLockView.swift, LocalNotificationManager.swift, ImportIngestor.swift, RecoveryPhraseView.swift, DuressHandler.swift, GridLetterManager.swift, RecoveryPhraseManager.swift
- **Security**: 5 sensitive data leaks found and addressed — 3 `key.hashValue` prints changed to `logger.trace()` with no key data, 2 recovery phrase prints removed/trace-only, 1 duress recovery phrase print removed entirely
- **Errors**:
  - `@MainActor`-isolated `private static let logger` on ShareSyncManager accessed from `nonisolated static` method. Fix: moved to file-level `private let shareSyncLogger` outside the class
  - Pre-existing unused variable `let newPhrase = ...` in VaultSettingsView after removing the print that used it. Fix: changed to `_ = ...`
- **Key Learnings**:
  - Logger placement: `private static let` for classes/actors (accessed via `Self.logger`), file-level `private let` for structs/enums/views
  - `@MainActor` class static properties cannot be accessed from `nonisolated` context — use file-level let instead
  - Per-frame drag logging (called every gesture event) must be removed, not converted — would flood os.log
  - Sensitive data in logs: `key.hashValue` and recovery phrases should use `.trace()` or be removed entirely
  - Some `#if DEBUG` blocks are functional gates (Maestro test mode), not logging — keep those intact

### Session 20 — Code Review Implementation Wave 4 + TestFlight Build 15 (Feb 11, 2026)
- **Query**: Continue implementing remaining beads issues from 16-item code review, push to TestFlight
- **Approach**: Implemented 5 remaining issues (VAULT-zhw P0, VAULT-mn7 P1, VAULT-3os P2, VAULT-rlu P2, VAULT-x68 P3) using parallel subagents for non-overlapping changes
- **Issues completed**:
  - VAULT-zhw: Replaced `Data(contentsOf: blobURL)` + `CryptoEngine.encrypt()` with `CryptoEngine.encryptStreaming(fileURL:originalSize:with:)` — halves peak memory for iCloud backup
  - VAULT-mn7: Fixed 5 critical `try?` paths — zeroed XOR key fallback → CryptoKit SymmetricKey; silent duress setup → Sentry error capture; silent file deletion → Sentry capture; silent recovery data destroy → do/catch
  - VAULT-3os: Parallel chunk downloads via `downloadChunksParallel` with bounded TaskGroup (max 4 concurrent), order-preserving reassembly
  - VAULT-rlu: VaultView decomposed from 1500→487 lines into 5 extension files (+Grid, +Toolbar, +FanMenu, +SharedVault, +Actions)
  - VAULT-x68: 18 files migrated from `#if DEBUG print()` to structured os.log Logger (via subagent)
- **Subagent coordination**: 3 parallel agents (downloads, os.log, VaultView extraction) working on non-overlapping files. All completed successfully.
- **Errors**:
  - `SentryManager.captureError` takes only `Error`, not `(Error, context:)` — fixed by removing context param
  - os.log agent hit `@MainActor` static logger in `nonisolated` method — fixed with file-level logger
  - `xcodebuild -exportArchive` with `destination: upload` requires App Store Connect API key — no key configured, used Xcode Organizer instead
- **Key Learnings**:
  - `CryptoEngine.encryptStreaming` reads via FileHandle in 256KB chunks — essential for large blobs
  - `Data(repeating: 0, count: 16)` as crypto fallback is a security vulnerability — always use CryptoKit entropy
  - `try?` on security-critical operations (duress vault setup, file deletion) gives false sense of success
  - Parallel subagents work well when files don't overlap — os.log, VaultView extensions, and CloudKit downloads all isolated
  - `xcodebuild -exportArchive` without `destination: upload` exports IPA locally; with it, needs ASC API key auth

### Session 18 — Pattern Board Normalization + UI Consistency (Feb 11, 2026)
- **Queries**: Fix ChangePatternView UI (error position, grid jumping, missing action buttons), replace onboarding logo, remove/re-add validation feedback, normalize all pattern boards
- **Approach**: Investigated all 7 pattern board screens (PatternLockView, PatternSetupView, ChangePatternView, JoinVaultView, SharedVaultInviteView, RestoreFromBackupView, PatternInputView), identified inconsistencies, normalized to match PatternSetupView as reference implementation
- **Root Causes**:
  - **Grid jumping**: Different subtitle text lengths + different number of bottom buttons across steps changed Spacer distribution. Fix: `.frame(height: 44, alignment: .top)` on subtitle, `.hidden()` placeholder buttons
  - **Error at wrong position**: Error message was between title and grid instead of below grid. Fix: moved to fixed 80pt Group below grid (matching PatternSetupView)
  - **Missing validation on createNew**: Removed validation feedback (user asked to remove "flash"), but that also removed error display for invalid patterns. Fix: re-added `validationResult` + `validationFeedback` function matching PatternSetupView exactly
  - **SharedVaultInviteView incomplete**: Only checked `count >= 6`, no PatternValidator, no error messages, silently reset on confirm mismatch. Fix: added full PatternValidator validation, feedback area, "Patterns don't match" error
- **Files modified**: VaultSettingsView.swift (ChangePatternView — 3 rounds of fixes), SharedVaultInviteView.swift (added validation + feedback), AGENTS.md (pattern board rules), .scratch-pad.md
- **Key Learnings**:
  - Removing UI that "flashes" may actually remove essential feedback — understand WHY it flashes before removing. The flash was because valid patterns immediately transition to next step.
  - SwiftUI layout stability requires fixed heights for ALL variable-content areas: subtitles, feedback sections, button stacks
  - Pattern board screens have 3 categories (create, confirm, enter-existing) each with specific required behaviors — documented in AGENTS.md
  - When user says "remove this" about a specific UI element, clarify whether they mean (a) remove the feature entirely, or (b) fix the specific problem (flash/position/style)
- **Error**: Prematurely removed validation feedback from ChangePatternView when user only wanted the brief flash fixed. Re-added with proper behavior.

### Session 21 — Video Performance: Import Speed, Duration Badge, Playback, Viewer Fix (Feb 13, 2026)
- **Query**: Fix 4 video issues: FullScreenPhotoViewer infinite spinner, no duration badge, slow import (entire file in memory), slow playback
- **Approach**: Bottom-up implementation — CryptoEngine (new methods) → VaultStorage (duration field, URL-based methods) → VaultView (duration, masterKey) → VaultView+Actions (URL import) → FullScreenPhotoViewer (video support) → SecureVideoPlayer (stream decrypt) → PhotosGridView (badge)
- **Root Causes**:
  - **Viewer spinner**: `loadFullImage` only handled `image/` mimeType — videos silently failed the guard, leaving permanent ProgressView
  - **No duration**: VaultFileEntry/LightweightFileEntry/VaultFileItem had no duration field
  - **Slow import**: `loadVideoData` loaded entire video into RAM via `Data(contentsOf:)`, then `storeFile` encrypted entire blob in single shot
  - **Slow playback**: `retrieveFile` read+decrypted entire file to Data, then wrote Data to temp file
- **Changes (7 files, +453/-114 lines)**:
  - CryptoEngine: `encryptFileFromURL` (reads via FileHandle, VCSE for >1MB), `decryptFileToTempURL` + `decryptStreamingToFile` (stream-decrypt 256KB chunks to file), `decryptFile` now uses `decryptStaged` for backward compat
  - VaultStorage: `duration: TimeInterval?` in VaultFileEntry (both inits) + LightweightFileEntry, `storeFileFromURL` (URL-based encryption), `retrieveFileToTempURL` (stream-decrypt to temp), updated deleteFile/deleteFiles/compactBlobs to preserve duration
  - VaultView: `duration` in VaultFileItem, pass `masterKey` to FullScreenPhotoViewer
  - VaultView+Actions: `loadVideoURL` (copies to temp dir, returns URL), `generateVideoMetadata` (thumbnail + duration from URL), restructured `performPhotoImport` video path (URL-based), updated `performFileImport` for video URLs
  - FullScreenPhotoViewer: `masterKey` param, video thumbnail decryption, play button overlay, SecureVideoPlayer via `.fullScreenCover`
  - SecureVideoPlayer: `retrieveFileToTempURL` replaces `retrieveFile` + manual temp write
  - PhotosGridView: duration badge overlay with `formatDuration` helper
- **Errors**: None — first-attempt build success
- **Key Learnings**:
  - Adding optional fields to Codable structs with `nil` defaults is backward compatible — auto-synthesized decoder treats missing keys as nil
  - `provider.loadFileRepresentation` provides ephemeral URLs — must `FileManager.copyItem` before callback returns
  - `AVAsset.load(.duration)` is the async way to get video duration (returns CMTime), use `CMTimeGetSeconds` + `isFinite` guard
  - Duration badge goes `bottomLeading` to avoid collision with edit mode selection circle at `bottomTrailing`
  - `NSItemProvider.suggestedName` often lacks extension — use temp URL's extension or explicit fallback
  - When restructuring a loop that had shared tuple assignment, splitting into separate `if/else` branches with their own storage calls is cleaner than variable-scoping gymnastics

### Session 22 — 50MB Blob + Multi-Blob Backup + Paywall Button Fix (Feb 13, 2026)
- **Queries**: (1) Implement 6-change plan: reduce blob from 500MB→50MB, multi-blob iCloud backup with chunked uploads, (2) CloudKit Dashboard instructions, (3) deploy build 25, (4) fix paywall button lag
- **Approach**: Sequential implementation of all 6 changes, then investigated paywall lag root cause
- **Changes (7 files, ~600 lines)**:
  - VaultStorage.swift: `defaultBlobSize` 50MB, `cursorFooterOffset()` for legacy blob compat, `secureOverwrite(url:)` for variable-size wipe
  - iCloudBackupManager.swift: Full v2 multi-blob payload format, chunked upload/download (max 4 concurrent), backward-compat restore
  - Tests + 4 doc files updated
- **Paywall fix**: `AnalyticsManager.setEnabled()` used `Task { @MainActor in }` which ran `TelemetryDeck.initialize()` synchronously on main actor during analytics→paywall transition. Changed to `Task.detached(priority: .utility)` so all SDK init runs off main thread.
- **Errors**:
  - `xcodebuild -exportArchive` with `destination: upload` failed with "Failed to Use Accounts" — removed `destination` key, exported IPA locally, uploaded via `asc builds upload`
- **Key Learnings**:
  - `cursorFooterOffset()` pattern: derive cursor position from actual file size, not the constant — handles legacy 500MB blobs after `defaultBlobSize` changes to 50MB
  - `secureOverwrite()` must use actual file size, not `defaultBlobSize` — old 500MB blobs would only get first 50MB wiped
  - Analytics SDK init (`TelemetryDeck.initialize()`, `SentrySDK.start()`) should ALWAYS use `Task.detached` — main-actor initialization blocks UI transitions
  - `xcodebuild -exportArchive` without `destination: upload` in ExportOptions exports IPA locally; upload separately via `asc builds upload`

### Session 23 — Gallery UX, Photo Viewer Paging, Dynamic Island, Keyboard Sheet, Date Grouping, Build 30 (Feb 14, 2026)
- **Queries**: 6 sequential fixes: (1) photo viewer paging stuck between swipes, (2) change pattern validation flash between steps 2→3, (3) Dynamic Island not updating when backgrounded, (4) date grouping replace "Today/Earlier" with per-day groups + section spacing, (5) keyboard pushes sheet background up (recurring), (6) deploy build 30 to TestFlight
- **Approach**: Each fix investigated for root cause, minimal targeted fix, build verification
- **Files modified**: FullScreenPhotoViewer.swift (.simultaneousGesture), VaultView+Toolbar.swift (header background), VaultSettingsView.swift (validation flash), BackgroundShareTransferManager.swift (Timer→Task), VaultView.swift (date grouping), VaultView+Grid.swift (section spacing + sort), PatternLockView.swift (.ignoresSafeArea), JoinVaultView.swift (.ignoresSafeArea), project.pbxproj (build 30)
- **Root Causes**:
  - **Photo viewer stuck**: `.gesture(dragToDissmissGesture)` on TabView consumes gesture, blocking page swipe. Fix: `.simultaneousGesture()` allows both drag-to-dismiss and TabView page swipe to coexist
  - **Validation flash**: `validationResult` set via `await MainActor.run` BEFORE async key derivation. During async gap, UI renders feedback because `validationResult` set and `step == .createNew` still true. Fix: only set `validationResult` when pattern is invalid; when valid, skip feedback and go straight to `.confirmNew`
  - **Dynamic Island stuck**: `Timer.scheduledTimer` runs on main RunLoop in `.default` mode. When app backgrounds, RunLoop stops firing `.default` timers. Fix: replace with `Task { while !Task.isCancelled { tick(); try? await Task.sleep(for: .milliseconds(500)) } }` — Task.sleep works in background with beginBackgroundTask
  - **Date grouping "Today/Earlier"**: Hardcoded 5-bucket system. Fix: `Calendar.startOfDay(for:)` for per-day grouping, "Today"/"Yesterday" for relative days, formatted date for older. ISO8601 date as unique group ID
  - **Keyboard sheet jump (RECURRING 3rd time)**: Sheets are independent view hierarchies — parent's `.ignoresSafeArea(.keyboard)` doesn't propagate. Fix: added modifier to RecoveryPhraseInputView, JoinVaultView, CustomRecoveryPhraseInputView
- **Tests added**: DateGroupingTests (14 tests — today/yesterday labels, per-day grouping, sort order, media/files split, nil dates, unique IDs), VaultFileItemTests (13 tests — isImage, isMedia, duration)
- **Key Learnings**:
  - `.gesture()` on a TabView blocks its internal page swipe — always use `.simultaneousGesture()` when combining gestures with TabView
  - `Timer.scheduledTimer` stops in background (RunLoop `.default` mode stops). `Task.sleep` continues with `beginBackgroundTask`. ActivityKit budget: ~2/sec (500ms) is reasonable, ~6/sec (170ms) is excessive
  - Async state update race: setting state in `await MainActor.run` before an async gap creates a window where UI briefly renders intermediate state. Fix: skip intermediate state when transitioning, only set it when staying on current step
  - `Calendar.startOfDay(for:)` + ISO8601 date as group ID is the clean pattern for day-based grouping — avoids title collisions across years
  - `LazyVStack` pinned section headers: use `Color.vaultBackground` (opaque) not `.ultraThinMaterial` (translucent) to prevent scroll content showing through

### Session 24 — Locked Screen Sheet Jump on Text Focus (Feb 14, 2026)
- **Query**: Locked vault background jumps when opening Join Shared Vault or Recovery and tapping text input
- **Approach**: Reviewed `PatternLockView`, `JoinVaultView`, and `RecoveryPhraseInputView`; found keyboard-safe-area modifiers present but sheet presentation still using default detents; pinned both lock-screen sheets to `.presentationDetents([.large])` to keep presentation height stable when keyboard appears
- **Files modified**: PatternLockView.swift (sheet detents + recovery accessibility IDs), `apps/ios/maestro/flows/core/locked_sheet_keyboard_stability.yaml` (new regression flow), apps/ios/AGENTS.md, .scratch-pad.md
- **Tests added**: `apps/ios/maestro/flows/core/locked_sheet_keyboard_stability.yaml` (covers Join Shared Vault and Recovery keyboard-focus stability on lock screen)
- **Errors**:
  - `xcodebuild` destination by simulator name failed due duplicate/case-variant device names. Re-ran build with explicit simulator UUID.
  - Maestro could not match `unlock_recovery_cancel`/`unlock_recovery_phrase_input` in Recovery sheet via id selectors; switched flow to visible text for cancel and coordinate tap for `TextEditor` focus.
- **Key Learnings**:
  - Keyboard-safe-area modifiers alone may not prevent visible lock-screen background movement if sheet detents are allowed to auto-shift on text focus
  - For lock-screen input sheets, set `.presentationDetents([.large])` where the sheet is presented
  - In Maestro, SwiftUI `TextEditor` fields in sheets may need `point` taps instead of id selectors for reliable focus/input.

### Session 25 — Vault Grid/Header Seam Removal (Feb 14, 2026)
- **Query**: Remove visible gap/seam between search controls and first date section header in vault grid
- **Approach**: Traced VaultView layout; identified `safeAreaInset(edge: .top)` default spacing as seam source; set top inset to `spacing: 0`; updated Maestro `vault_with_files` flow with search-field assertion for top-controls coverage
- **Files modified**: `apps/ios/Vault/Features/VaultViewer/VaultView.swift`, `apps/ios/maestro/flows/core/vault_with_files.yaml`, `apps/ios/AGENTS.md`, `.scratch-pad.md`
- **Validation**:
  - `xcodebuild` Debug simulator build succeeded
  - `maestro test apps/ios/maestro/flows/core/vault_with_files.yaml` passed
  - Captured simulator screenshot after fix confirmed seam removed (`outputs/vault_gap_check.png`)
- **Key Learnings**:
  - `safeAreaInset` default spacing is easy to miss and can manifest as thin visual gaps in pinned-header scroll layouts

### Session 26 — Change Pattern Error Replacement Fix (Feb 14, 2026)
- **Query**: On "Create New Pattern", one shown error stays stuck and newer errors don't replace it
- **Approach**: Traced `ChangePatternView` create-step state handling; found feedback precedence (`validationResult` shown before `errorMessage`) plus branches that didn't clear counterpart state. Added explicit state clearing in all branches and guarded against concurrent pattern-processing tasks.
- **Files modified**: `apps/ios/Vault/Features/Settings/VaultSettingsView.swift`, `apps/ios/maestro/flows/settings/change_pattern.yaml`, `apps/ios/AGENTS.md`, `.scratch-pad.md`
- **Validation**:
  - `xcodebuild` Debug simulator build succeeded
  - `maestro test apps/ios/maestro/flows/settings/change_pattern.yaml` passed (optional create-step assertion warned due swipe non-determinism)
- **Key Learnings**:
  - In SwiftUI, branch order in conditional UI (`if validationResult ... else if errorMessage ...`) makes state-cleanup mandatory when two feedback models coexist
  - Async pattern checks require `isProcessing` guard/disabled grid to avoid overlapping tasks that can race and overwrite feedback state

### Session 27 — Deterministic Maestro Hook for Change Pattern Error Replacement (Feb 14, 2026)
- **Query**: Add deterministic automated test for create-step error replacement behavior
- **Approach**: Added simulator-only test hooks in `ChangePatternView` (`change_pattern_test_skip_verify`, `change_pattern_test_set_validation_error`, `change_pattern_test_set_reused_error`) and a dedicated Maestro flow asserting stale validation errors are removed when reused-pattern error is shown.
- **Files modified**: `apps/ios/Vault/Features/Settings/VaultSettingsView.swift`, `apps/ios/maestro/flows/settings/change_pattern_error_replacement.yaml`, `apps/ios/maestro/flows/settings/change_pattern.yaml`, `apps/ios/AGENTS.md`, `.scratch-pad.md`
- **Validation**:
  - `xcodebuild` Debug simulator build succeeded
  - Installed fresh build via `simctl install` (critical)
  - `maestro test apps/ios/maestro/flows/settings/change_pattern_error_replacement.yaml` passed
  - `maestro test apps/ios/maestro/flows/settings/change_pattern.yaml` passed
- **Key Learnings**:
  - Simulator test hooks should be runtime-gated to non-production contexts and exposed via stable accessibility IDs
  - Maestro uses the installed app bundle; stale installs can make new test IDs appear "missing"

### Session 28 — Review Implementation Wave: Flow State, Streaming IO, Batch Sharing, Derived View Data (Feb 14, 2026)
- **Query**: Implement all approved review actions (`1a 2a 3a 4a`) across architecture, code quality, tests, and performance.
- **Approach**:
  - Extracted `ChangePatternFlowState` + `ChangePatternStep` and migrated `ChangePatternView` to explicit transition helpers.
  - Added unit coverage for flow-state precedence/reset/processing behavior.
  - Replaced import-time whole-file `Data(contentsOf:)` usage with URL-based storage and URL-based image thumbnail generation.
  - Added `FileHandle`-based streaming temp retrieval for VCSE path to avoid full encrypted-entry loads.
  - Batched consumed-state lookups in sharing sync/list paths.
  - Consolidated VaultView visible-data derivation into one pass and threaded into grid/viewer code paths.
  - Hardened Maestro settings flows with stronger deterministic assertions.
- **Files modified**: `VaultSettingsView.swift`, `PatternSetupCoordinatorTests.swift`, `FileUtilities.swift`, `VaultView+Actions.swift`, `CryptoEngine.swift`, `VaultStorage.swift`, `VaultStorageIntegrationTests.swift`, `CloudKitSharingManager.swift`, `ShareSyncManager.swift`, `ShareVaultView.swift`, `VaultView.swift`, `VaultView+Grid.swift`, `change_pattern.yaml`, `recovery_phrase.yaml`, `apps/ios/AGENTS.md`, `.scratch-pad.md`.
- **Validation**:
  - `build_sim` passed (Vault scheme, iOS simulator).
  - `test_sim` passed (192/192).
  - Targeted `ChangePatternFlowStateTests` passed (5/5).
  - Maestro flows passed: `settings/change_pattern.yaml`, `settings/change_pattern_error_replacement.yaml`, `settings/recovery_phrase.yaml`.
- **Key Learnings**:
  - Mutually exclusive UI feedback state (`validationResult` vs `errorMessage`) is safest when encoded via explicit transition APIs and unit tested.
  - Streaming decrypt pathways can silently regress to full-memory reads if retrieval APIs parse headers from in-memory blobs instead of `FileHandle` streams.
  - Sharing/status list surfaces should prefer batch fetch APIs over per-item lookups to avoid hidden N+1 latency.
  - Large SwiftUI bodies with repeated filters/maps should compute derived collections once per render pass and pass them down.

### Session 29 — Viewer Swipe Anchoring + Lock-Screen Modal Stability + Top Controls Breathing Room (Feb 14, 2026)
- **Query**: Fix remaining gallery swipe overflow between photos, lock-screen join/recovery keyboard jump artifacts, and add a little background/buffer below search controls.
- **Approach**:
  - Full-screen viewer: removed competing drag-to-dismiss gesture on the paged `TabView`, switched to deterministic indexed tags, and enforced full-frame clipped page layout.
  - Lock screen: made `PatternLockView` background explicitly opaque and moved Join/Recovery presentations to `.fullScreenCover` to isolate keyboard/input modals from underlying vault surfaces.
  - Vault top controls: added intentional bottom padding in `topSafeAreaContent` so pull-down states have breathing room under search/filter controls.
  - Maestro: hardened viewer swipe navigation flow to use deterministic grid tap coordinates and multiple swipe assertions.
- **Files modified**: `FullScreenPhotoViewer.swift`, `PatternLockView.swift`, `JoinVaultView.swift`, `VaultView+Toolbar.swift`, `photo_navigation.yaml`, `apps/ios/AGENTS.md`, `.scratch-pad.md`.
- **Validation**:
  - `build_sim` passed.
  - `test_sim` passed (192/192).
  - Maestro flows passed: `viewer/photo_navigation.yaml`, `core/locked_sheet_keyboard_stability.yaml`, `core/vault_with_files.yaml`.
- **Key Learnings**:
  - Page-style `TabView` stability is sensitive to competing gestures; if swipe anchoring regresses, remove or isolate extra drag gestures first.
  - For security-sensitive lock surfaces, transparency is risky even if logic is correct; opaque backgrounds prevent visual bleed-through during transitions.
  - Maestro `tapOn index` is brittle when screen chrome changes; coordinate or id-based selectors are more stable for viewer-entry flows.

### Session 30 — Native-Like Photo Paging Investigation + Stable Viewer Presentation (Feb 14, 2026)
- **Query**: Gallery photo viewer still overflows past image while swiping; investigate against native Photos behavior and ensure proper anchoring.
- **Approach**:
  - Traced viewer architecture and identified identity churn: `VaultView` used `fullScreenCover(item:)` with item id tied to the active photo index.
  - Replaced with stable boolean presentation (`fullScreenCover(isPresented:)`) and kept index as independent state, clamped on open.
  - Kept full-frame clipped page layout in `FullScreenPhotoViewer` and reran viewer + lock-sheet + top-controls regressions.
- **Files modified**: `VaultView.swift`, `apps/ios/AGENTS.md`, `.scratch-pad.md`.
- **Validation**:
  - `build_sim` passed.
  - `test_sim` passed (192/192).
  - Maestro flows passed: `viewer/photo_navigation.yaml`, `core/locked_sheet_keyboard_stability.yaml`, `core/vault_with_files.yaml`.
- **Key Learnings**:
  - Native-like paging requires stable presentation identity; swiping state should never drive modal identity.
  - `fullScreenCover(item:)` is safe for stable entities, not for rapidly changing indices.

### Session 31 — Native Photos-Style Pager Rewrite (Feb 14, 2026)
- **Query**: Viewer still reported as drifting past image boundaries after stable cover identity fix.
- **Approach**:
  - Replaced `TabView(.page)` with explicit horizontal pager using `ScrollView(.horizontal)` + `LazyHStack(spacing: 0)` + `.scrollTargetBehavior(.paging)` + `.scrollPosition(id:)`.
  - Synced pager id and `currentIndex` bidirectionally with guards to prevent feedback loops.
  - Kept page width fixed to viewport width and clipped each page to enforce hard per-page anchors.
- **Files modified**: `FullScreenPhotoViewer.swift`, `apps/ios/AGENTS.md`, `.scratch-pad.md`.
- **Validation**:
  - `build_sim` passed.
  - `test_sim` passed (192/192).
  - Maestro flows passed: `viewer/photo_navigation.yaml`, `core/locked_sheet_keyboard_stability.yaml`, `core/vault_with_files.yaml`.
- **Key Learnings**:
  - `ScrollView` paging APIs can be more deterministic than `TabView(.page)` when tight control over page anchors is required.
  - Maintaining a dedicated `pageScrollID` state lets the view absorb gesture updates without destabilizing modal presentation state.

### Session 32 — App Settings Appearance Mode (System / Light / Dark) (Feb 14, 2026)
- **Query**: Add an app settings option to switch between dark, light, and system mode.
- **Approach**:
  - Added `AppAppearanceMode` enum and persisted appearance state in `AppState` (`appAppearanceMode` key).
  - Applied appearance globally at app root via `.preferredColorScheme(appState.appearanceMode.preferredColorScheme)`.
  - Added segmented `Appearance` picker to `AppSettingsView` with explicit setter binding (`app_appearance_picker`).
  - Added/updated Maestro coverage for settings visibility and mode switching.
- **Files modified**: `VaultApp.swift`, `SettingsView.swift`, `app_settings.yaml`, `appearance_mode.yaml`, `apps/ios/AGENTS.md`, `.scratch-pad.md`.
- **Validation**:
  - `build_sim` passed.
  - `test_sim` passed (192/192).
  - Maestro flows passed: `settings/app_settings.yaml`, `settings/appearance_mode.yaml`, `settings/toggle_settings.yaml`, `viewer/photo_navigation.yaml`, `viewer/dismiss_with_swipe_down.yaml`.
- **Key Learnings**:
  - Appearance mode should be a single app-level source of truth; per-view color scheme overrides make behavior inconsistent.
  - Segmented picker with explicit `AppState` setter keeps persistence explicit and testable.

### Session 33 — Dark Mode Palette Readability Tuning (Feb 14, 2026)
- **Query**: Improve dark mode color readability while keeping light mode palette mostly unchanged.
- **Approach**:
  - Reviewed Figma’s color-combination guidance (harmony + contrast + dominant/support/accent role separation).
  - Tuned dark-only asset appearances for `VaultBackground`, `VaultSurface`, `VaultSecondaryText`, and `AccentColor`.
  - Kept all light-mode token values unchanged to preserve current look.
  - Updated theme documentation comments to reflect the new dark token intent.
- **Files modified**: `VaultBackground.colorset`, `VaultSurface.colorset`, `VaultSecondaryText.colorset`, `AccentColor.colorset`, `VaultTheme.swift`, `apps/ios/AGENTS.md`, `.scratch-pad.md`.
- **Validation**:
  - `build_sim` passed.
  - `test_sim` passed (192/192).
  - Maestro flows passed: `settings/appearance_mode.yaml`, `settings/app_settings.yaml`.
- **Key Learnings**:
  - Dark-mode legibility is most reliably improved by lifting base/surface luminance and secondary text opacity at token level, not by scattered per-view overrides.
  - A dark-specific accent variant can improve discoverability without disrupting light-mode brand color.

### Session 35 — 3 Bug Fixes: Import Memory Crash, File Sorting, Appearance Mode (Feb 15, 2026)
- **Query**: Fix 3 user-reported bugs: (1) newly added files sort under "December 31" until lock/unlock, (2) share extension import stuck with spinner, (3) system appearance mode still not working (4th attempt)
- **Root Causes**:
  - Sorting: `VaultFileItem` appended without `createdAt` → nil → `.distantPast` → "December 31". Fixed by adding `createdAt: Date()` to all 5 append sites in VaultView+Actions.
  - Import: `ImportIngestor.processBatch` loaded entire encrypted files into memory via `Data(contentsOf:)`, then decrypted to another in-memory copy. For 20 files with large videos, this caused OOM. Fixed with `CryptoEngine.decryptStagedFileToURL` that streams decryption via FileHandle (~256KB peak). Also added `StagedImportManager.encryptedFileURL` to get file URL without loading data.
  - Appearance: `.preferredColorScheme()` (SwiftUI) conflicted with `window.overrideUserInterfaceStyle` (UIKit). When switching from explicit (light/dark) back to nil (system), SwiftUI failed to revert. Fixed by removing ALL `.preferredColorScheme()` calls and relying solely on UIKit with `UIWindow.didBecomeKeyNotification` observer for new windows.
- **Also fixed**: Notification count mismatch (showed per-session count instead of total pending). Changed to use `StagedImportManager.pendingFileCount(for:)` for accurate total.
- **Tests**: 271 pass (3 new tests for `decryptStagedFileToURL`). Build 41 → TestFlight.
- **Key Learnings**:
  - `.preferredColorScheme(nil)` does NOT reliably revert to system after being set to `.light`/`.dark` — use UIKit `overrideUserInterfaceStyle = .unspecified` exclusively
  - `UIWindow.didBecomeKeyNotification` catches new windows from fullScreenCovers/sheets — better than per-view `.onAppear` calls
  - File-to-file decryption (`decryptStagedFileToURL`) with format auto-detection avoids O(2n) memory for each imported file

### Session 36 — 3 More Bug Fixes: Import Guard Race, Paywall Trial, Extension Sleep (Feb 15, 2026)
- **Query**: Fix 3 user-reported bugs: (1) import still not working (spinner forever), (2) paywall trial checkbox unchecks when switching plans, (3) phone sleeps during share extension encryption
- **Root Causes**:
  - Import: `PendingImportBanner` button set `isImporting = true` (bound to `$isImportingPendingFiles`) BEFORE calling `onImport()`. `importPendingFiles()` then hit `guard !isImportingPendingFiles else { return }` and bailed immediately. Spinner stayed forever because nothing reset the flag. Fix: removed premature `isImporting = true` from banner button.
  - Paywall: `planCard` onTapGesture set `trialEnabled = false` for non-annual plans but never reset to `true` when selecting annual again. Fix: `trialEnabled = type == .annual` (unconditional).
  - Extension sleep: Share extension had no idle timer management during encryption. Fix: KVC access to `UIApplication.shared` via `NSClassFromString`/`perform(selector)` since extensions can't use it directly at compile time.
- **Tests**: 271 pass. Build 42 → TestFlight.
- **Key Learnings**:
  - **@Binding + guard = classic race**: When a child view sets a @Binding flag and immediately calls a parent callback that guards on that same flag, the callback sees the updated state and bails. Always let the function that owns the guard be the one to set the flag.
  - **Extension UIApplication access**: `NSClassFromString("UIApplication")` + `perform(NSSelectorFromString("sharedApplication"))` + `setValue(_:forKey:)` works at runtime in app extensions even though compile-time API is restricted.
  - **Paywall state symmetry**: When toggling state based on selection (e.g., trial checkbox), always handle BOTH the enable and disable cases — don't rely on default state surviving navigation.

### Session 37 — Crash-Resilient Incremental Import (Feb 15, 2026)
- **Query**: App crashes partway through importing 32 files from share extension, then re-imports all 32 on restart creating duplicates. Add deduplication/progress tracking.
- **Root Causes**:
  - No incremental progress — batch import was all-or-nothing. Crash during file 15/32 meant all 32 would be retried.
  - No `autoreleasepool` per file — UIImage/CGImage/AVAsset temporaries accumulated across all files, causing OOM crash.
- **Fix**:
  - Delete `.enc` (and `.thumb.enc`) after each successful file import. On retry, missing `.enc` = already imported → skip.
  - Wrap each file's processing in `autoreleasepool` to release Foundation/UIKit temporaries between files.
  - Added `StagedImportManager.deleteEncryptedFile(batchId:fileId:)` and `encryptedThumbnailURL(batchId:fileId:)`.
  - Updated `ImportIngestorTests.testMissingEncryptedFileCountsAsFailed` → `testMissingEncryptedFileIsSkippedAsAlreadyImported`.
- **Tests**: 271 pass. Build 43 → TestFlight.
- **Key Learnings**:
  - **File-as-progress-marker pattern**: Instead of a separate progress DB, delete the input file after processing. Missing input = already done. Simple, crash-resilient, zero additional state.
  - **autoreleasepool in loops**: Any loop creating UIKit/Foundation temporaries (UIImage, CGImage, AVAsset) MUST wrap each iteration in `autoreleasepool` to prevent OOM in memory-constrained contexts.

### Session 38 — Streaming SVDF Build to Fix OOM During Vault Sharing (Feb 15, 2026)
- **Query**: Implement streaming SVDF construction to fix jetsam/OOM crash when sharing large vaults (96 files, 48.8MB video)
- **Root Cause**: `startBackgroundUpload` accumulated ALL re-encrypted `SharedFile` objects in a `sharedFiles` array (~vault_size), then `SVDFSerializer.buildFull` copied them all into a new `Data` blob (~vault_size again). Peak memory = 2x total vault size (~200MB for crashing vault).
- **Fix**:
  - Added `SVDFSerializer.buildFullStreaming(to:fileCount:forEachFile:metadata:shareKey:)` — writes SVDF entries to disk via FileHandle one at a time. Each SharedFile is encoded, written, then freed.
  - Replaced `sharedFiles` array accumulation in `BackgroundShareTransferManager.startBackgroundUpload` with streaming call. Closure decrypts + re-encrypts each file, caches it to ShareSyncCache, returns SharedFile which gets serialized to disk and released.
  - Eliminated post-upload per-file sync cache loop (now done during streaming).
  - SVDF streamed directly to `Self.svdfURL` (pending upload location) — avoids redundant copy.
- **Memory profile**: Peak drops from O(2 * vault_size) to O(vault_size) — the remaining peak is reading SVDF back for CloudKit upload.
- **Tests**: Build clean, zero warnings.
- **Key Learnings**:
  - FileHandle streaming with `handle.write()` + `handle.offsetInFile` + `handle.seek(toFileOffset:)` is an effective pattern for building large binary files without memory spikes.
  - Synchronous closure `(Int) throws -> T` inside a Task.detached inherits the task context — `Task.checkCancellation()` works correctly for cooperative cancellation.
  - Per-file progress (1-5% range) is negligible — acceptable to batch-update after streaming completes.

### Session 39 — Further Memory Optimization + Deploy Build 47 (Feb 15, 2026)
- **Query**: Continue from session 38 — build 45 still crashed, apply deeper memory optimization
- **Root Cause**: `encodeFileEntry` copies `file.encryptedContent` into an intermediate `Data` buffer (`entry.append(file.encryptedContent)`) — doubling peak memory for large files (~49MB video). Also, decrypted content and encrypted content coexist in memory longer than necessary.
- **Fix**:
  - Added `writeFileEntryStreaming(_:to:)` — writes file header fields to a small Data buffer, then writes `file.encryptedContent` directly to FileHandle (no copy).
  - Updated `buildFullStreaming` to use `writeFileEntryStreaming` instead of `encodeFileEntry`.
  - Tightened content scope in `BackgroundShareTransferManager.forEachFile` closure — wrapped decrypted `content` in a `do {}` block so it's freed immediately after encryption, before thumbnail/cache work.
- **Embrace migration collision**: Working directory had uncommitted Embrace SDK migration changes (beads #111-#114) mixed with streaming changes. Build failed on EmbraceManager.swift errors. Fixed by: stashing Embrace files (which didn't properly revert working tree), then manually replacing all `EmbraceManager` → `SentryManager` in 16+ files.
- **Memory profile**: Peak drops from O(vault_size) to O(largest_file * 2) — only one file's decrypted + encrypted data in memory at a time.
- **Deploy**: Build 47 → TestFlight (internal groups auto-receive). Builds 46 was already on ASC from unknown source.
- **Key Learnings**:
  - `git stash push -- file1 file2` saves diffs but may NOT revert the working tree — always verify with `git diff` after stash.
  - `encodeFileEntry` with `entry.append(largeData)` creates a second copy — for large files, write header and content separately to FileHandle.
  - `do {}` blocks in Swift create a scope that forces early deallocation of `let` bindings — useful for releasing large Data before the enclosing function scope ends.
  - When mixing multiple feature branches in working directory, isolate changes by stashing/reverting unrelated work before building.

### Session 40 — Onboarding Analytics Crash Fix + TestFlight Build 49 (Feb 15, 2026)
- **Query**: App crashes on clean install during onboarding when tapping "Enable Analytics".
- **Root Cause**: `EmbraceManager.start()` called `Embrace.setup(...).start()` inside `Task.detached`. Embrace `HangCaptureService` enforces queue affinity and hit `dispatch_assert_queue` (`EXC_BREAKPOINT`) when initialized off main queue.
- **Fix**:
  - Updated `EmbraceManager.start()` to execute setup/start directly on `@MainActor` (removed `Task.detached` wrapper).
  - Added failure rollback (`isStarted = false`, `hasSetup = false`) so failed setup can retry safely.
- **Validation**:
  - `xcodebuild test` passed: 271/271.
  - Reproduced failing Maestro flow (`analytics_enable_crash_check`) before fix and confirmed pass after fix.
  - Uploaded build 49 to TestFlight and confirmed `processingState: VALID`; assigned to beta group `Internal Testers`.
- **Key Learnings**:
  - Embrace startup APIs are thread-sensitive; treat setup/start as main-queue-only initialization.
  - Crash reports with `dispatch_assert_queue` + `HangCaptureService` are a direct signal of incorrect Embrace initialization threading.

### Session 34 — TestFlight Build 35 Upload (Feb 14, 2026)
- **Query**: Send latest app update to TestFlight.
- **Approach**:
  - Bumped `CURRENT_PROJECT_VERSION` from 34 to 35.
  - Ran archive/export flow via `publish-testflight.sh`; archive succeeded but export failed with `Failed to Use Accounts`.
  - Retried `xcodebuild -exportArchive` with ASC API key flags and upload succeeded.
  - Polled ASC until build `35` appeared and confirmed `processingState: VALID`.
- **Files modified**: `Vault.xcodeproj/project.pbxproj`, `apps/ios/AGENTS.md`, `.scratch-pad.md`.
- **Validation**:
  - Archive succeeded.
  - Upload succeeded.
  - ASC build detected: `14d8bf10-79ce-4b91-b5f4-f07db1c0c556` (`version: 35`, `processingState: VALID`).
- **Key Learnings**:
  - `xcodebuild` export/upload can fail without an active Xcode account session even when archive is valid; ASC API key flags make the flow deterministic in CI/headless environments.

### Session 41 — Share Encryption OOM Hardening + SVDF Bounds Safety (Feb 15, 2026)
- **Query**: App crashes around 1-2% during "Encrypting files..." when sharing vaults containing particular large files.
- **Root Cause**:
  - Share packaging path loaded whole decrypted file `Data` (`retrieveFileContent`) and then whole re-encrypted `Data` (`CryptoEngine.encrypt`) before writing to SVDF.
  - Peak memory scaled with `decrypted + encrypted` for the largest file; abrupt process termination matched jetsam/OOM behavior (no app exception stack in console snippet).
  - SVDF serializer had unchecked `UInt16`/`UInt32` casts for lengths/sizes that could trap on out-of-range values.
- **Fix**:
  - Added `SVDFSerializer.buildFullStreamingFromPlaintext(...)` + `StreamingSourceFile` and `writeFileEntryStreamingFromPlaintext(...)` to stream-encrypt plaintext temp files directly into SVDF output `FileHandle`.
  - Refactored `BackgroundShareTransferManager.startBackgroundUpload` to use `retrieveFileToTempURL(...)` + plaintext streaming serializer path; removed full-file in-memory re-encryption during initial share upload.
  - Added deterministic temp-file cleanup after each streamed entry.
  - Added numeric bounds validation helpers (`checkedUInt16`/`checkedUInt32`) in `SVDFSerializer` and converted unsafe casts to throwing errors.
  - Added oversized-file guard in incremental sync (`ShareSyncManager`) to skip uncached files >256MB rather than risk jetsam in in-memory re-encrypt path.
- **Validation**:
  - `xcodebuild test` via MCP passed: 274/274.
  - Share setup Maestro flow executed without regression in simulator (iCloud controls unavailable in sim as expected).
- **Key Learnings**:
  - OOM/jetsam terminations often invalidate scene/process without a Swift exception frame; treat "app vanished" logs during heavy crypto as memory-pressure suspects first.
  - Crash SDKs may miss `SIGKILL`/jetsam paths; add staged breadcrumbs and durable progress checkpoints around long-running crypto/upload phases.

### Session 42 — TestFlight Build 50 Push (Feb 16, 2026)
- **Query**: Push latest fixes to TestFlight.
- **Approach**:
  - Bumped `CURRENT_PROJECT_VERSION` from 47 → 50.
  - Archived + exported/uploaded with ASC API key flags to avoid account-session dependency.
  - Verified build `50` in ASC with `processingState: VALID`.
  - Added build to TestFlight group `Internal Testers` (group is external despite name).
- **Key Learnings**:
  - `asc builds list` (v0.28.7) has no `--version` filter; use JSON + `jq` on `.attributes.version`.
  - Group names are not authoritative for internal/external behavior; always verify `Internal` flag before deciding whether `add-groups` is needed.

### Session 43 — Dynamic Island Pixel Loader Speed Alignment (Feb 16, 2026)
- **Query**: Dynamic Island pixel loader looked too slow vs other pixel loaders.
- **Root Cause**: `BackgroundShareTransferManager` advanced `animationStep` every 500ms, while in-app `PixelAnimation.loading()` runs at 100ms cadence.
- **Fix**:
  - Set Live Activity animation tick to 100ms in `BackgroundShareTransferManager`.
  - Kept progress interpolation visually stable by increasing smoothing window from 5 ticks to 25 ticks.
  - Updated `TransferActivityAttributes` comment to reflect 0.1s tick cadence.
- **Validation**: Full iOS simulator tests passed (274/274).
- **Key Learnings**:
  - Dynamic Island `LivePixelGrid` speed is driven by host app `ContentState` update cadence, not by the widget itself.
  - If `animationStep` and in-app loader timer intervals diverge, users perceive inconsistent loader speed even when pattern/brightness are identical.

### Session 44 — Resume Upload Crash on Reopening Share Screen (Feb 16, 2026)
- **Query**: If upload is in progress, app is backgrounded, then reopened and Share Vault screen is opened, app crashes instead of resuming upload.
- **Root Cause**:
  - `BackgroundShareTransferManager.hasPendingUpload` called `loadPendingUpload()`, which eagerly read full `pending_upload/svdf_data.bin` into `Data` on the main thread.
  - For large pending uploads, simply rendering the share status banner could trigger a large memory spike and termination.
  - Resume path also rebuilt full in-memory chunk arrays from SVDF bytes before upload.
- **Fix**:
  - Replaced pending-load check with metadata-only `loadPendingUploadState()` (TTL + state decode + file existence), no blob read.
  - Added `CloudKitSharingManager.uploadChunksFromFile(...)` to stream missing chunks directly from disk by index.
  - Refactored `resumePendingUpload(...)` to upload from file URL and initialize `ShareSyncCache` via file copy + streamed chunk hashing.
  - Added `ShareSyncCache.saveSVDF(from:)` and `computeChunkHashes(from:)` for no-full-buffer resume finalization.
- **Validation**: Full iOS simulator tests passed (274/274).
- **Key Learnings**:
  - Never gate UI visibility checks on loading large payload blobs; resumability checks must be metadata-only.
  - Resume/retry paths need the same memory discipline as first-run paths, especially before upload starts.

### Session 45 — TestFlight Build 51 Release (Feb 16, 2026)
- **Query**: Push latest resume-upload crash fix to TestFlight.
- **Approach**:
  - Bumped iOS build number from 50 → 51 in `project.pbxproj`.
  - Archived (`Release`, generic iOS) and exported/uploaded with ASC API-key auth.
  - Verified build `51` reached `VALID` in ASC, then added it to group `Internal Testers`.
- **Validation**:
  - Archive succeeded (`** ARCHIVE SUCCEEDED **`).
  - Export/upload succeeded (`** EXPORT SUCCEEDED **`).
  - ASC build state: `VALID` at `2026-02-16T04:10:45-08:00`.
- **Key Learnings**:
  - Current `asc` CLI expects `--output json`; `--json` is not a valid flag.
  - `asc builds add-groups` works after build reaches `VALID` for external-style groups like `Internal Testers`.

### Session 46 — Dynamic Island Loader Freeze Between Progress Updates (Feb 16, 2026)
- **Query**: Dynamic Island pixel loader froze and only moved when upload percentage changed.
- **Root Cause**:
  - Loader rendering depended on `context.state.animationStep` updates from ActivityKit `ContentState`.
  - During uploads, ActivityKit can coalesce/throttle state updates, so animation frames stop between progress changes.
- **Fix**:
  - Added widget-side `TimelineView(.animation(minimumInterval: 0.1))` around `LivePixelGrid` in `TransferLiveActivityWidget`.
  - Kept `animationStep` as a base offset; timeline now advances frames continuously even when state updates are sparse.
  - Updated `LivePixelGrid` comments to reflect timeline-driven animation support.
- **Validation**: Full iOS simulator tests passed (274/274).
- **Key Learnings**:
  - Live Activity visuals should not rely exclusively on high-frequency `Activity.update` calls for animation smoothness.
  - For Dynamic Island loaders, use timeline-driven local animation and use state updates for semantic progress/status.

### Session 47 — TestFlight Build 52 Push (Feb 16, 2026)
- **Query**: Push current main branch to TestFlight.
- **Approach**:
  - Bumped iOS build number from 51 → 52 in `Vault.xcodeproj/project.pbxproj`.
  - Ran `scripts/publish-testflight.sh`; archive succeeded, export failed with `Failed to Use Accounts`.
  - Retried `xcodebuild -exportArchive` with ASC API key flags; upload succeeded.
  - Polled ASC until build `52` appeared and confirmed `processingState: VALID`.
  - Added build `9fe1a658-3e79-4cc4-a225-e616da9f9acd` to beta group `Internal Testers`.
- **Validation**:
  - Archive succeeded (`** ARCHIVE SUCCEEDED **`).
  - Export/upload succeeded on API-key retry (`** EXPORT SUCCEEDED **`).
  - ASC build state: `VALID` at `2026-02-16T04:39:08-08:00`.
- **Key Learnings**:
  - `asc builds latest --version` can temporarily miss a just-uploaded build; poll `asc builds list --sort -uploadedDate` instead.
  - Keep TestFlight completion criteria strict: build is visible in ASC, `processingState = VALID`, and target beta group assignment succeeds.

### Session 48 — Long-Running Upload Resilience + Auto Resume (Feb 16, 2026)
- **Query**: Ensure vault upload survives backgrounding longer than ~30s, keep Dynamic Island progress updates while running, and auto-resume interrupted uploads when vault is opened.
- **Approach**:
  - Added `BGTaskScheduler` integration (`app.vaultaire.ios.share-upload.resume`) in `BackgroundShareTransferManager` for deferred resume opportunities.
  - Added scheduling/cancellation/completion lifecycle for BG tasks and wired task expiration cancellation.
  - Added `resumePendingUploadIfNeeded(trigger:)` and a vault-key provider to auto-resume whenever key is available.
  - Hooked auto-resume into app lifecycle (`didBecomeActive`, `scenePhase == .active`) and vault lifecycle (`unlockWithPattern`, `VaultView` task/key-change).
  - Added Info.plist permissions for BG processing (`BGTaskSchedulerPermittedIdentifiers`, `UIBackgroundModes: processing`).
- **Validation**:
  - iOS simulator build passed for scheme `Vault`.
  - iOS simulator tests passed: 274/274.
- **Key Learnings**:
  - `BGProcessingTask` complements but does not replace immediate `beginBackgroundTask`; both are needed for robust continuation.
  - Auto-resume should be key-driven (when vault key is present), not screen-driven.

### Session 49 — TestFlight Build 53 Push (Feb 16, 2026)
- **Query**: Push latest main branch to TestFlight.
- **Approach**:
  - Bumped iOS build number from 52 → 53 in `Vault.xcodeproj/project.pbxproj`.
  - Ran `scripts/publish-testflight.sh`; archive succeeded, export failed with `Failed to Use Accounts`.
  - Retried export/upload with ASC API key flags and upload succeeded.
  - Polled ASC until build `53` appeared and confirmed `processingState: VALID`.
  - Added build `8cb92894-cec2-437d-9744-9a10d79ea19a` to beta group `Internal Testers`.
- **Validation**:
  - Archive succeeded (`** ARCHIVE SUCCEEDED **`).
  - Export/upload succeeded on API-key retry (`** EXPORT SUCCEEDED **`).
  - ASC build state: `VALID` at `2026-02-16T05:07:28-08:00`.
- **Key Learnings**:
  - ASC indexing delay can exceed two minutes; continue polling before declaring failure.
  - Build rows may appear already `VALID`, so gate on ASC state rather than upload timestamps.

### Session 50 — Share Extension Crash Near End of 37-file Batch (Feb 16, 2026)
- **Query**: Share extension crashes while adding many files (video evidence showed termination around "Encrypting 36 of 37 files"), then return to system share sheet.
- **Root Cause**:
  - Heavy per-file encryption/thumbnail work was running in `ShareViewController` main-actor execution path.
  - Extension kept full attachment provider references for the whole batch, increasing memory pressure.
  - Manifest was only written at the very end, so abrupt termination risked losing all staged progress.
- **Fix**:
  - Moved heavy per-file sync crypto/thumbnail work into non-main execution (`Task.detached`) in `ShareAttachmentProcessor`.
  - Replaced full attachment array retention with count-first + streaming provider iteration.
  - Added manifest checkpoint writes after each successfully staged file.
  - Added targeted per-file staging logs and made staged models `Sendable` for cleaner concurrency boundaries.
  - Cleaned test warnings (`@discardableResult` helper, removed unused var) to keep warning-clean validation.
- **Validation**:
  - iOS simulator build succeeded.
  - iOS simulator tests passed: 274/274.
- **Key Learnings**:
  - Share extension watchdog terminations can look like "silent return to share sheet" rather than explicit app errors.
  - Batch checkpointing turns abrupt extension termination into resumable staged progress instead of total loss.

### Session 51 — TestFlight Build 54 Push for Share-Extension Hardening (Feb 16, 2026)
- **Query**: Build, validate, and ship the share-extension crash hardening fix to TestFlight.
- **Approach**:
  - Ran simulator build/tests after implementation and removed remaining test warnings caused by unused test values.
  - Bumped iOS build number from 53 → 54.
  - Archived via publish script; export failed with `Failed to Use Accounts`.
  - Retried export/upload with ASC API key flags; upload succeeded.
  - Polled ASC until build `54` appeared `VALID`, then assigned group `Internal Testers`.
- **Validation**:
  - Simulator build succeeded.
  - Simulator tests passed: 274/274.
  - ASC build: `99a1c250-e3fb-4e97-bb55-8b5fa21202b2`, version `54`, `VALID`.
- **Key Learnings**:
  - Share-extension reliability fixes should ship with explicit regression evidence (full tests + warning cleanup), not only local repro confidence.
  - ASC indexing still requires polling patience even after immediate upload success.

### Session 52 — Dynamic Island Pixel Loader Re-alignment (Feb 16, 2026)
- **Query**: User reported Dynamic Island pixel loader visual drift; requirement is all pixel loaders must stay consistent across app and Dynamic Island.
- **Root Cause**:
  - Widget animation combined app-side `animationStep` and timeline ticks (`baseStep + timelineStep`), altering perceived loader cadence.
  - Trail opacity in `LivePixelGrid` had become longer than in-app fade overlap.
- **Fix**:
  - Switched widget loader to a single 0.1s timeline-driven step source.
  - Re-tuned `LivePixelGrid` trail opacity to head + 2 trailing cells to match in-app visual persistence.
- **Validation**:
  - iOS simulator build succeeded.
  - iOS simulator tests passed: 274/274.
- **Key Learnings**:
  - For cross-surface animation parity, cadence source matters as much as pattern/brightness.
  - Loader parity regressions are best fixed by simplifying the step pipeline, not layering additional offsets.

### Session 53 — Onboarding Completion Uses Unlock Ceremony (Feb 16, 2026)
- **Query**: At the end of onboarding, transition from recovery phrase to vault jumped with no animation; match the locked-state unlock animation.
- **Root Cause**:
  - `PatternSetupView` set `appState.isUnlocked = true` during pattern save, while onboarding UI was still visible.
  - `ContentView` unlock transition is keyed off `isUnlocked`, so the animation fired off-screen and was gone by the time onboarding dismissed.
- **Fix**:
  - Removed early `isUnlocked` mutation from `PatternSetupView`.
  - Converted `AppState.completeOnboarding()` to async ceremony: set onboarding complete, show `isLoading`, wait 1.5s, then set `isUnlocked`.
  - Reused one `unlockCeremonyDelayNanoseconds` constant for both onboarding completion and standard unlock path.
  - Updated `OnboardingView` to call the async completion path and updated onboarding Maestro flow to assert the `Unlocking...` transition.
- **Validation**:
  - iOS simulator build succeeded.
  - iOS simulator tests passed: 274/274.
- **Key Learnings**:
  - Root-view transition triggers must be tied to the moment the destination route is actually visible.
  - Centralizing unlock ceremony timing avoids drift between onboarding and lock-screen unlock UX.

---

## Cumulative Learnings

- **Session count**: 40
- **Build success rate**: 38/39
- **Key pattern**: Sequential workstream implementation with build gates works well for large multi-file UX changes
- **Architecture insight**: This codebase uses a 3-tier file model (VaultFileItem → LightweightFileEntry → VaultFileEntry) — changes to file metadata must propagate through all three
- **Sharing architecture**: BackgroundShareTransferManager (@MainActor, @Observable) → Task.detached for crypto work → CloudKitSharingManager for CloudKit ops. All crypto keys captured by value to survive vault lock.
- **Incremental sync**: SVDF v4 is append-stable (existing bytes never move). ShareSyncCache stores per-share encrypted files + SVDF blob + chunk hashes. Sync flow: diff file IDs → re-encrypt only new files (check cache first) → build SVDF incrementally → hash chunks → upload only changed chunks.
- **CloudKit idempotency**: ALWAYS fetch before save for deterministic record IDs. Never trust local cache to know whether a CloudKit record exists — the initial upload path, partial failures, and retries can all leave records that the cache doesn't know about. Use `fetchOrCreateRecord()` pattern everywhere.
- **Parallel CloudKit uploads**: `withThrowingTaskGroup` with bounded concurrency (4) handles rate limiting gracefully — `saveWithRetry` inside each task catches transient CKErrors. If one chunk fails hard, the group cancels remaining tasks via cooperative cancellation.
- **Code review workflow**: Architecture → Code Quality → Tests → Performance, max 4 issues per section, user approves before implementation. Works well for thorough reviews without scope creep.
- **Test infrastructure**: VaultTests target uses `@testable import Vault` with `TEST_HOST` pattern — no need to share source files between targets. TS prefix IDs for all pbxproj entries. 32 tests across 4 suites covering CryptoEngine, SVDFSerializer, ShareSyncCache, and SharedVaultData.
- **Resumable uploads**: Persist SVDF + metadata to `Documents/pending_upload/` before CloudKit upload. On resume, `existingChunkIndices()` queries CloudKit with cursor pagination, filters to missing chunks only, uploads them with parallel concurrency. 24h TTL auto-discards stale state. Duplicate share record guard prevents double-append to vault index.
- **Maestro E2E testing**: `#if DEBUG` test mode bypass with `-MAESTRO_TEST` launch arg provides deterministic key + auto-unlock + lock trigger bypass. 60+ accessibilityIdentifiers across all views enable Maestro element targeting. 30 YAML flows cover onboarding, core, camera, viewer, search, edit mode, settings, sharing, and premium features. 29/30 pass (96.7%) — only `import_from_library` fails due to system photo picker limitation. `-MAESTRO_SEED_FILES` flag pre-populates vault with test images for flows needing files.
- **Monorepo structure**: iOS at `apps/ios/`, web at `web/`, shared docs at `docs/`, design at `design/`. Root AGENTS.md has monorepo concerns (beads, git, sessions). Subproject AGENTS.md files have project-specific knowledge. Xcode relative refs survive moves as long as .xcodeproj and sibling dirs move together.
- **Link-based sharing**: ShareLinkEncoder uses version-byte prefix (0x01=raw, 0x02=deflate) + base58 encoding of phrases into URL fragments. DeepLinkHandler is `@Observable` and presented via `fullScreenCover` from ContentView regardless of lock state (safe since no vault data is exposed). SL prefix IDs in pbxproj. Requires AASA file + landing page on vaultaire.app for universal links to work (out of scope for iOS-only implementation).
- **VaultIndex creation**: NEVER use bare v1 init for new vaults — `loadIndex(with:)` auto-creates proper v3 with master key, blob descriptor, and correct version. Bare init creates a file that blocks auto-creation and has no master key, causing `storeFile` to throw.
- **Screen cloning discipline**: When replicating a flow (e.g., join vault pattern from onboarding), copy ALL behavior — validation, haptics, error messages, feedback UI, accessibility IDs. Partial clones create inconsistent UX and missing test coverage.
- **Pattern board normalization**: 3 categories — "create new" (full PatternValidator + feedback + strength), "confirm" (match error only), "enter existing" (minimal validation). All pattern screens documented in AGENTS.md with exact required behavior per category. NEVER modify one pattern screen without checking all others for consistency.
- **Mandatory Maestro rule**: Every visual/UI change requires corresponding Maestro test updates. Rule codified in `apps/ios/AGENTS.md` with checklist: new screens → new flows, new elements → accessibility IDs + assertions, changed text → updated assertions, changed navigation → updated flow sequences.
- **TestFlight pipeline**: Manual signing for Release configs (distribution cert + App Store profiles), automatic for Debug. ExportOptions.plist with `app-store-connect` + `destination: upload` for direct ASC upload. Sentry script phase must be AFTER Embed Foundation Extensions. Build script at `scripts/publish-testflight.sh`. First build: v1.0(1), ASC app ID `6758529311`, group "Internal Testers".
- **ASC post-upload visibility**: Fresh uploads may not be queryable by version immediately. For deterministic verification, poll `asc builds list --sort -uploadedDate --limit 20`, then gate completion on `processingState: VALID`.
- **Three-layer upload resilience**: Best reliability comes from combining immediate background time (`beginBackgroundTask`), scheduled recovery (`BGProcessingTask`), and persisted pending-upload metadata resumed on next unlock.
- **ASC verification discipline**: For deterministic TestFlight completion, always include: upload success, ASC row visibility, `processingState: VALID`, and beta-group assignment success.
- **Share extension large-batch hardening**: Keep encryption off main actor, avoid provider retention across full batches, and checkpoint `manifest.json` incrementally.
- **Release packaging discipline**: For crash-fix releases, pair functional fix commits with a dedicated build-number/TestFlight commit and confirm group assignment in ASC before handoff.
- **Pixel loader parity discipline**: Keep Dynamic Island loader on one cadence source and match in-app trail persistence; avoid additive step composition that changes speed.
- **Embrace startup threading**: Embrace 6.x capture services can assert queue constraints during startup (`dispatch_assert_queue` in `HangCaptureService`). Keep `Embrace.setup(...).start()` on `@MainActor`; do not wrap it in `Task.detached`.
- **Import progress timing**: PHPicker pre-loaded all images before showing progress, creating visible lag. Fix: pass `PHPickerResult` directly, set `importProgress` immediately on main actor, process incrementally (load → compress → encrypt → store → update). Also applies to file importer — set progress before `Task.detached`, not inside it.
- **Drag-to-select in grids**: Use PreferenceKey to collect cell CGRects, simultaneousGesture with DragGesture, direction-based activation (`dx > dy * 0.5` rejects vertical scrolls). First touched cell determines mode (select vs deselect). Track `dragAffectedIds` to prevent re-toggling. Replace Button with `.onTapGesture` to avoid gesture conflicts. Haptic via `UISelectionFeedbackGenerator().selectionChanged()`.
- **TestFlight internal groups**: Internal groups with `hasAccessToAllBuilds: true` automatically receive all builds — `asc builds add-groups` fails with "Cannot add internal group to a build." Don't try to manually assign builds to internal groups.
- **Free tier import enforcement**: Limit checks at the + button are insufficient — must also cap imports inside `handleSelectedPhotos`/`handleImportedFiles` to remaining free slots, import those, then show paywall if truncated.
- **Vault isolation security**: `Task.detached` with captured value-type keys is a security hazard — keys survive vault lock. Store task handles (`activeImportTask`), cancel on any vault key change (not just nil), and check `Task.isCancelled` after every async operation in import loops.
- **Batch storage operations**: Individual `deleteFile` calls do N load/save cycles (N crypto operations). Batch method with single load/save and blob-grouped file handle reuse provides 300x improvement.
- **Camera preview pattern**: `AVCaptureVideoPreviewLayer` as `override class var layerClass` is the correct pattern — creates the preview layer as the view's backing layer, auto-resizing without manual frame management. Sublayer approach has zero-frame issues.
- **ShareExtension version sync**: Always use `$(CURRENT_PROJECT_VERSION)` and `$(MARKETING_VERSION)` build setting variables in extension Info.plists — hardcoded values drift when main app bumps versions.
- **Structured logging pattern**: Subsystem `"app.vaultaire.ios"`, category matches class/feature name. Classes/actors use `private static let logger = Logger(...)` accessed via `Self.logger`. Structs/enums/views use file-level `private let xyzLogger = Logger(...)`. For `@MainActor` classes with `nonisolated` methods, MUST use file-level logger to avoid actor isolation issues. Log levels: `.trace()` for sensitive data (never log content), `.debug()` for routine ops, `.info()` for notable events, `.warning()` for non-fatal issues, `.error()` for failures. Privacy: `\(value, privacy: .public)` for non-sensitive interpolation.
- **SwiftUI gesture priority with TabView**: `.gesture()` on a TabView is a primary gesture that blocks internal paging. `.simultaneousGesture()` allows custom gestures and TabView paging to coexist. This is critical for drag-to-dismiss + page-swipe UX patterns.
- **Background timer alternatives**: `Timer.scheduledTimer` and `Timer.publish` both use RunLoop `.default` mode which stops in background. For background-critical updates (Dynamic Island, Live Activity), use `Task { while !Task.isCancelled { ... Task.sleep(for:) } }`. Apple's ActivityKit budget tolerates ~2 updates/sec.
- **Date grouping pattern**: `Calendar.startOfDay(for:)` for day bucketing, "Today"/"Yesterday" for relative days, `DateFormatter` with explicit `dateFormat` (not `doesRelativeDateFormatting`) for older dates. ISO8601 date string as unique group ID to handle cross-year title collisions. `LazyVStack(pinnedViews: .sectionHeaders)` with opaque `Color.vaultBackground` for headers.
- **Lock-screen sheet stability**: For sheets launched from `PatternLockView` that contain text input, keep keyboard-safe-area ignores on sheet roots and pin presentation detents to `.large` to avoid keyboard-triggered background jumps.
- **Maestro TextEditor fallback**: If an editor id is not discoverable, use `tapOn: point` before `inputText` instead of blocking on id selectors.
- **safeAreaInset spacing discipline**: Always set explicit spacing (`spacing: 0` when flush is required) for inset-driven top bars over scroll content to avoid unexpected seams.
- **Pattern create-step feedback discipline**: If both structured validation feedback and custom error messaging are possible, clear stale counterpart state on every branch and guard async checks with `isProcessing`.
- **Maestro install discipline**: After local code changes, reinstall the newly built simulator app before running Maestro to avoid false negatives from stale binaries.
- **Flow-state extraction for complex SwiftUI screens**: As interaction rules expand (step transitions, validation, async errors, test hooks), extract dedicated state structs with explicit transition methods and test them directly.
- **Batch consumed-state lookups**: Share lists/syncs should fetch consumed flags in one call, then map locally; per-share checks create avoidable N+1 behavior.
- **Single-pass visible-file derivation**: For media grids and viewers reading the same filtered set, compute once and reuse to reduce repeated O(n) work in `body`.
- **Lock-screen modal isolation**: Present lock-screen text-entry flows with full-screen presentation and opaque backgrounds to prevent keyboard-driven visual bleed/jump artifacts.
- **Pager stability over gesture richness**: For full-screen media paging, prioritize deterministic page snapping over drag-to-dismiss convenience when the two conflict.
- **Modal identity discipline**: Avoid tying modal identity to highly dynamic UI state (like current pager index); keep presentation identity stable and mutate internal state only.
- **Pager implementation choice**: If `TabView(.page)` remains unstable in production gestures, prefer `ScrollView` paging (`.scrollTargetBehavior(.paging)` + `.scrollPosition(id:)`) with explicit full-width pages.
- **Onboarding unlock parity**: Keep a single unlock-ceremony timeline shared by lock-screen unlock and onboarding completion so transition behavior stays identical across entry paths.
- **App-wide appearance mode**: Keep appearance mode in `AppState`, persist it in UserDefaults, and apply **exclusively** via `UIWindow.overrideUserInterfaceStyle`. **NEVER use `.preferredColorScheme()`** — it conflicts with UIKit window overrides and fails to revert from explicit (light/dark) back to system (.unspecified). Use `UIWindow.didBecomeKeyNotification` observer to catch new windows from fullScreenCovers/sheets.
- **ImportIngestor memory safety**: Never load entire encrypted files into memory for import. Use `CryptoEngine.decryptStagedFileToURL(from:to:with:)` which reads/decrypts via FileHandle with ~256KB peak memory for streaming format. Only single-shot files (≤1MB) are loaded into memory.
- **VaultFileItem createdAt**: Always pass `createdAt: Date()` when appending files to the in-memory `files` array. The default `nil` causes `groupFilesByDate` to treat files as `.distantPast` (December 31, year 0001). All 5 append sites in VaultView+Actions must include this.
- **@Binding + guard race condition**: When a child view sets `@Binding var isX = true` and calls `onAction()` in the same button, if the parent's function starts with `guard !isX else { return }`, the guard fails immediately because the binding already propagated. Always let the owning function set the guard flag.
- **Extension idle timer**: App extensions can't use `UIApplication.shared.isIdleTimerDisabled` directly. Use `NSClassFromString("UIApplication")` → `perform(NSSelectorFromString("sharedApplication"))` → `setValue(disabled, forKey: "idleTimerDisabled")` for runtime access.
- **File-as-progress-marker**: Delete input `.enc` files after each successful import. On crash+retry, missing `.enc` = already imported → skip. Zero additional state needed. Combined with `autoreleasepool` per iteration prevents OOM on large batches.
- **FileHandle streaming for large binary formats**: When building binary formats containing large blobs, write header fields to a small intermediate buffer and large content directly to FileHandle — avoids copying entire blob into a second Data buffer. `writeFileEntryStreaming` pattern: build small header Data, `handle.write(header)`, `handle.write(content)`.
- **Scope-based early deallocation**: Use `do {}` blocks to force `let` bindings out of scope early, triggering ARC deallocation before the enclosing function continues. Critical when decrypted and encrypted copies of the same file would otherwise coexist.
- **git stash push pathspec pitfall**: `git stash push -- file1 file2` may save diffs but leave working tree unchanged — always verify with `git diff` after stash. Manual edits may be needed to truly revert.
