# Scratch Pad — Continual Learning Log

## Pitfalls by Domain

### Concurrency & Background

- **`Task.detached` ≠ background time**: iOS suspends detached tasks when app backgrounds. ANY long-running work (CloudKit, network, crypto) MUST be wrapped in `beginBackgroundTask`/`endBackgroundTask`.
- **`beginBackgroundTask` contract**: (1) store ID as property, (2) call `endBackgroundTask` synchronously in expiration handler via `MainActor.assumeIsolated` — NOT via async dispatch, (3) call `endBackgroundExecution()` before creating a new task to prevent orphaned IDs.
- **`@MainActor` singleton calls need `await`**: `ShareSyncManager`, `BackgroundShareTransferManager`, `DeepLinkHandler` are `@MainActor`. Calls from inside `Task`/`Task.detached` require `await`. The `handleCapturedImage` path keeps losing it — check ALL `scheduleSync()` call sites whenever import handlers are modified. **Regressed 3+ times.**
- **`Task.detached` + `@Observable` = crash**: Mutating `@Observable` properties on a `@MainActor` class from a background thread (`Task.detached`) causes `swift_retain` crash in SwiftUI view body. Never use `Task.detached` inside `@MainActor @Observable` classes. Use `Task` (inherits MainActor) instead.
- **`Timer.scheduledTimer` stops in background**: Uses RunLoop `.default` mode — stops when app backgrounds. Use `Task`-based async loops with `Task.sleep(for:)` instead; they continue with `beginBackgroundTask` active. Keep ActivityKit rate ≤ 2/sec.
- **Embrace SDK**: Must initialize on `@MainActor` only — `setup().start()` inside `Task.detached` triggers `dispatch_assert_queue` crash in `HangCaptureService.init`.
- **`[weak self]` in `deinit`**: Cannot form weak reference to an object being deallocated. Capture specific properties by value instead.
- **`Task.detached` optional-self return trap**: `Task.detached { [weak self] in await self?.doWork() }` returns `Task<()?, Never>`, not `Task<Void, Never>`. Always `guard let self else { return }` inside the closure.
- **BGProcessingTask contract**: `setTaskCompleted(success:)` must be called on EVERY path (success/failure/expiration/no-op). Missing it causes iOS to deprioritize future background launches.
- **Async state flash**: Setting `@State` via `await MainActor.run { }` before a transition creates a brief intermediate state. Only set visual state when user stays on screen (invalid input). Skip intermediate state when transitioning (valid → next step).

### CloudKit

- **INSERT vs UPDATE**: `CKRecord(recordType:recordID:)` + `.save()` = INSERT. To UPDATE, fetch the existing record first, modify fields, then save. Failing to do this causes `serverRecordChanged` (code 14). **Always use fetch-or-create.**
- **Retry logic required**: `CKDatabase.save()` has no built-in retry. Wrap in `saveWithRetry` (3 retries, exponential backoff). Respect `CKError.retryAfterSeconds` when present.
- **Initial upload → sync cache gap**: `uploadSharedVault()` creates CloudKit chunks but doesn't seed `ShareSyncCache`. First `syncSharedVaultIncremental()` sees empty `previousChunkHashes` → tries INSERT on existing records → CKError 14. Always seed cache after initial upload.
- **ASC/build indexing lag**: After upload, `asc builds latest --version N` returns "not found" for minutes. Poll `asc builds list --sort -uploadedDate --limit 20` with ≥10 attempts at ~20s until `processingState == VALID`. Never report completion at upload success alone.
- **Parallel uploads**: Use `withThrowingTaskGroup` with bounded concurrency (max 4) for chunk uploads — cuts time 50–70%. Sequential loops are wrong.
- **N+1 index saves**: Accumulate index updates inside sync loops; batch-save once after the loop. Per-iteration save = N decrypt+encode cycles.

### SwiftUI / UI

- **ALL List/Form screens** need: `.listStyle(.insetGrouped)`, `.scrollContentBackground(.hidden)`, root `.background(Color.vaultBackground)`.
- **Sheets with text input — `.ignoresSafeArea(.keyboard)`**: ANY `.sheet` containing `TextEditor`/`TextField` MUST have `.ignoresSafeArea(.keyboard)` on its root. Parent's `.ignoresSafeArea(.keyboard)` does NOT propagate into sheets. Check: RecoveryPhraseInputView, JoinVaultView, SharedVaultInviteView, CustomRecoveryPhraseInputView. **Regressed 3+ times.**
- **Sheet detent shift on keyboard**: Lock-screen input sheets must pin to `.presentationDetents([.large])` in `PatternLockView` to prevent detent re-evaluation on text focus.
- **`.gesture()` blocks TabView paging**: Always use `.simultaneousGesture()` when adding custom gestures to a TabView or its children. Never `.gesture()`.
- **`safeAreaInset` default spacing**: `safeAreaInset(edge: .top)` without `spacing: 0` inserts platform spacing. Use `safeAreaInset(edge: .top, spacing: 0)` for contiguous header/grid layouts.
- **SwiftUI animation leak in ZStack**: `.animation(_:value:)` on a child can affect siblings. Isolate animated elements in separate overlays.
- **`@MainActor static Logger` in `nonisolated` context**: Use file-level `private let logger` outside the class when the class has `nonisolated` methods — Swift 6 error otherwise.
- **PixelAnimation presets**: ONLY use `PixelAnimation.loading(size:)`. Never create alternate patterns/factory methods. `uploading()`/`downloading()` were removed — they had wrong patterns and dimmer brightness. Dynamic Island `LivePixelGrid` is canonical.
- **ShapeStyle vs Color**: `.foregroundStyle(.accentColor)` doesn't compile — `accentColor` is on `Color`. Use `Color.accentColor` or `.tint(.accentColor)`.
- **Onboarding unlock sequencing**: Never flip `isUnlocked` while `showOnboarding` is still true — `ContentView` fires the unlock overlay during onboarding. Defer `isUnlocked` until onboarding completion.
- **Pattern screen layout stability**: ALL variable-content areas need fixed heights — subtitle `.frame(height: 44)`, feedback `Group.frame(height: 80)`, absent buttons use `.hidden()` placeholders. Without this, Spacer distribution shifts the grid between steps.
- **Pattern feedback state conflict**: When setting `errorMessage`, clear `validationResult`. When setting `validationResult`, clear `errorMessage`. Old feedback persists and new errors appear "stuck" otherwise.
- **Removing "flashing" UI removes essential feedback**: If valid patterns transition immediately, the flash is expected behavior. The fix is to accept the flash or prevent auto-transition — NOT to remove the feedback entirely. Invalid patterns need persistent feedback.
- **Incomplete screen cloning**: When replicating a flow to a new screen, copy ALL behavior: validation, haptics, error messages, feedback UI — not just the data flow.

### Maestro E2E

- **Maestro runs installed app**: `xcodebuild build` alone doesn't update the simulator app Maestro tests. Run `simctl install` after build before running flows that depend on new UI/IDs.
- **TextEditor `id` targeting in sheets**: `TextEditor` can fail `id` matching in sheet contexts even with `.accessibilityIdentifier`. Use `tapOn: point` to focus instead.
- **`addMedia` no parent paths**: Paths are relative to the YAML file. `../` traversal not supported. Use symlinks if needed.
- **No `wait`/`clearInput`**: Use `waitForAnimationToEnd: timeout: N000` and `eraseText: charactersToErase: N`.
- **`clearState` wipes UserDefaults**: `clearState: true` resets `hasCompletedOnboarding`. Re-set required defaults in test mode init.
- **`clearKeychain` triggers system dialog**: Apple Account Verification dialog blocks automation. Remove `clearKeychain: true`, add dismiss taps for "Not Now".
- **Empty state hides FAB**: `vault_add_button` only visible when files exist. Use `vault_first_files` or `-MAESTRO_SEED_FILES` to pre-populate.
- **Index selectors drift**: Prefer `id`/coordinate selectors over `tapOn index` in dense screens — layout shifts invalidate index positions.

### Build & Signing

- **Distribution archive + Automatic signing**: Automatic signing tries to create Development profiles (needs registered devices) even for Release. Use Manual signing for Release with `CODE_SIGN_IDENTITY[sdk=iphoneos*]` = "Apple Distribution" and `PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]` = profile name.
- **Sentry build phase position**: Sentry dSYM upload script MUST be AFTER Embed Foundation Extensions — before it creates a dependency cycle.
- **Stale simulator UUIDs**: Always run `xcrun simctl list devices available` before tests. Prefer booted UUIDs — stale UUIDs fail with "Unable to boot deleted device".
- **Duplicate simulator names**: `xcodebuild -destination 'name=...'` fails if two simulators differ only by casing. Always use `-destination 'id=<UUID>'`.
- **TestFlight internal groups**: `asc builds add-groups` fails for internal groups (`hasAccessToAllBuilds: true` auto-receives all builds). Skip `add-groups` for internal groups; use it only for external beta groups.
- **macOS keychain cert import**: `security import` with `-P ""` (empty password) fails. Use `openssl pkcs12 -legacy` with a non-empty temp password.
- **Beads ID parsing**: `bd` commands need the actual issue ID (e.g., `VAULT-5vs`), not display characters. Run `bd list` first if unsure.
- **SourceKit false positives**: Cross-file SourceKit "Cannot find X in scope" are common in this project. Trust `xcodebuild` results over editor diagnostics.

### Share & Upload

- **Main-actor share packaging freeze**: Running SVDF build, file decrypt/re-encrypt loops, chunk-hash writes inside `@MainActor ShareUploadManager` freezes Share UI. Move all heavy CPU/IO to detached/background tasks; keep only UI state transitions on main actor.
- **Pending upload OOM**: `hasPendingUpload` must never load full SVDF blob data. Check metadata/state JSON + file existence only; large payload reads belong on explicit resume/upload paths.
- **BGProcessingTask three-layer resilience**: (1) `beginBackgroundTask` for immediate background time, (2) `BGProcessingTask` for deferred wakeups, (3) metadata-backed resume when vault key returns.
- **Staged import count mismatch**: `pendingFileCount` includes manifest entries whose `.enc` payload was already deleted. Use `pendingImportableFileCount` (files with existing `.enc`) and drive progress from per-file callbacks.
- **Share screen mode snap-back**: Background refresh can overwrite manually-selected UI state. Keep `.newShare` sticky once user selects it; only auto-resolve from `.loading`. Don't collapse to `.manageShares` → `.newShare` while uploads exist.
- **Terminate vs cancel**: User terminate must hard-remove the job, clear pending artifacts, and suppress post-cancel failure transitions. Keep as differentiated from soft cancel (pause/resume capable).
- **Completed jobs in manager state**: Remove successful jobs from manager state at completion. Active share records are source of truth for finished shares. Terminal rows (`.complete`, `.cancelled`) should not appear in active upload lists.
- **NSItemProvider retention pressure**: Don't hold full-batch `NSItemProvider` arrays in memory. Scan/count first, then process providers sequentially so references are released sooner.
- **Share extension main-thread crypto**: Heavy crypto/thumbnail loops on extension main actor trigger watchdog/jetsam termination. Run per-file work off-main.
- **Streaming retrieve false-positive**: A path may appear streaming but still load full encrypted entries if `retrieveFileToTempURL` reads entry `Data` before header parsing. Parse headers from `FileHandle` and stream decrypt directly to file.

### Security

- **Never `try?` on security paths**: Duress, file deletion, recovery — always use `do/catch` + Sentry. Silent failures on security paths are bugs.
- **Bare `Data(repeating: 0)` ≠ key**: Use `SymmetricKey(size: .bits256)` for actual entropy.
- **Bare `VaultIndex(files:nextOffset:totalSize:)` for new vaults**: Creates index without `encryptedMasterKey` → `getMasterKey` throws `corruptedData`. ALWAYS use `VaultStorage.shared.loadIndex(with:)` for new vault creation.

---

## Corrections and Preferences

- **Commit frequency**: Commit + push after every successful build. Don't accumulate changes.
- **Beads tracking**: Use beads for multi-session work, TodoWrite for single-session tasks.
- **Plan mode**: Extremely concise. Sacrifice grammar for brevity.
- **Subagent model**: Always use opus for subagents.
- **ASC API Key**: Key ID `GGJ9L8Y97B`, Issuer ID `3c53a69e-b7d6-4d46-a26b-2f2d02c69ccb`, key at `~/.private_keys/AuthKey_GGJ9L8Y97B.p8`. Team `UFV835UGV6`.
- **TestFlight upload**: `xcodebuild -exportArchive` with `-authenticationKeyPath ~/.private_keys/AuthKey_GGJ9L8Y97B.p8 -authenticationKeyID GGJ9L8Y97B -authenticationKeyIssuerID 3c53a69e-b7d6-4d46-a26b-2f2d02c69ccb` and ExportOptions `destination: upload`.
- **Release verification**: Poll until both: build row exists AND `processingState == VALID`. Do not report completion at upload success.
- **Appearance setting**: Theme must expose exactly `System`, `Light`, `Dark`. Single source of truth in `AppState.appAppearanceMode` with root `.preferredColorScheme(...)`.
- **Color-tuning**: Keep light palette intact unless explicitly asked; adjust dark-mode tokens first for readability.
- **Upload resilience**: Resume pending uploads automatically when vault opens (or app becomes active with unlocked key), not via manual button only.
- **Staged import UX**: Use same full-screen pixel-loader progress as direct in-vault imports, not a banner spinner.
- **Onboarding completion UX**: Recovery phrase saved → vault open must show `LoadingView("Unlocking...")` + vault-door transition (same as locked-state unlock).
- **Share extension reliability**: Checkpoint staged import manifests after each completed file so partial progress survives extension termination.
- **Crash triage**: Reproduce crash with minimal clean-state Maestro flow before patching. For screen recordings, extract frames and map last stable progress label to code checkpoints.
- **Loader consistency**: Dynamic Island pixel loader is a visual mirror of `PixelAnimation.loading`. Normalize cadence/trail to in-app behavior before adding new animation logic.
