# Scratch Pad — Continual Learning Log

## Session Log

### Session 1 — UX Design Audit Implementation (Feb 8, 2026)
- **Query**: Implement 11-workstream UX design audit plan (WS1-WS11) across the Vaultaire iOS app
- **Approach**: Sequential workstream implementation with build verification and git commit after each
- **Errors**:
  - `.foregroundStyle(.accentColor)` fails — `ShapeStyle` has no member `accentColor`. Fix: use `Color.accentColor`
  - `bd update ○` failed — passed status indicator character instead of issue ID. Fix: use `bd list` to get actual ID
- **Corrections**: None from user — autonomous implementation
- **Key Learnings**:
  - Codable optionals (`Date?`) provide backward compat for existing vault indexes without migration
  - When adding files to pbxproj manually, use `UX` prefix IDs for UX-related additions (consistent with `LA`, `SE` prefixes)
  - `SubscriptionManager.maxFreeFilesPerVault` is a static constant (100) — reference directly, don't duplicate the value
  - Date grouping with photo viewer requires computing global index across all sorted images, not per-group index

### Session 2 — Share Upload Failure Fix (Feb 8, 2026)
- **Query**: Vault share fails with "shared vault couldn't be completed" after CloudKit upload starts
- **Approach**: Traced upload flow through ShareVaultView → BackgroundShareTransferManager → CloudKitSharingManager. Identified two root causes.
- **Root Causes**:
  - No `UIApplication.beginBackgroundTask()` — iOS suspends app when user dismisses share sheet, killing the in-flight CloudKit upload. Telemetry showed only 3 Live Activity ticks (~0.5s) before silence = classic iOS suspension.
  - No retry on transient CKErrors — a single network hiccup on any of 9 sequential chunk saves causes immediate failure.
- **Fix**: Added `beginBackgroundTask`/`endBackgroundTask` wrapping both upload and import `Task.detached` closures. Added `saveWithRetry()` with 3 retries + exponential backoff for transient CKErrors (networkFailure, serviceUnavailable, zoneBusy, requestRateLimited).
- **Key Learnings**:
  - `Task.detached` does NOT get background execution time — iOS can suspend it immediately when app backgrounds
  - `CKDatabase.save()` convenience API has no QoS/timeout config — for production use, consider `CKModifyRecordsOperation`
  - `CKError.retryAfterSeconds` provides server-suggested retry delay — always respect it before falling back to exponential backoff
  - The upload flow: BackgroundShareTransferManager orchestrates (re-encrypt files → plist encode → CloudKitSharingManager uploads chunks sequentially → saves manifest)

### Session 3 — Incremental Sync for Shared Vaults (Feb 9, 2026)
- **Query**: Implement SVDF v4 incremental sync — adding 1 file to shared vault was re-encrypting and re-uploading ALL files
- **Approach**: 4-layer optimization: (1) append-stable binary format (SVDFSerializer), (2) per-share encrypted file cache (ShareSyncCache), (3) chunk-hash diffing in CloudKit upload, (4) recipient delta import
- **Files created**: SVDFSerializer.swift, ShareSyncCache.swift
- **Files modified**: ShareSyncManager.swift (replaced full rebuild with incremental), CloudKitSharingManager.swift (added syncSharedVaultIncremental), BackgroundShareTransferManager.swift (SVDF v4 for initial upload + cache init), VaultView.swift (delta import for SVDF, legacy fallback for v1-v3), VaultStorage.swift (syncSequence on ShareRecord)
- **Errors**: None — first-attempt build success
- **Key Learnings**:
  - Duplicate simulator names cause `xcodebuild` ambiguity — use `-destination 'platform=iOS Simulator,id=<UUID>'` instead of `name=`
  - Sharing group in pbxproj uses `014000xxx` prefix IDs
  - VaultFileEntry has optional `filename`, `mimeType`, `createdAt` — always provide fallback values when building SharedFile from entries
  - Binary format with little-endian encoding requires careful cursor tracking; `Data.readUInt32(at:)` helpers avoid raw pointer arithmetic
  - CloudKit deterministic record IDs (`{shareVaultId}_chunk_{index}`) allow update-in-place without delete+create

---

## Error Tracker

- **ShapeStyle vs Color**: `.foregroundStyle(.accentColor)` doesn't compile — `accentColor` is on `Color`, not `ShapeStyle`. Always use `Color.accentColor` or `.tint(.accentColor)`.
- **Beads ID parsing**: `bd` commands need the actual issue ID (e.g., `VAULT-5vs`), not display characters. Always run `bd list` first if unsure.
- **SourceKit false positives**: Cross-file SourceKit diagnostics ("Cannot find X in scope") are common in this project and don't represent real build errors. Trust `xcodebuild` results over editor diagnostics.
- **@MainActor singleton calls need `await`**: `ShareSyncManager`, `BackgroundShareTransferManager`, `DeepLinkHandler` are all `@MainActor`. Calling their methods from `Task { }` or `Task.detached { }` requires `await` — Swift 6 strict concurrency treats cross-actor calls as implicitly async. This has regressed multiple times. Prevention: ALWAYS add `await` when calling any `@MainActor` singleton method from inside `Task`/`Task.detached` blocks. Check ALL three `scheduleSync` call sites when modifying import handlers.
- **Task.detached + backgrounding = suspension**: iOS will suspend `Task.detached` closures when the app backgrounds. Any long-running work (CloudKit uploads, network calls) MUST be wrapped in `beginBackgroundTask`/`endBackgroundTask`.
- **No retry on CloudKit saves**: `CKDatabase.save()` has no built-in retry. Transient errors (network hiccups, rate limits) cause immediate failure. Always wrap in retry logic.
- **CKRecord INSERT vs UPDATE**: `CKRecord(recordType:recordID:)` creates a NEW record object. `save()` on it attempts INSERT, failing with `serverRecordChanged` (code 14) if record exists. To UPDATE, must FETCH the existing record first via `publicDatabase.record(for:)`, modify its fields, then save. This is critical for incremental chunk updates.
- **Initial upload → sync cache gap**: `uploadSharedVault()` creates chunks in CloudKit but doesn't initialize `ShareSyncCache`. First `syncSharedVaultIncremental()` call sees empty `previousChunkHashes` → tries INSERT on all existing chunks → CKError 14. Prevention: always fetch-or-create before save.
- **deinit + [weak self] = crash**: `[weak self]` in closures dispatched from `deinit` causes "Cannot form weak reference to instance in process of deallocation". Prevention: capture specific properties by value, not `self`.
- **SwiftUI animation leak in ZStack**: `.animation(_:value:)` on one child in a ZStack can affect siblings. Prevention: isolate animated elements in separate overlays.
- **Background task async endBackgroundTask**: `Task { @MainActor in UIApplication.shared.endBackgroundTask(id) }` inside `defer` may never execute when the app is being suspended. Prevention: use `MainActor.assumeIsolated` in the expiration handler to call `endBackgroundTask` synchronously. Store `bgTaskId` as a property with an idempotent `endBackgroundExecution()` helper.
- **Orphaned background task IDs**: Calling `beginBackgroundTask` multiple times without ending old ones leaks task IDs. Prevention: always call `endBackgroundExecution()` before `beginBackgroundTask`, and store only one `currentBgTaskId`.
- **UI only showing happy-path status**: Showing UI only for `.uploading` but not `.uploadFailed`/`.uploadComplete` means the user sees nothing when things fail. Prevention: always handle ALL non-idle enum cases in status UI.
- **Stale simulator UUID**: Simulator UUIDs get invalidated when Xcode/simulators update. `xcodebuild test -destination 'id=<UUID>'` fails with "Unable to boot deleted device". Prevention: run `xcrun simctl list devices available` to find currently booted/available simulators.
- **Maestro `addMedia` no parent paths**: `addMedia` resolves paths relative to the YAML file but does NOT support `../` parent traversal. Prevention: place test media in the same directory or use symlinks.
- **Maestro `wait`/`clearInput` don't exist**: No `wait: N` command (use `waitForAnimationToEnd: timeout: N000`), no `clearInput` (use `eraseText: charactersToErase: N`).
- **Maestro `clearState` resets UserDefaults**: `clearState: true` wipes ALL UserDefaults including `hasCompletedOnboarding`. Prevention: re-set required defaults in test mode init.
- **Maestro `clearKeychain` triggers system dialog**: Apple Account Verification dialog blocks automation. Prevention: remove `clearKeychain: true`, add dismiss taps for "Not Now".
- **Empty state hides FAB**: `vault_add_button` only visible when files exist. Prevention: use `vault_first_files` (empty state) or `-MAESTRO_SEED_FILES` to pre-populate vault.
- **@MainActor static Logger in nonisolated context**: `private static let logger` on a `@MainActor` class cannot be accessed from `nonisolated static` methods — Swift 6 error, Swift 5 warning. Prevention: use file-level `private let logger` outside the class for any class that has `nonisolated` methods.
- **Bare VaultIndex init = no master key**: `VaultIndex(files:nextOffset:totalSize:)` (v1 init) creates index without `encryptedMasterKey`. Saving this then calling `storeFile` throws `corruptedData` because `getMasterKey` finds nil. Prevention: ALWAYS use `VaultStorage.shared.loadIndex(with:)` for new vault creation — it auto-creates proper v3 index with master key + blob.
- **xcodebuild archive + Automatic signing + no devices = fail**: Automatic signing tries to create Development profiles (which need devices) even for Release/distribution archive. Prevention: use Manual signing for Release configs with `CODE_SIGN_IDENTITY[sdk=iphoneos*]` = "Apple Distribution" and `PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]` = profile name.
- **Sentry build phase cycle**: Sentry dSYM upload script BEFORE Embed Foundation Extensions creates dependency cycle (dSYM input → built binary → embedded extensions → Info.plist → cycle). Prevention: always place Sentry script AFTER Embed Foundation Extensions in build phases.
- **TestFlight tester invite before group has build**: `asc testflight beta-testers invite` fails with "no installable builds" until `asc builds add-groups` assigns a build to the group. Prevention: add build to group first, then invite testers.
- **macOS keychain import with empty p12 password**: `security import` with `-P ""` fails. Prevention: use `openssl pkcs12 -legacy` with a temp password, then import with that password.
- **Incomplete screen cloning**: When replicating a flow from another screen (e.g., join vault pattern from onboarding pattern), copying only the core logic but missing validation, haptics, error handling, and feedback UI creates a degraded UX. Prevention: always mirror the FULL behavior including all user feedback paths.
- **Removing "flashing" UI removes essential feedback**: User asked to remove validation feedback that "showed for a split second" on ChangePatternView. Removed the entire `validationResult` + `validationFeedback`, which also removed error display for invalid patterns. The flash was because valid patterns immediately transition — invalid patterns need the feedback to stay visible. Prevention: when UI "flashes", the fix is usually to prevent the auto-transition (or accept the flash), NOT to remove the feature. Always check: does this UI serve a purpose when the user stays on the screen?
- **Pattern grid position jumping between steps**: Different subtitle text lengths, different button counts, and presence/absence of feedback area changed Spacer distribution, moving the grid. Prevention: ALL variable-content areas in pattern screens need fixed heights — subtitle `.frame(height: 44)`, feedback `Group.frame(height: 80)`, buttons use `.hidden()` placeholders for consistent height.
- **Missing Maestro tests for UI changes**: Visual changes without corresponding Maestro test updates means regressions go undetected. Prevention: mandatory checklist in AGENTS.md — new screens need flows, new elements need accessibility IDs + assertions.
- **TestFlight internal groups can't be manually assigned builds**: `asc builds add-groups` fails with "Cannot add internal group to a build." Internal groups with `hasAccessToAllBuilds: true` automatically receive ALL builds. Prevention: skip `add-groups` for internal groups, only use it for external beta groups.
- **Inconsistent PixelAnimation presets**: `uploading()` and `downloading()` had different patterns (column sweep vs perimeter walk) and dimmer brightness (2 vs 3) than `loading()` / Dynamic Island. `syncing()` also had dimmer brightness. Prevention: removed `uploading()`/`downloading()`, made `syncing()` delegate to `loading()`. ONLY use `PixelAnimation.loading(size:)` — never create alternate patterns.

---

## Corrections and Preferences

- **Commit frequency**: User prefers commit + push after every successful build. Don't accumulate changes.
- **Beads tracking**: Use beads for multi-session work, TodoWrite for single-session tasks.
- **Plan mode**: Make plans extremely concise. Sacrifice grammar for brevity.
- **Subagent model**: Always use opus model for subagents.

---

## Anticipated Improvements

- Always wrap `Color.accentColor` (not bare `.accentColor`) in `.foregroundStyle()` calls
- Run `bd list` before closing issues to confirm IDs exist
- When adding optional fields to Codable structs, always provide default `nil` in init for backward compat
- When modifying grid views that feed into a full-screen viewer, verify the index mapping is global not local
- When writing CloudKit save operations with deterministic record IDs, ALWAYS use fetch-or-create pattern — never assume a record doesn't exist
- When there's an initial upload path AND a sync path for the same CloudKit records, verify the sync cache is properly seeded after initial upload
- Never use `[weak self]` in `deinit` — capture properties by value instead
- When using animated floating buttons (FAB), separate the button into its own overlay to prevent animation interference from siblings
- When using `beginBackgroundTask`, always: (1) store the ID as a property, (2) end synchronously in the expiration handler via `MainActor.assumeIsolated`, (3) end any prior task before creating a new one
- When displaying transfer/upload/sync status, always handle ALL enum cases (uploading, failed, complete, etc.) — never just the happy path
- For CloudKit chunk uploads, use `withThrowingTaskGroup` with bounded concurrency (max 4) instead of sequential loops — cuts upload time 50-70%
- When updating index/records inside a per-share loop, accumulate updates and batch-save once after the loop (avoids N+1 decrypt+encode cycles)
- Before removing a method, grep for ALL callers — if zero callers, it's dead code and can be deleted entirely
- When adding new test files to VaultTests: create PBXBuildFile + PBXFileReference with TS prefix, add to TS0000070 group children and TS00000E0 Sources phase
- Before running `xcodebuild test`, verify simulator UUID with `xcrun simctl list devices available` — prefer booted devices
- NEVER use bare `VaultIndex(files:nextOffset:totalSize:)` for new vault creation — always use `loadIndex(with:)` which handles master key + blob setup
- When cloning a screen's functionality to a new context, copy ALL behavior: validation, haptics, error messages, feedback UI — not just the data flow
- Every visual/UI change MUST include Maestro test updates — new screen = new flow, new element = accessibility ID + assertion, changed text = updated assertion
- ALL pixel loaders MUST use `PixelAnimation.loading(size:)` — never create new factory methods with different patterns or brightness. The Dynamic Island's `LivePixelGrid` is the canonical reference.
- For distribution archive: use Manual signing with `CODE_SIGN_IDENTITY[sdk=iphoneos*]` scoping so simulator builds still work
- Sentry build script phase must always be LAST (after Embed Foundation Extensions) to avoid dependency cycles
- When adding TestFlight testers: `builds add-groups` first, then `beta-testers invite`
- For certificate import on macOS: always use `-legacy` flag with openssl and a non-empty temp password
- **PHPicker pre-loading lag**: UIViewControllerRepresentable photo pickers that load all images before calling back create a visible lag. Fix: pass `PHPickerResult` array directly and process incrementally with immediate progress. Never batch-load all picker results before showing UI feedback.
- **Progress indicator timing**: Always set `importProgress` on the main actor BEFORE `Task.detached`, not inside it via `MainActor.run` — the latter introduces an async hop delay.
- **RECURRING: @MainActor `await` omission**: Every time import handlers are modified, verify ALL `ShareSyncManager.shared.scheduleSync()` calls have `await`. This has regressed 3+ times. The `handleCapturedImage` path is the one that keeps losing it.

### Session 4 — Fan Menu UX + CloudKit Chunk Overlap Fix (Feb 9, 2026)
- **Query**: Fix fan menu button positioning/vanishing, fix CloudKit CKError 14 "record to insert already exists" during multi-recipient share sync
- **Approach**:
  1. Fan menu: separated + button into own overlay to isolate animation context, added `.buttonStyle(.plain)` to prevent press dimming
  2. CloudKit: always fetch existing record before save (fetch-or-create pattern), handle code 14 in saveWithRetry as defense-in-depth
  3. CameraManager: fix deinit crash from weak self in async dispatch during deallocation
- **Root Causes**:
  - **Fan menu vanish**: Default ButtonStyle opacity dimming on press + `.animation` modifier leaking across ZStack siblings
  - **CKError 14**: Initial upload (`uploadSharedVault()`) creates chunks in CloudKit but never populates `ShareSyncCache`. First incremental sync reads empty `previousChunkHashes`, treats ALL chunks as new, tries INSERT on records that already exist
  - **CameraManager crash**: `deinit` called `stopSession()` which uses `[weak self]` — can't form weak ref to deallocating object
- **Key Learnings**:
  - SwiftUI `.animation(_:value:)` can leak to sibling views in same ZStack — separate into distinct overlays for isolation
  - CKRecord.save() treats new CKRecord objects as INSERT, fetched objects as UPDATE — critical distinction
  - Initial upload → incremental sync handoff has a cache gap — always defend against missing/stale cache state
  - Never use `[weak self]` in `deinit` closures — capture specific properties instead

### Session 5 — Background Task Expiration + Upload Progress Visibility (Feb 10, 2026)
- **Query**: Fix iOS background task expiration during large vault uploads; add upload status visibility to Share Vault management screen
- **Approach**:
  1. Background task: Store `currentBgTaskId` as property, use `MainActor.assumeIsolated` in expiration handler for synchronous cleanup, add `endBackgroundExecution()` idempotent helper
  2. Upload progress: Replace narrow `.uploading`-only check with `transferStatusBanner` showing `.uploading`, `.uploadFailed`, `.uploadComplete` states
  3. Added missing `beginBackgroundTask` to `startBackgroundImport`
- **Root Causes**:
  - **Background task not ended**: Expiration handler dispatched `cancel()` via `Task { @MainActor in }` — async hop may not execute before iOS suspends. `endBackgroundTask` must be called synchronously in the handler.
  - **No upload status shown**: ShareVaultView only showed progress for `.uploading` enum case. `.uploadFailed` and `.uploadComplete` had no UI — user saw nothing when upload failed.
  - **Missing background task**: `startBackgroundImport` had no `beginBackgroundTask` at all — iOS could suspend during import.
- **Key Learnings**:
  - `UIApplication.beginBackgroundTask` expiration handler runs on main queue — use `MainActor.assumeIsolated` for synchronous @MainActor access without async hop
  - Must call `endBackgroundTask` before expiration handler returns, not via async dispatch
  - Multiple `beginBackgroundTask` calls without matching `endBackgroundTask` = orphaned task IDs
  - Always show ALL non-idle transfer states in UI, not just the "happy path" uploading state

### Session 7 — Unit Test Infrastructure (Feb 10, 2026)
- **Query**: Add VaultTests unit test target + initial test coverage for crypto/sharing layers
- **Approach**: Create VaultTests target via pbxproj edits (TS prefix IDs), 4 test suites, @testable import Vault with TEST_HOST
- **Files created**: VaultTests/CryptoEngineTests.swift, SVDFSerializerTests.swift, ShareSyncCacheTests.swift, SharedVaultDataTests.swift
- **Files modified**: project.pbxproj (TS prefix entries), Vault.xcscheme (Testables section)
- **Result**: 32 tests, 0 failures, all pass in 0.044s
- **Errors**:
  - Stale simulator UUID: `57965726-...` was deleted, test launch failed with "Unable to boot deleted device". Fix: use `xcrun simctl list devices available` to find live simulators, use booted one (`6627B57F-...`)
  - SourceKit "No such module XCTest" — false positive before test target exists, ignore per Error Tracker
- **Key Learnings**:
  - Test target needs: PBXBuildFile, PBXFileReference, PBXGroup, PBXSourcesBuildPhase, PBXFrameworksBuildPhase, PBXResourcesBuildPhase, PBXNativeTarget, PBXContainerItemProxy, PBXTargetDependency, XCBuildConfiguration (Debug+Release), XCConfigurationList, plus updates to mainGroup, Products, TargetAttributes, targets array
  - `BUNDLE_LOADER = "$(TEST_HOST)"` + `TEST_HOST = "$(BUILT_PRODUCTS_DIR)/Vault.app/$(BUNDLE_EXECUTABLE_FOLDER_PATH)/Vault"` — test bundle loads into host app, `@testable import Vault` works without sharing source files
  - Always check `xcrun simctl list devices available` for booted simulator before running tests — stale UUIDs fail silently

### Session 6 — Code Review: Quality + Performance Fixes (Feb 10, 2026)
- **Query**: Interactive 4-section code review of sharing/transfer code (Architecture → Code Quality → Tests → Performance)
- **Approach**: Systematic review with user-approved fixes per section
- **Code Quality Fixes**:
  - Removed dead `startBackgroundImport` (zero callers, 80 lines)
  - Removed unused `pattern: [Int]` param from import method
  - Added Sentry error capture to import error path
  - Extracted `saveChunkRecord` helper in CloudKitSharingManager (DRY 3x)
- **Performance Fixes**:
  - Parallel chunk uploads (max 4 concurrent) via `withThrowingTaskGroup` with bounded concurrency
  - Batched index save after sync loop (was N+1 loads)
- **Key Learnings**:
  - `withThrowingTaskGroup` concurrency limiting pattern: check `inFlight >= max` before each `addTask`, call `try await group.next()` to drain one slot
  - CloudKit public database handles 4 concurrent saves well; `saveWithRetry` handles rate limiting as fallback
  - Dead code detection: grep for method name, verify zero callers before removing
  - N+1 pattern in loops: accumulate updates, batch-write after loop

### Session 8 — Resumable Uploads (Feb 10, 2026)
- **Query**: Implement resumable upload system so large vault shares survive app backgrounding
- **Approach**: Persist SVDF data + upload metadata to disk before CloudKit upload; on resume, query CloudKit for existing chunks, upload only missing ones
- **Files modified**: CloudKitSharingManager.swift (existingChunkIndices, saveManifest extraction, uploadChunksParallel → internal), BackgroundShareTransferManager.swift (PendingUploadState, save/load/clear, resumePendingUpload), ShareVaultView.swift (Resume Upload button)
- **Result**: Build succeeded first attempt, 314 lines added, committed and pushed
- **Errors**: Duplicate simulator name (lowercase "iphone 17 pro" + uppercase "iPhone 17 Pro") — used UUID directly per Error Tracker
- **Key Learnings**:
  - `nonisolated static` methods on `@MainActor` class for file I/O called from `Task.detached` — avoids actor isolation issues
  - `CKQueryOperation.Cursor` from `publicDatabase.records(matching:)` result enables pagination — check `queryCursor` after each page
  - Extracting methods from complex functions: keep the original call site clean, move error capture/transaction logic to the caller
  - PendingUploadState uses JSON for metadata + raw binary for SVDF blob — keeps serialization simple and avoids base64 bloat

### Session 9 — Maestro E2E Test Infrastructure (Feb 10, 2026)
- **Query**: Implement Maestro E2E test coverage plan (3 phases: test mode bypass, accessibility identifiers, YAML flows)
- **Approach**: `#if DEBUG` TEST_MODE bypass with deterministic SHA-256 key, accessibilityIdentifier on all interactive elements across 15 views, 30 YAML flow files in `maestro/` directory
- **Files modified**: VaultApp.swift (AppState test mode + deterministic key), ContentView.swift (auto-unlock + lock bypass), 13 view files (accessibilityIdentifiers)
- **Files created**: maestro/ directory with config.yaml, 3 test media files, 30 YAML flow files across 10 categories
- **Result**: Build succeeded first attempt, 945 lines added across 56 files, committed and pushed
- **Errors**: Duplicate simulator name again (lowercase "iphone 17 pro") — used UUID per Error Tracker
- **Key Learnings**:
  - `ProcessInfo.processInfo.arguments.contains("-MAESTRO_TEST")` detects Maestro launch args in iOS
  - Deterministic test key via `CryptoKit.SHA256.hash(data: fixedSeed)` bypasses PBKDF2+SecureEnclave for automated testing
  - Lock trigger bypass: screenshot/screenRecording/background notifications all need early-return guards
  - Maestro `runFlow` uses relative paths from the YAML file location
  - `addMedia` pushes files to simulator photo library — works for photo import tests
  - FanItem struct needed `accessibilityId` optional field for per-item identifiers
  - Accessibility identifiers go on the interactive element itself, not a containing wrapper

### Session 10 — Maestro Flow Runtime Fixes (Feb 10, 2026)
- **Query**: Run Maestro flows on simulator, fix failures
- **Approach**: Iterative run → diagnose → fix → re-run for all 30 flows across 8 directories
- **Files modified**: VaultApp.swift (onboarding bypass, MAESTRO_SEED_FILES), launch_test_mode.yaml, navigate_to_app_settings.yaml, 22 YAML flow files
- **Files created**: launch_with_files.yaml (helper with seed files), testdata symlinks
- **Result**: 29/30 flows passing (96.7%). Only import_from_library fails (system photo picker limitation)
- **Errors**:
  - Java not linked: `JAVA_HOME="/opt/homebrew/opt/openjdk@17"` needed for Maestro CLI
  - Onboarding reappears: `clearState: true` resets UserDefaults → auto-set `hasCompletedOnboarding` in test mode
  - Apple Account Verification dialog: `clearKeychain: true` triggers persistent system dialog → removed, added "Not Now" dismiss
  - `wait: N` invalid: Maestro has no `wait` command → use `waitForAnimationToEnd: timeout: N000`
  - `addMedia` no parent paths: `../testdata/` fails → moved testdata into flows/, created per-directory symlinks
  - FAB not in empty state: `vault_add_button` hidden when files empty → use `vault_first_files` + confirmationDialog
  - `clearInput` invalid: → use `eraseText: charactersToErase: N`
  - Premium elements hidden: duress toggle/iCloud backup gated by subscription → scroll to visible text, tap either toggle or button
  - Settings below fold: `settings_app_settings` needs `scrollUntilVisible` before tap
- **Key Learnings**:
  - Maestro `addMedia` resolves paths relative to the YAML file only — no `../` parent traversal
  - Maestro has no `wait` or `clearInput` commands — use `waitForAnimationToEnd` and `eraseText`
  - Maestro doesn't recurse subdirectories — must run per-directory: `maestro test maestro/flows/core/`
  - System photo picker (PHPickerViewController) is unreliable in Maestro — make picker steps optional
  - For flows needing files in vault, use `-MAESTRO_SEED_FILES` launch arg + `UIGraphicsImageRenderer` to generate test images programmatically
  - `clearState: true` resets ALL UserDefaults — any test mode init must re-set required defaults
  - `clearKeychain: true` triggers Apple Account Verification — avoid in test mode
  - Premium-gated UI: use `scrollUntilVisible` with text match + optional taps for both premium/non-premium states

### Session 11 — Link-Based Vault Sharing (Feb 10, 2026)
- **Query**: Implement share-via-link feature — encode phrase into URL fragment, deep link handler, invite landing screen, Copy Link + Share buttons
- **Approach**: 3 new files (ShareLinkEncoder, DeepLinkHandler, SharedVaultInviteView) + modifications to 5 existing files (entitlements, VaultApp, ContentView, ShareVaultView, pbxproj)
- **Files created**: ShareLinkEncoder.swift (base58 + deflate compression), DeepLinkHandler.swift (@Observable URL handler), SharedVaultInviteView.swift (invite flow with pattern setup)
- **Files modified**: Vault.entitlements (associated domains), VaultApp.swift (DeepLinkHandler + onOpenURL), ContentView.swift (fullScreenCover for invite), ShareVaultView.swift (Copy Link + Share buttons with 60s auto-clear), project.pbxproj (SL prefix IDs)
- **Result**: Build succeeded first attempt, 543 lines added across 9 files, committed and pushed
- **Errors**: Duplicate simulator name again — used UUID per Error Tracker
- **Key Learnings**:
  - Apple's `Compression` framework provides `compression_encode_buffer`/`compression_decode_buffer` for deflate — no need for third-party zlib wrappers
  - Base58 encoding (Bitcoin alphabet) naturally excludes ambiguous characters (0, O, I, l) — ideal for URL-safe phrase encoding
  - URL fragments (#...) never reach the server — safe for client-side secrets in share links
  - `fullScreenCover` with computed `Binding` on an observable property works well for showing deep-link-triggered sheets regardless of app lock state
  - SharedVaultInviteView mirrors JoinVaultView pattern: invite → premium check → pattern setup → empty index → unlock → background download
  - `.interactiveDismissDisabled()` prevents accidental swipe-dismiss during invite flow

### Session 12 — Monorepo Restructure (Feb 10, 2026)
- **Query**: Restructure repo from single iOS project to monorepo with apps/ios/, web/, shared docs/
- **Approach**: git mv iOS files to apps/ios/, split docs (iOS-specific → apps/ios/docs/, project-wide stays at docs/), scaffold web/ with AASA + landing pages + Tailwind, create scoped AGENTS.md files
- **Files moved**: 150+ files via git mv (Vault.xcodeproj, Vault/, VaultLiveActivity/, VaultTests/, maestro/ → apps/ios/)
- **Files created**: apps/ios/AGENTS.md (iOS-scoped), web/AGENTS.md, web/index.html, web/s/index.html, web/.well-known/apple-app-site-association, web/package.json, web/styles/input.css
- **Files modified**: AGENTS.md (trimmed to monorepo-level), .gitignore (web ignores)
- **Result**: Build succeeded first attempt from apps/ios/, beads still works from root
- **Errors**:
  - `git mv VaultUITests` failed — empty dir not tracked by git. Fix: plain `mv` for untracked dirs
  - `git mv .sentryclirc` failed — gitignored file. Fix: plain `mv`
  - `&&` chain break: first failure aborts remaining commands. Partial state required checking what already moved.
- **Key Learnings**:
  - Xcode `sourceTree = "<group>"` relative refs mean moving .xcodeproj + siblings together requires NO pbxproj edits
  - `git mv` can't move empty dirs or gitignored files — use plain `mv` for those
  - sentry-cli discovers `.sentryclirc` by walking up from CWD — placing it next to .xcodeproj keeps it discoverable
  - Tailwind CSS v4 uses `@import "tailwindcss"` instead of v3's `@tailwind` directives
  - AASA file must have no extension but serve as `application/json`

### Session 13 — Join Vault Bug Fixes + Download Progress (Feb 10, 2026)
- **Query**: Fix 3 bugs in Join Shared Vault flow: invisible text area, "Setup Failed" crash, missing pattern validation. Add download progress indicator.
- **Approach**: Traced each bug to root cause, applied minimal fixes matching existing patterns in onboarding/settings screens
- **Root Causes**:
  - **Invisible text area**: TextEditor missing `.overlay(RoundedRectangle.stroke())` border that all other phrase inputs have
  - **"Setup Failed" on import**: `setupSharedVault()` manually created bare `VaultIndex` (v1 init, no `encryptedMasterKey`). Background import called `storeFile()` → `getMasterKey()` → `guard let encryptedMasterKey` → throws `corruptedData`. Fix: use `loadIndex(with:)` which auto-creates proper v3 index with master key + blob when none exists
  - **No pattern validation**: `handlePatternComplete` only checked `count >= 6`, skipping `PatternValidator` (no validation feedback, no haptics, no error on mismatch). Fix: mirror `PatternSetupView` exactly — full validation, visual feedback, haptics, "Patterns don't match" error with auto-clear
- **Download progress**: Exposed `displayProgress`/`currentMessage` from `BackgroundShareTransferManager` (changed `private` → `private(set)`). Added `importingProgressView` to VaultView empty state — shows PixelAnimation.downloading + ProgressView bar + percentage + status message when `transferManager.status == .importing`
- **Maestro tests**: Expanded `join_vault.yaml` (phrase input + pattern setup assertions), created `join_vault_pattern_validation.yaml` (mismatch error + start over flow). Added accessibility IDs: `join_pattern_grid`, `join_pattern_error`, `join_pattern_start_over`
- **Rule added**: Mandatory Maestro test section in `apps/ios/AGENTS.md` — every visual/UI change MUST include corresponding test updates
- **Key Learnings**:
  - `VaultIndex` has two inits: v1 (no master key — for legacy/bare use) and v2+ (with `encryptedMasterKey`). Using v1 init then saving creates a real index file, which prevents `loadIndex` from auto-creating a proper v3 index later. Always use `loadIndex` for new vault creation — it handles master key generation, blob setup, and versioning automatically
  - When a new screen replicates functionality from an existing screen (join vault pattern ↔ onboarding pattern), copy the FULL behavior including validation, haptics, error messages, and feedback UI — not just the happy path
  - `private(set)` on `@Observable` properties is the clean way to expose read-only progress to views without breaking encapsulation

### Session 14 — TestFlight Distribution Pipeline (Feb 10, 2026)
- **Query**: Set up full TestFlight pipeline — from zero distribution assets to first build on TestFlight
- **Approach**: Register missing bundle ID, create distribution cert + profiles, configure manual signing for Release, fix build phase cycle, archive + export + upload, create beta group + invite tester
- **Files created**: ExportOptions.plist, scripts/publish-testflight.sh
- **Files modified**: project.pbxproj (Release signing → manual, build phase reorder)
- **ASC artifacts**: Distribution cert (6DBP6XL5J5), 3 App Store profiles, "Internal Testers" group, build v1.0(1) uploaded
- **Errors**:
  - `asc bundle-ids create --platform UNIVERSAL` rejected — must use `IOS` (ASC API converts to UNIVERSAL internally)
  - `security import` with empty password fails on macOS — use `openssl pkcs12 -legacy` with temp password
  - `xcodebuild archive` with `CODE_SIGN_STYLE=Automatic` fails without registered devices — Xcode tries to create Development profiles which require devices even for distribution builds
  - Sentry script build phase before Embed Foundation Extensions causes cycle — dSYM input dependency creates circular reference with extension embedding
  - `asc testflight beta-testers invite` fails with "no installable builds" until build is added to group via `asc builds add-groups`
- **Key Learnings**:
  - **Manual signing for Release is required** when no devices are registered — automatic signing tries to create Development profiles (need devices) even for distribution archive
  - `CODE_SIGN_IDENTITY[sdk=iphoneos*]` and `PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]` scope signing to device builds only — simulator builds still work with default ad-hoc signing
  - `openssl pkcs12 -legacy` flag needed for macOS Keychain import compatibility
  - Sentry dSYM upload script must be AFTER Embed Foundation Extensions in build phases to avoid dependency cycle
  - `xcodebuild -exportArchive` with `destination: upload` in ExportOptions.plist uploads directly to ASC — no IPA file produced locally
  - `-allowProvisioningUpdates` only needed on exportArchive step, not archive step with manual signing
  - Build processing takes ~1-2 minutes in ASC before `VALID` state
  - Must `asc builds add-groups` before testers can be invited — group needs a build first
  - Internal testers (ASC team members) use `invite` not `add` command

### Session 15 — Import UX, Free Tier Enforcement, Unlock Animation, Drag-to-Select, TestFlight (Feb 11, 2026)
- **Queries**: 7 sequential requests: (1) fix import progress lag, (2) enforce free tier 100-file limit during import, (3) standardize unlock animation to 1.5s, (4) icon overlay to 0.9s, (5) drag-to-select in edit mode, (6) fix recurring Swift 6 async warning, (7) deploy to TestFlight
- **Approach**: Each change committed and pushed individually after build verification
- **Files modified**: VaultView.swift (import progress, free tier limits, async fix), PhotosGridView.swift (drag-to-select), FilesGridView.swift (drag-to-select), VaultApp.swift (unlock timing), ContentView.swift (shield overlay timing), project.pbxproj (build number bump)
- **Root Causes**:
  - **Import lag**: PHPicker Coordinator loaded ALL images via `loadObject` before calling back. Fix: pass `[PHPickerResult]` directly, set `importProgress` immediately on main actor
  - **Broken vault state**: Free tier limit only checked at + button, not during import. `storeFile` threw `expansionNotAllowed` silently. Fix: cap imports to remaining free slots, import those, show paywall if truncated
  - **Swift 6 async warning**: `handleCapturedImage` path missing `await` on `@MainActor` singleton call (3rd time this regressed)
- **Errors**:
  - `asc builds add-groups` fails for internal groups — internal groups with `hasAccessToAllBuilds: true` auto-receive all builds
- **Key Learnings**:
  - PreferenceKey + simultaneousGesture + direction detection is the pattern for drag-to-select in SwiftUI LazyVGrid
  - Replace `Button` with `.onTapGesture` when adding simultaneous drag gestures (Button consumes the gesture)
  - Internal TestFlight groups auto-receive builds — no `add-groups` needed
  - Free tier enforcement must happen at import handler level, not just UI button level

### Session 16 — Free Tier Alert, Video Import, Quick Look, Paywall Fallback, Unified Grid (Feb 11, 2026)
- **Queries**: 7 sequential requests: (1) fix 100-file limit silent truncation with alert dialog, (2) fix video import from gallery, (3) fix date header overlap, (4) add Quick Look for non-image files, (5) fix RevenueCat Error 23 with fallback paywall, (6) unified Files-app grid for mixed content, (7) deploy build 6 to TestFlight
- **Approach**: Each fix committed individually; unified grid was the most complex change
- **Files modified**: VaultView.swift (limit alert, video import, date header padding), FilesGridView.swift (thumbnailOrIcon, masterKey param), SecureImageViewer.swift (Quick Look rewrite), PaywallTrigger.swift (fallback paywall), SubscriptionManager.swift (hasOfferings check)
- **Root Causes**:
  - **94 files instead of 100**: PHPicker allows images+videos, but `handleSelectedPhotos` only processed UIImage. 6 videos silently skipped via `canLoadObject(ofClass: UIImage.self)` check
  - **Silent truncation**: No user feedback when import was capped. Fix: PendingImport enum + 3-option alert (Import N, Upgrade, Cancel)
  - **Video silent fail**: `loadObject(ofClass: UIImage.self)` fails for video items. Fix: `UTType.movie` detection + `loadFileRepresentation` + `AVAssetImageGenerator` thumbnails
  - **Date header overlap**: `LazyVStack(spacing: 0)` with pinned headers left zero gap. Fix: `.padding(.top, 8)` on section content
  - **Unsupported file type**: SecureImageViewer only handled UIImage. Fix: QLPreviewController for non-image files via UIViewControllerRepresentable
  - **RevenueCat Error 23**: Offerings not configured. Fix: `hasOfferings` check → FallbackPaywallView with premium override for sandbox
  - **Inconsistent grid**: PhotosGridView (tight) + FilesGridView (icon tiles) side by side. Fix: FilesGridView accepts optional masterKey, shows AsyncThumbnailView for files with thumbnails
- **Key Learnings**:
  - `NSItemProvider.loadFileRepresentation(forTypeIdentifier:)` provides a temp URL — must copy data before callback returns
  - `AVAssetImageGenerator.copyCGImage(at:actualTime:)` grabs frame at specific time — write video to temp file first
  - QLPreviewController via UIViewControllerRepresentable works for all file types iOS supports
  - RevenueCat `Purchases.shared.offerings()` returns nil current when no products configured — check before showing PaywallView
  - Unified grid pattern: FilesGridView with optional masterKey, `thumbnailOrIcon` method switches between AsyncThumbnailView and icon fallback
  - "Photos" filter → PhotosGridView (compact), all other filters → FilesGridView (uniform tiles with thumbnails)

### Session 17 — Scroll Fix, Security Fix, Batch Delete, Camera Preview, Media Filter, Builds 7-9 (Feb 11, 2026)
- **Queries**: 8 sequential requests: (1) verify scroll fix + push, (2) deploy build 7 to TestFlight, (3) prevent phone sleep during imports, (4) deploy build 8, (5) default to Media filter, (6) critical security fix — cross-vault import contamination, (7) batch delete optimization, (8) camera preview fix, (9) deploy build 9
- **Approach**: Each fix committed and pushed individually; 3 TestFlight deployments across session
- **Files modified**: VaultView.swift (media filter, security fix, batch delete, idle timer), FilesGridView.swift (scroll fix), PhotosGridView.swift (scroll fix), VaultStorage.swift (batch deleteFiles), SecureCameraView.swift (camera preview), ShareExtension/Info.plist (build setting vars), Supporting/Info.plist (build bumps 6→9), project.pbxproj (build bumps)
- **Root Causes**:
  - **Scroll blocked**: `DragGesture(minimumDistance: 1)` via `.simultaneousGesture()` always attached, competing with ScrollView pan. Fix: conditionally attach only when `isEditing`
  - **Phone sleep during imports**: No idle timer management. Fix: `UIApplication.shared.isIdleTimerDisabled = true/false` around import/delete operations
  - **Cross-vault contamination (CRITICAL)**: `Task.detached` captures vault key by value (Data), keeps running after lock. `lockVault()` has no task cancellation. `onChange` only clears on nil, not vault switch. Fix: store task handles, cancel on any key change, check `Task.isCancelled` throughout import loops
  - **Batch delete freeze**: Each `deleteFile` did separate `loadIndex`/`saveIndex` — 300 cycles for 300 files, ran on main thread. Fix: batch `deleteFiles` method (single load/save, blob-grouped file handles), `Task.detached`, progress bar
  - **Camera black preview**: `AVCaptureVideoPreviewLayer` added as sublayer with zero frame. Fix: `layerClass` override pattern — backing layer auto-resizes
  - **ShareExtension version drift**: Hardcoded build number "6" in Info.plist. Fix: `$(CURRENT_PROJECT_VERSION)` and `$(MARKETING_VERSION)` variables
- **Errors**:
  - `defer` can't contain `await` — moved idle timer re-enable to explicit MainActor.run blocks
  - `blobId` is `String?` — used `entry.blobId ?? "primary"` for dictionary grouping
  - ShareExtension build number mismatch broke archive — replaced with build setting variables
  - `asc builds test-notes create` duplicate locale error — used `update` instead
- **Key Learnings**:
  - Swift `defer` cannot contain `await` expressions — use explicit cleanup at return points
  - `Task.detached` captured value-type keys (`Data`) survive vault lock — MUST store task handles and check `Task.isCancelled` for security
  - `onChange(of:)` should handle ANY value change for security-critical state, not just nil transitions
  - Batch storage operations: load index once, group by blob for file handle reuse, save once = 300x fewer crypto cycles
  - `AVCaptureVideoPreviewLayer` as `layerClass` override is Apple's recommended pattern — auto-resizes with view, no manual frame management needed
  - ShareExtension Info.plist should use `$(CURRENT_PROJECT_VERSION)` / `$(MARKETING_VERSION)` to stay in sync with main app
  - `asc testflight beta-details get` shows `internalBuildState: IN_BETA_TESTING` when auto-notify is enabled — no manual group assignment needed for internal testers

### Session 19 — Replace Debug Prints with Structured os.log (Feb 11, 2026)
- **Query**: VAULT-x68 — Replace ~80 `#if DEBUG / print() / #endif` blocks with Apple's unified `os.log` Logger across the entire codebase
- **Approach**: Searched for all `#if DEBUG` blocks, identified 18 Swift files needing changes (excluded VaultStorage.swift, iCloudBackupManager.swift, VaultView.swift per instructions). Added Logger instances following subsystem/category pattern, replaced prints with appropriate log levels.
- **Files modified**: 18 files — VaultApp.swift, ContentView.swift, SubscriptionManager.swift, PatternSetupView.swift, VaultSettingsView.swift, SettingsView.swift, CloudKitSharingManager.swift, ShareVaultView.swift, DeepLinkHandler.swift, ShareSyncManager.swift, PatternGridView.swift, PatternLockView.swift, LocalNotificationManager.swift, ImportIngestor.swift, RecoveryPhraseView.swift, DuressHandler.swift, GridLetterManager.swift, RecoveryPhraseManager.swift
- **Security**: 5 sensitive data leaks found and addressed — 3 `key.hashValue` prints changed to `logger.trace()` with no key data, 2 recovery phrase prints removed/trace-only, 1 duress recovery phrase print removed entirely
- **Errors**:
  - `@MainActor`-isolated `private static let logger` on ShareSyncManager accessed from `nonisolated static` method. Fix: moved to file-level `private let shareSyncLogger` outside the class
  - Pre-existing unused variable `let newPhrase = ...` in VaultSettingsView after removing the print that used it. Fix: changed to `_ = ...`
- **Key Learnings**:
  - Logger placement: `private static let` for classes/actors (accessed via `Self.logger`), file-level `private let` for structs/enums/views
  - `@MainActor` class static properties cannot be accessed from `nonisolated` context — use file-level let instead
  - Per-frame drag logging (called every gesture event) must be removed, not converted — would flood os.log
  - Sensitive data in logs: `key.hashValue` and recovery phrases should use `.trace()` or be removed entirely
  - Some `#if DEBUG` blocks are functional gates (Maestro test mode), not logging — keep those intact

### Session 18 — Pattern Board Normalization + UI Consistency (Feb 11, 2026)
- **Queries**: Fix ChangePatternView UI (error position, grid jumping, missing action buttons), replace onboarding logo, remove/re-add validation feedback, normalize all pattern boards
- **Approach**: Investigated all 7 pattern board screens (PatternLockView, PatternSetupView, ChangePatternView, JoinVaultView, SharedVaultInviteView, RestoreFromBackupView, PatternInputView), identified inconsistencies, normalized to match PatternSetupView as reference implementation
- **Root Causes**:
  - **Grid jumping**: Different subtitle text lengths + different number of bottom buttons across steps changed Spacer distribution. Fix: `.frame(height: 44, alignment: .top)` on subtitle, `.hidden()` placeholder buttons
  - **Error at wrong position**: Error message was between title and grid instead of below grid. Fix: moved to fixed 80pt Group below grid (matching PatternSetupView)
  - **Missing validation on createNew**: Removed validation feedback (user asked to remove "flash"), but that also removed error display for invalid patterns. Fix: re-added `validationResult` + `validationFeedback` function matching PatternSetupView exactly
  - **SharedVaultInviteView incomplete**: Only checked `count >= 6`, no PatternValidator, no error messages, silently reset on confirm mismatch. Fix: added full PatternValidator validation, feedback area, "Patterns don't match" error
- **Files modified**: VaultSettingsView.swift (ChangePatternView — 3 rounds of fixes), SharedVaultInviteView.swift (added validation + feedback), AGENTS.md (pattern board rules), .scratch-pad.md
- **Key Learnings**:
  - Removing UI that "flashes" may actually remove essential feedback — understand WHY it flashes before removing. The flash was because valid patterns immediately transition to next step.
  - SwiftUI layout stability requires fixed heights for ALL variable-content areas: subtitles, feedback sections, button stacks
  - Pattern board screens have 3 categories (create, confirm, enter-existing) each with specific required behaviors — documented in AGENTS.md
  - When user says "remove this" about a specific UI element, clarify whether they mean (a) remove the feature entirely, or (b) fix the specific problem (flash/position/style)
- **Error**: Prematurely removed validation feedback from ChangePatternView when user only wanted the brief flash fixed. Re-added with proper behavior.

---

## Cumulative Learnings

- **Session count**: 19
- **Build success rate**: 25/25 (Session 10: 1/1 first-attempt)
- **Key pattern**: Sequential workstream implementation with build gates works well for large multi-file UX changes
- **Architecture insight**: This codebase uses a 3-tier file model (VaultFileItem → LightweightFileEntry → VaultFileEntry) — changes to file metadata must propagate through all three
- **Sharing architecture**: BackgroundShareTransferManager (@MainActor, @Observable) → Task.detached for crypto work → CloudKitSharingManager for CloudKit ops. All crypto keys captured by value to survive vault lock.
- **Incremental sync**: SVDF v4 is append-stable (existing bytes never move). ShareSyncCache stores per-share encrypted files + SVDF blob + chunk hashes. Sync flow: diff file IDs → re-encrypt only new files (check cache first) → build SVDF incrementally → hash chunks → upload only changed chunks.
- **CloudKit idempotency**: ALWAYS fetch before save for deterministic record IDs. Never trust local cache to know whether a CloudKit record exists — the initial upload path, partial failures, and retries can all leave records that the cache doesn't know about. Use `fetchOrCreateRecord()` pattern everywhere.
- **Parallel CloudKit uploads**: `withThrowingTaskGroup` with bounded concurrency (4) handles rate limiting gracefully — `saveWithRetry` inside each task catches transient CKErrors. If one chunk fails hard, the group cancels remaining tasks via cooperative cancellation.
- **Code review workflow**: Architecture → Code Quality → Tests → Performance, max 4 issues per section, user approves before implementation. Works well for thorough reviews without scope creep.
- **Test infrastructure**: VaultTests target uses `@testable import Vault` with `TEST_HOST` pattern — no need to share source files between targets. TS prefix IDs for all pbxproj entries. 32 tests across 4 suites covering CryptoEngine, SVDFSerializer, ShareSyncCache, and SharedVaultData.
- **Resumable uploads**: Persist SVDF + metadata to `Documents/pending_upload/` before CloudKit upload. On resume, `existingChunkIndices()` queries CloudKit with cursor pagination, filters to missing chunks only, uploads them with parallel concurrency. 24h TTL auto-discards stale state. Duplicate share record guard prevents double-append to vault index.
- **Maestro E2E testing**: `#if DEBUG` test mode bypass with `-MAESTRO_TEST` launch arg provides deterministic key + auto-unlock + lock trigger bypass. 60+ accessibilityIdentifiers across all views enable Maestro element targeting. 30 YAML flows cover onboarding, core, camera, viewer, search, edit mode, settings, sharing, and premium features. 29/30 pass (96.7%) — only `import_from_library` fails due to system photo picker limitation. `-MAESTRO_SEED_FILES` flag pre-populates vault with test images for flows needing files.
- **Monorepo structure**: iOS at `apps/ios/`, web at `web/`, shared docs at `docs/`, design at `design/`. Root AGENTS.md has monorepo concerns (beads, git, sessions). Subproject AGENTS.md files have project-specific knowledge. Xcode relative refs survive moves as long as .xcodeproj and sibling dirs move together.
- **Link-based sharing**: ShareLinkEncoder uses version-byte prefix (0x01=raw, 0x02=deflate) + base58 encoding of phrases into URL fragments. DeepLinkHandler is `@Observable` and presented via `fullScreenCover` from ContentView regardless of lock state (safe since no vault data is exposed). SL prefix IDs in pbxproj. Requires AASA file + landing page on vaultaire.app for universal links to work (out of scope for iOS-only implementation).
- **VaultIndex creation**: NEVER use bare v1 init for new vaults — `loadIndex(with:)` auto-creates proper v3 with master key, blob descriptor, and correct version. Bare init creates a file that blocks auto-creation and has no master key, causing `storeFile` to throw.
- **Screen cloning discipline**: When replicating a flow (e.g., join vault pattern from onboarding), copy ALL behavior — validation, haptics, error messages, feedback UI, accessibility IDs. Partial clones create inconsistent UX and missing test coverage.
- **Pattern board normalization**: 3 categories — "create new" (full PatternValidator + feedback + strength), "confirm" (match error only), "enter existing" (minimal validation). All pattern screens documented in AGENTS.md with exact required behavior per category. NEVER modify one pattern screen without checking all others for consistency.
- **Mandatory Maestro rule**: Every visual/UI change requires corresponding Maestro test updates. Rule codified in `apps/ios/AGENTS.md` with checklist: new screens → new flows, new elements → accessibility IDs + assertions, changed text → updated assertions, changed navigation → updated flow sequences.
- **TestFlight pipeline**: Manual signing for Release configs (distribution cert + App Store profiles), automatic for Debug. ExportOptions.plist with `app-store-connect` + `destination: upload` for direct ASC upload. Sentry script phase must be AFTER Embed Foundation Extensions. Build script at `scripts/publish-testflight.sh`. First build: v1.0(1), ASC app ID `6758529311`, group "Internal Testers".
- **Import progress timing**: PHPicker pre-loaded all images before showing progress, creating visible lag. Fix: pass `PHPickerResult` directly, set `importProgress` immediately on main actor, process incrementally (load → compress → encrypt → store → update). Also applies to file importer — set progress before `Task.detached`, not inside it.
- **Drag-to-select in grids**: Use PreferenceKey to collect cell CGRects, simultaneousGesture with DragGesture, direction-based activation (`dx > dy * 0.5` rejects vertical scrolls). First touched cell determines mode (select vs deselect). Track `dragAffectedIds` to prevent re-toggling. Replace Button with `.onTapGesture` to avoid gesture conflicts. Haptic via `UISelectionFeedbackGenerator().selectionChanged()`.
- **TestFlight internal groups**: Internal groups with `hasAccessToAllBuilds: true` automatically receive all builds — `asc builds add-groups` fails with "Cannot add internal group to a build." Don't try to manually assign builds to internal groups.
- **Free tier import enforcement**: Limit checks at the + button are insufficient — must also cap imports inside `handleSelectedPhotos`/`handleImportedFiles` to remaining free slots, import those, then show paywall if truncated.
- **Vault isolation security**: `Task.detached` with captured value-type keys is a security hazard — keys survive vault lock. Store task handles (`activeImportTask`), cancel on any vault key change (not just nil), and check `Task.isCancelled` after every async operation in import loops.
- **Batch storage operations**: Individual `deleteFile` calls do N load/save cycles (N crypto operations). Batch method with single load/save and blob-grouped file handle reuse provides 300x improvement.
- **Camera preview pattern**: `AVCaptureVideoPreviewLayer` as `override class var layerClass` is the correct pattern — creates the preview layer as the view's backing layer, auto-resizing without manual frame management. Sublayer approach has zero-frame issues.
- **ShareExtension version sync**: Always use `$(CURRENT_PROJECT_VERSION)` and `$(MARKETING_VERSION)` build setting variables in extension Info.plists — hardcoded values drift when main app bumps versions.
- **Structured logging pattern**: Subsystem `"app.vaultaire.ios"`, category matches class/feature name. Classes/actors use `private static let logger = Logger(...)` accessed via `Self.logger`. Structs/enums/views use file-level `private let xyzLogger = Logger(...)`. For `@MainActor` classes with `nonisolated` methods, MUST use file-level logger to avoid actor isolation issues. Log levels: `.trace()` for sensitive data (never log content), `.debug()` for routine ops, `.info()` for notable events, `.warning()` for non-fatal issues, `.error()` for failures. Privacy: `\(value, privacy: .public)` for non-sensitive interpolation.
